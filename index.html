<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>âœ¨èµ«èˆå…»æˆÂ·è½¯èŒæ˜Ÿçƒâœ¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
  <!-- èŒQå­—ä½“ç»„åˆ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Patrick+Hand&family=Gaegu:wght@300;400;700&family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-100-M/fonts/zkkl2016.css">
  <link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-100-M/font-awesome/4.7.0/css/font-awesome.min.css">
  <style>
    /* ================= å…¨å±€å˜é‡ & è¶…è½¯èŒåŠ¨ç”» ================= */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "ç«™é…·å¿«ä¹ä½“2016", "M PLUS Rounded 1c", "Fredoka One", "Patrick Hand", "Gaegu", "å¹¼åœ†", "Comic Sans MS", cursive;
      letter-spacing: 0.5px;
    }
    html, body {
      height: 100%;
      overflow: hidden;
    }
    :root {
      --main-color: #ff85c0;
      --main-light: #ffb3d9;
      --main-dark: #e85ba0;
      --second-color: #a975ff;
      --bg-light: linear-gradient(165deg, #ffe9f4 0%, #f0e6ff 100%);
      --bg-night: linear-gradient(165deg, #2d1b2c 0%, #1a1435 100%);
      --card-bg: rgba(255, 250, 250, 0.95);
      --card-bg-night: rgba(45, 30, 45, 0.95);
      --text-main: #442233;
      --text-secondary: #775566;
      --text-night: #ffe6f0;
      --text-night-secondary: #ccb3c2;
      --rare-normal: #9a8c98;
      --rare-rare: #4d9fff;
      --rare-epic: #c77dff;
      --rare-legend: #ff9f4b;
      --radius-md: 20px;
      --radius-lg: 28px;
      --radius-xl: 40px;
      --radius-full: 999px;
      --shadow-soft: 0 15px 30px rgba(255, 120, 180, 0.2), 0 5px 15px rgba(0,0,0,0.05);
      --shadow-glow: 0 0 20px #ffb3d9, 0 8px 25px rgba(255, 120, 200, 0.4);
      --transition: all 0.25s cubic-bezier(0.2, 0.9, 0.3, 1.2);
    }
    body {
      background: var(--bg-light);
      background-size: cover;
      background-position: center;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 8px;
      transition: var(--transition);
    }
    body.night {
      background: #180e20 !important;
      color: #f0c0e0;
    }
    body.night .game-box {
      background: rgba(35, 20, 35, 0.97);
      border-color: #8a5a88;
      box-shadow: 0 15px 35px rgba(0,0,0,0.7), inset 0 0 0 3px #8a5a88;
    }
    body.night .top-bar {
      background: rgba(70, 35, 65, 0.9);
    }
    body.night .main-btn {
      background: #5a2a55;
      border-color: #b27aae;
      color: #ffd0f5;
      box-shadow: 0 6px 0 #7a3a75;
    }
    body.night .mini-btn {
      background: #4a3248;
      border-color: #9a6a98;
      color: #ffc0e8;
      box-shadow: 0 5px 0 #6a3a65;
    }
    body.night .attr-item {
      background: #4a2a45;
      border-color: #aa7aa8;
      box-shadow: 0 6px 0 #7a3a70;
    }
    body.night .attr-num {
      color: #ffb0e0;
    }
    body.night .fixed-chat,
    body.night .play-time,
    body.night .now-playing {
      color: #ffc0e8;
      background: rgba(90, 40, 75, 0.8);
    }
    body.night .coin {
      background: #6a2e55;
      color: #ffe680;
    }
    body.night .modal-box {
      background: #351d32;
      border-color: #aa7aa8;
    }
    body.night .modal-head {
      background: #7a3a70;
    }
    body.night .calendar-day {
      background: #5a3a55;
      color: #ffc0f0;
    }
    body.night .shop-item,
    body.night .item-row {
      background: #4f2a4a;
      border-color: #aa7aa8;
      color: #ffe0f5;
    }
    body.night .empty-msg {
      color: #b890b0;
    }

    body.modal-open {
      overflow: hidden;
      position: fixed;
      width: 100%;
      height: 100%;
    }

    /* å…¨å±ç‰¹æ•ˆå±‚ */
    .fullscreen-effect {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
      font-size: 90px;
      color: rgba(255,255,255,0.9);
      text-shadow: 0 0 30px gold, 0 0 60px orange;
      animation: effectFlash 1.2s ease-out forwards;
    }
    .fullscreen-effect.epic {
      background: radial-gradient(circle, rgba(200,0,255,0.4) 0%, transparent 75%);
      backdrop-filter: blur(4px);
    }
    .fullscreen-effect.legend {
      background: radial-gradient(circle, rgba(255,215,0,0.6) 0%, rgba(255,0,200,0.4) 50%, transparent 85%);
      backdrop-filter: blur(6px);
      animation: effectSpin 1.2s ease-out;
    }
    @keyframes effectFlash {
      0% { opacity: 0; transform: scale(0.3) rotate(-10deg); }
      50% { opacity: 1; transform: scale(1.2) rotate(3deg); }
      100% { opacity: 0; transform: scale(1.8) rotate(0deg); }
    }
    @keyframes effectSpin {
      0% { opacity: 0; transform: rotate(0deg) scale(0.3); }
      50% { opacity: 1; transform: rotate(180deg) scale(1.2); }
      100% { opacity: 0; transform: rotate(360deg) scale(1.8); }
    }

    /* åŠ¨ç”»åŒº */
    @keyframes glowPulse {
      0% { box-shadow: 0 0 10px #ffb3d9, 0 0 20px #ffb3d9; }
      50% { box-shadow: 0 0 22px #ff7bb5, 0 0 40px #ff7bb5; }
      100% { box-shadow: 0 0 10px #ffb3d9, 0 0 20px #ffb3d9; }
    }
    @keyframes floatUp {
      0% { bottom: 20px; opacity: 1; transform: translateX(-50%) scale(1); }
      100% { bottom: 140%; opacity: 0; transform: translateX(-50%) scale(0.6); }
    }
    @keyframes coinSpin {
      0% { transform: rotateY(0); }
      50% { transform: rotateY(180deg); }
      100% { transform: rotateY(0); }
    }
    @keyframes shake {
      0%,100% { transform: translateX(0); }
      20% { transform: translateX(-4px) rotate(-1deg); }
      40% { transform: translateX(4px) rotate(1deg); }
      60% { transform: translateX(-2px) rotate(-0.5deg); }
      80% { transform: translateX(2px) rotate(0.5deg); }
    }
    @keyframes bounce {
      0%,100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    @keyframes wobble {
      0%,100% { transform: rotate(0deg); }
      25% { transform: rotate(1.5deg); }
      75% { transform: rotate(-1.5deg); }
    }

    /* ç‰©å“é£å…¥åŠ¨ç”» */
    @keyframes flyToAvatar {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
      100% {
        transform: translate(var(--fly-x), var(--fly-y)) scale(0.2);
        opacity: 0;
      }
    }
    .fly-item {
      position: fixed;
      z-index: 10000;
      font-size: 30px;
      filter: drop-shadow(0 0 10px gold);
      pointer-events: none;
      animation: flyToAvatar 0.6s ease-out forwards;
    }

    /* ================= ä¸»é¢æ¿ ================= */
    .game-box {
      width: 100%;
      max-width: 520px;
      background: var(--card-bg);
      backdrop-filter: blur(16px);
      border-radius: var(--radius-xl);
      padding: 12px 16px;
      box-shadow: var(--shadow-soft), inset 0 0 0 3px rgba(255,255,255,0.8);
      border: 3px solid white;
      transition: var(--transition);
      height: 98vh;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--main-light) #ffe9f4;
    }
    .game-box::-webkit-scrollbar { width: 6px; }
    .game-box::-webkit-scrollbar-thumb { background: var(--main-light); border-radius: 30px; border: 2px solid white; }

    /* é¡¶éƒ¨æ  */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: -12px -16px 8px -16px;
      padding: 8px 16px;
      background: rgba(255, 220, 240, 0.85);
      backdrop-filter: blur(16px);
      border-radius: 0 0 var(--radius-lg) var(--radius-lg);
      box-shadow: 0 5px 15px rgba(255,150,200,0.25);
    }
    .play-time {
      background: linear-gradient(145deg, #ffb6d9, #ff8ec7);
      color: white;
      padding: 4px 12px;
      border-radius: var(--radius-full);
      font-size: 12px;
      font-weight: bold;
      box-shadow: 0 3px 0 #d46a9e;
    }
    .coin {
      background: #fff2dd;
      color: #b45f2b;
      padding: 4px 12px;
      border-radius: var(--radius-full);
      font-size: 14px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 4px;
      box-shadow: inset 0 -2px 0 #ffc285, 0 3px 6px rgba(0,0,0,0.05);
    }
    .coin.jump { animation: coinSpin 0.5s ease; }

    /* å•†åº—ä»“åº“è¡Œ */
    .shop-row {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-bottom: 6px;
    }
    .shop-row .mini-btn {
      padding: 4px 12px;
      font-size: 13px;
    }

    /* è§’è‰²å */
    .character-name {
      text-align: center;
      font-size: 24px;
      font-weight: 800;
      color: #b34180;
      text-shadow: 0 3px 6px #ffb3d9, 0 0 10px white;
      margin-bottom: 4px;
      letter-spacing: 1px;
      transform: rotate(-0.3deg);
      line-height: 1.2;
      animation: wobble 4s infinite ease-in-out;
    }
    .character-name small {
      font-size: 16px;
      color: #a64d79;
      text-shadow: 0 2px 4px #ff99cc;
    }
    body.night .character-name {
      color: #ffb0d0;
      text-shadow: 0 3px 8px #8a4a78;
    }

    /* å¤´åƒåŒºåŸŸ - ä½œä¸ºæ³¢çº¹å®¹å™¨ */
    .avatar-wrap {
      display: flex;
      justify-content: center;
      margin: 4px 0 4px;
      position: relative;
      min-height: 140px; /* ä¸ºæ³¢çº¹ç•™å‡ºç©ºé—´ */
    }
    .avatar {
      width: 130px;
      height: 130px;
      border-radius: 50%;
      overflow: hidden;
      cursor: pointer;
      position: relative;
      box-shadow: var(--shadow-glow);
      transition: 0.2s;
      z-index: 3; /* é«˜äºæ³¢çº¹ */
      animation: bounce 4s infinite ease-in-out;
    }
    .avatar:hover {
      transform: scale(1.03);
      animation: none;
    }
    .avatar img { width: 100%; height: 100%; object-fit: cover; }
    .avatar-ripple {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(1);
      width: 130px;
      height: 130px;
      border-radius: 50%;
      pointer-events: none;
      z-index: 2;
      background: radial-gradient(circle, rgba(255,200,235,0.9) 0%, rgba(255,140,200,0) 75%);
      filter: blur(8px);
      opacity: 0.6;
      transition: opacity 0.2s;
      animation: glowPulse 3s infinite ease-in-out;
    }
    /* è¡¨æƒ…åŒ…ç´§è´´å¤´åƒå³ä¸Šæ–¹ */
    .mood-emoji {
      position: absolute;
      top: 0;
      right: 0;
      font-size: 40px;
      filter: drop-shadow(0 4px 6px #ff99cc);
      z-index: 4;
      pointer-events: none;
      transition: 0.2s;
    }
    /* æ°´çº¹æ¡ - æ”¾åœ¨å¤´åƒåé¢ */
    .wave-bar {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      height: 80px; /* é«˜åº¦å¢å¤§ï¼Œä»¥ä¾¿éƒ¨åˆ†è¢«å¤´åƒé®æŒ¡ */
      z-index: 1;
      pointer-events: none;
    }
    .wave-bar canvas {
      width: 100%;
      height: 100%;
      border-radius: 50px;
      background: transparent; /* èƒŒæ™¯é€æ˜ï¼Œè®©æ³¢çº¹ç›´æ¥æ˜¾ç¤º */
    }

    /* å›ºå®šå¯¹è¯ */
    .fixed-chat {
      text-align: center;
      min-height: 26px;
      font-size: 14px;
      color: var(--main-dark);
      font-weight: bold;
      margin: 2px auto 6px;
      text-shadow: 0 2px 4px white;
      background: rgba(255,255,255,0.4);
      border-radius: 50px;
      padding: 4px 14px;
      display: inline-block;
      width: fit-content;
      backdrop-filter: blur(4px);
      z-index: 5;
      position: relative;
    }
    .float-chat-container {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    }
    .float-chat {
      position: absolute;
      left: 50%;
      bottom: 25px;
      transform: translateX(-50%);
      background: #fff0f7;
      color: #a64d79;
      padding: 6px 16px;
      border-radius: 40px 40px 40px 8px;
      box-shadow: 0 5px 16px #ffb3d9;
      border: 2px solid white;
      font-size: 14px;
      animation: floatUp 4s forwards;
      white-space: nowrap;
      font-weight: bold;
    }

    /* å±æ€§é¢æ¿ */
    .attr-row {
      display: grid;
      grid-template-columns: repeat(5,1fr);
      gap: 4px;
      margin: 8px 0;
    }
    .attr-item {
      background: rgba(255,220,240,0.65);
      border-radius: var(--radius-md);
      padding: 6px 2px;
      text-align: center;
      border: 2px solid white;
      box-shadow: 0 4px 0 var(--main-light);
      transform: translateY(-2px);
      transition: var(--transition);
      backdrop-filter: blur(4px);
      position: relative;
      overflow: hidden;
    }
    .attr-item::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
      transition: left 0.5s;
    }
    .attr-item:hover::after {
      left: 100%;
    }
    .attr-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 0 var(--main-light);
    }
    .attr-item:active {
      transform: translateY(1px);
      box-shadow: 0 2px 0 var(--main-light);
    }
    .attr-icon { font-size: 18px; color: var(--main-color); margin-bottom: 2px; }
    .attr-num {
      font-size: 18px;
      font-weight: 800;
      color: #b34180;
      line-height: 1.1;
    }
    .attr-num.red { color: #ff3b6f; animation: shake 0.3s; }
    .attr-progress-wrap {
      height: 5px;
      background: #ffe2f0;
      border-radius: 20px;
      margin: 4px 4px 2px;
      overflow: hidden;
      border: 1px solid white;
    }
    .attr-progress {
      height: 100%;
      background: linear-gradient(90deg, var(--main-color), var(--second-color));
      border-radius: 20px;
      transition: width 0.3s ease;
    }

    /* ç»éªŒæ¡ + ç­‰çº§ */
    .exp-section {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 6px 0 10px;
      background: rgba(255,255,255,0.4);
      border-radius: 50px;
      padding: 4px 10px;
      backdrop-filter: blur(4px);
    }
    .exp-label {
      font-size: 16px;
      font-weight: 800;
      color: #a64d79;
      white-space: nowrap;
      text-shadow: 0 2px 4px white;
    }
    .exp-bar-wrap {
      flex: 1;
      height: 16px;
      background: #ffe2f0;
      border-radius: 40px;
      border: 2px solid white;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    .exp-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #ffb3d9, #c480ff, #ffb3d9);
      background-size: 200% 100%;
      border-radius: 40px;
      transition: width 0.25s;
      box-shadow: 0 0 10px #ff99cc;
      animation: shimmer 2.2s infinite linear;
    }
    @keyframes shimmer {
      0% { background-position: 0% 0; }
      100% { background-position: 200% 0; }
    }
    .exp-text {
      font-size: 12px;
      color: #832b5c;
      margin-left: 4px;
      font-weight: bold;
    }
    body.night .exp-section {
      background: rgba(70,35,60,0.5);
    }
    body.night .exp-label,
    body.night .exp-text {
      color: #ffc0e8;
    }
    body.night .exp-bar-wrap {
      background: #6a3a60;
      border-color: #b27aa8;
    }

    /* ä¸»æŒ‰é’®åŒº - ä¸¤è¡Œ */
    .main-btns {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin: 6px 0 8px;
    }
    .btn-row {
      display: flex;
      justify-content: center;
      gap: 8px;
    }
    .main-btn {
      background: linear-gradient(145deg, white, #fff5fa);
      border: 3px solid var(--main-light);
      border-radius: 60px;
      padding: 8px 0;
      font-size: 16px;
      font-weight: 800;
      color: #b34180;
      box-shadow: 0 5px 0 var(--main-light), 0 3px 8px rgba(255,120,180,0.3);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      flex: 0 1 auto;
      min-width: 90px;
    }
    .main-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 7px 0 var(--main-light), 0 5px 12px rgba(255,120,180,0.4);
    }
    .main-btn:active {
      transform: translateY(3px);
      box-shadow: 0 2px 0 var(--main-light);
    }
    .main-btn:disabled {
      opacity: 0.5;
      transform: translateY(2px);
      box-shadow: 0 3px 0 #b090a0;
      pointer-events: none;
      filter: grayscale(0.4);
    }

    /* åŠŸèƒ½å°æŒ‰é’® - åˆ†ä¸ºä¸¤è¡Œï¼Œè‰²ç³»å’Œå¤œé—´æ”¾åœ¨åŒä¸€è¡Œ */
    .func-row {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin: 4px 0;
    }
    .mini-btn {
      background: linear-gradient(145deg, #ffd9ec, #ffe4f0);
      border: 2px solid white;
      border-radius: 50px;
      padding: 4px 10px;
      font-size: 12px;
      color: #a64d79;
      font-weight: bold;
      box-shadow: 0 3px 0 #ff9ec7, 0 3px 6px rgba(255,150,200,0.2);
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .mini-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 0 #ff9ec7, 0 4px 8px rgba(255,150,200,0.3);
    }
    .mini-btn:active {
      transform: translateY(2px);
      box-shadow: 0 1px 0 #ff9ec7;
    }

    /* åº•éƒ¨æ’­æ”¾å™¨ */
    .bottom-player {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255,220,240,0.85);
      backdrop-filter: blur(16px);
      margin: 8px -16px -12px -16px;
      padding: 8px 16px;
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      border-top: 3px solid white;
    }
    .now-playing {
      flex: 2;
      font-size: 12px;
      background: rgba(255,255,255,0.6);
      padding: 4px 10px;
      border-radius: 50px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #832b5c;
      font-weight: bold;
      border: 2px solid white;
    }
    .ctrl-group { display: flex; gap: 4px; align-items: center; }
    .ctrl-btn {
      background: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      font-size: 18px;
      color: var(--main-color);
      box-shadow: 0 3px 0 var(--main-light), 0 2px 5px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .ctrl-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 0 var(--main-light);
    }
    .ctrl-btn:active { transform: translateY(2px); box-shadow: 0 1px 0 var(--main-light); }

    /* éšè—ä¸Šä¼ æ§ä»¶ */
    .upload-hide { display: none; }

    /* å¼¹çª—è®¾è®¡ */
    .modal {
      position: fixed;
      top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(6px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-box {
      background: #fff5fb;
      border-radius: 60px 60px 40px 40px;
      max-width: 480px;
      width: 94%;
      max-height: 82vh;
      overflow: hidden;
      box-shadow: 0 30px 50px #ff80b5, 0 10px 25px rgba(0,0,0,0.2);
      border: 5px solid white;
      animation: pop 0.3s;
    }
    @keyframes pop {
      0%{transform:scale(0.7) rotate(-2deg); opacity:0;}
      80%{transform:scale(1.01) rotate(1deg);}
      100%{transform:scale(1) rotate(0); opacity:1;}
    }
    .modal-head {
      background: linear-gradient(145deg, var(--main-light), var(--main-color));
      padding: 14px;
      font-size: 20px;
      font-weight: 800;
      color: white;
      text-align: center;
      position: relative;
      text-shadow: 0 2px 4px #b34180;
    }
    .modal-close {
      position: absolute;
      right: 14px;
      top: 10px;
      background: none;
      border: none;
      font-size: 32px;
      color: white;
      cursor: pointer;
      transition: 0.2s;
    }
    .modal-close:hover { transform: scale(1.15) rotate(5deg); }
    .modal-body { padding: 14px; overflow-y: auto; max-height: 62vh; }

    /* ç­¾åˆ°æ—¥å† */
    .calendar {
      display: grid;
      grid-template-columns: repeat(7,1fr);
      gap: 4px;
      text-align: center;
      margin: 14px 0;
    }
    .calendar-day {
      background: #ffe7f2;
      border-radius: 30px;
      padding: 6px 0;
      font-weight: bold;
      color: #b34180;
      border: 2px solid white;
      position: relative;
      transition: 0.15s;
      font-size: 13px;
    }
    .calendar-day:hover {
      transform: scale(1.04);
      background: #ffd9ec;
      box-shadow: 0 3px 0 #ff9ec7;
    }
    .calendar-day.signed { background: #b5e6b5; color: #1f6d1f; }
    .calendar-day.signed::after { content: "âœ”ï¸"; position: absolute; bottom: -4px; right: -4px; font-size: 14px; }
    .calendar-day.lucky { border: 4px solid #ffd966; box-shadow: 0 0 0 2px #ffb347; }
    .calendar-day.today { font-weight: 900; background: #ffd0e8; border: 3px solid #ff3388; }

    /* å•†åº—ç½‘æ ¼ */
    .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .shop-item {
      background: white;
      border-radius: 30px;
      padding: 10px;
      border: 3px solid var(--main-light);
      box-shadow: 0 4px 0 var(--main-light);
      color: #2d1b2c; 
      font-weight: 600;
      font-size: 12px;
      transition: var(--transition);
    }
    .shop-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 0 var(--main-light);
    }
    .shop-item.locked { opacity: 0.6; filter: grayscale(0.5); pointer-events: none; }
    .rare-tag {
      font-size: 10px;
      background: #aaa;
      color: white;
      padding: 2px 6px;
      border-radius: 30px;
      display: inline-block;
      margin-right: 4px;
    }
    .rare-1 .rare-tag { background: #4d9fff; }
    .rare-2 .rare-tag { background: #c77dff; }
    .rare-3 .rare-tag { background: #ff9f4b; }
    .unlock-condition {
      font-size: 10px;
      color: #888;
      margin-top: 4px;
    }

    /* ä»“åº“/åˆ—è¡¨æ ·å¼ */
    .item-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      border-radius: 50px;
      padding: 8px 12px;
      margin: 6px 0;
      border: 2px solid var(--main-light);
      color: #2d1b2c;
      font-size: 13px;
      transition: var(--transition);
    }
    .item-row:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 0 var(--main-light);
    }
    .item-info { display: flex; flex-direction: column; gap: 2px; }
    .item-effects { font-size: 11px; color: #555; }
    .empty-msg { text-align: center; padding: 20px; color: #a77a95; font-size: 16px; }

    /* å¤´åƒå†å²é¢„è§ˆ */
    .media-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
    }
    .bg-thumb {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 20px;
      border: 3px solid white;
      cursor: pointer;
      transition: 0.15s;
    }
    .bg-thumb:hover { transform: scale(1.08) rotate(2deg); border-color: #ff3388; }
    .bg-thumb.active { border-color: #ff3388; transform: scale(1.05); }

    /* è‰²ç³»é€‰æ‹©å™¨ */
    .color-option {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      display: inline-block;
      margin: 6px;
      border: 3px solid white;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: 0.15s;
    }
    .color-option:hover { transform: scale(1.12) rotate(6deg); }
  </style>
</head>
<body>
  <!-- å…¨å±ç‰¹æ•ˆå±‚ -->
  <div id="fullscreenEffect" class="fullscreen-effect"></div>

<div class="game-box">
  <!-- é¡¶éƒ¨æ  -->
  <div class="top-bar">
    <div class="play-time" id="playTime">é™ªä¼´æ—¶é—´ 00:00:00</div>
    <div class="coin" id="coinView"><span>ğŸ’°</span> <span id="coinAmount">0.0</span></div>
  </div>

  <!-- å•†åº—ä»“åº“è¡Œ -->
  <div class="shop-row">
    <button class="mini-btn" onclick="openShop()"><span>ğŸ›’</span> å•†åº—</button>
    <button class="mini-btn" onclick="openStorage()"><span>ğŸ“¦</span> ä»“åº“</button>
  </div>

  <!-- è§’è‰²å -->
  <div class="character-name">
    èµ«èˆ <small>Hera</small>
  </div>

  <!-- å¤´åƒåŒº (åŒ…å«æ³¢çº¹) -->
  <div class="avatar-wrap">
    <!-- æ°´çº¹æ¡ - åœ¨å¤´åƒåé¢ -->
    <div class="wave-bar">
      <canvas id="waveCanvas" width="500" height="80"></canvas>
    </div>
    <div class="avatar" id="avatarBox" title="ç‚¹æˆ‘èµšğŸ’°0.1">
      <img id="avatarImg" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZmZjY2U1Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMjAiIGZpbGw9IiNiYjU1OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7H6Qp9PC90ZXh0Pjwvc3ZnPg==" alt="èµ«èˆ">
      <div id="floatChatContainer" class="float-chat-container"></div>
    </div>
    <!-- åŠ¨æ€å…‰æ™•å±‚ -->
    <div id="avatarRipple" class="avatar-ripple"></div>
    <div id="moodEmoji" class="mood-emoji">ğŸ˜Š</div>
  </div>

  <!-- å›ºå®šå¯¹è¯ -->
  <div class="fixed-chat" id="log">âœ¨ æˆ³æˆ³å¤´åƒæœ‰æƒŠå–œ âœ¨</div>

  <!-- å±æ€§é¢æ¿ -->
  <div class="attr-row">
    <div class="attr-item"><div class="attr-icon">ğŸ˜Š</div><div class="attr-num" id="mood">0</div><div class="attr-progress-wrap"><div class="attr-progress" id="moodProgress" style="width:0%"></div></div></div>
    <div class="attr-item"><div class="attr-icon">âš¡</div><div class="attr-num" id="energy">0</div><div class="attr-progress-wrap"><div class="attr-progress" id="energyProgress" style="width:0%"></div></div></div>
    <div class="attr-item"><div class="attr-icon">ğŸ°</div><div class="attr-num" id="full">0</div><div class="attr-progress-wrap"><div class="attr-progress" id="fullProgress" style="width:0%"></div></div></div>
    <div class="attr-item"><div class="attr-icon">â¤ï¸</div><div class="attr-num" id="health">0</div><div class="attr-progress-wrap"><div class="attr-progress" id="healthProgress" style="width:0%"></div></div></div>
    <div class="attr-item"><div class="attr-icon">ğŸ’–</div><div class="attr-num" id="love">0</div><div class="attr-progress-wrap"><div class="attr-progress" id="loveProgress" style="width:0%"></div></div></div>
  </div>

  <!-- ç»éªŒæ¡ + ç­‰çº§ -->
  <div class="exp-section">
    <span class="exp-label">Lv.<span id="levelDisplay">1</span></span>
    <div class="exp-bar-wrap">
      <div class="exp-bar-fill" id="expBar" style="width:0%"></div>
    </div>
    <span class="exp-text" id="expText">0/100</span>
  </div>

  <!-- ä¸»æŒ‰é’®åŒº - ä¸¤è¡Œ -->
  <div class="main-btns">
    <div class="btn-row">
      <button class="main-btn" id="chatBtn" onclick="chatTalk()"><span>ğŸ’¬</span> èŠå¤©</button>
      <button class="main-btn" onclick="openEat()"><span>ğŸª</span> é›¶é£Ÿ</button>
      <button class="main-btn" onclick="openPlay()"><span>ğŸ®</span> ç©è€</button>
    </div>
    <div class="btn-row">
      <button class="main-btn" id="restBtn" onclick="doRest()"><span>ğŸ˜´</span> ä¼‘æ¯</button>
      <button class="main-btn" id="cleanBtn" onclick="doClean()"><span>ğŸ§¹</span> æ¸…æ´</button>
    </div>
  </div>

  <!-- åŠŸèƒ½å°æŒ‰é’® - åˆ†ä¸ºä¸¤è¡Œï¼šç¬¬ä¸€è¡Œå…¶ä»–åŠŸèƒ½ï¼Œç¬¬äºŒè¡Œè‰²ç³»å’Œå¤œé—´ -->
  <div class="func-row">
    <button class="mini-btn" onclick="openAvatarManager()"><span>ğŸ“¸</span> å¤´åƒ</button>
    <button class="mini-btn" onclick="openSignModal()"><span>ğŸ“…</span> ç­¾åˆ°</button>
    <button class="mini-btn" onclick="openMusicManager()"><span>ğŸµ</span> éŸ³ä¹åº“</button>
  </div>
  <div class="func-row">
    <button class="mini-btn" onclick="openColorModal()"><span>ğŸ¨</span> è‰²ç³»</button>
    <button class="mini-btn" onclick="toggleTheme()"><span>ğŸŒ™</span> å¤œé—´</button>
  </div>

  <!-- åº•éƒ¨æ’­æ”¾å™¨ -->
  <div class="bottom-player">
    <div class="now-playing" id="nowPlaying" title="å½“å‰æ­Œæ›²">ğŸµ æœªæ’­æ”¾</div>
    <div class="ctrl-group">
      <button class="ctrl-btn" onclick="prevMusic()" title="ä¸Šä¸€é¦–"><span>â®ï¸</span></button>
      <button class="ctrl-btn" id="musicPlayPause" onclick="toggleMusic()" title="æ’­æ”¾/æš‚åœ"><span>â–¶ï¸</span></button>
      <button class="ctrl-btn" onclick="nextMusic()" title="ä¸‹ä¸€é¦–"><span>â­ï¸</span></button>
    </div>
  </div>

  <!-- éšè—ä¸Šä¼ æ§ä»¶ -->
  <input type="file" id="avatarInput" accept="image/jpeg,image/png,image/webp,image/gif" class="upload-hide">
  <input type="file" id="musicInput" accept="audio/*" multiple class="upload-hide">
</div>

<!-- ========== å¼¹çª—åŒº ========== -->
<!-- å•†åº—å¼¹çª— -->
<div class="modal" id="shopModal"><div class="modal-box"><div class="modal-head">ğŸ­ èŒç‰©å•†åº— <button class="modal-close" onclick="closeModal('shopModal')">Ã—</button></div><div class="modal-body"><div class="shop-tabs" style="display:flex;gap:4px;margin-bottom:12px"><button class="mini-btn" onclick="showTab(0)">ğŸ¬é›¶é£Ÿ</button><button class="mini-btn" onclick="showTab(1)">ğŸ§¸ç©å…·</button><button class="mini-btn" onclick="showTab(2)">ğŸšä¸»é£Ÿ</button><button class="mini-btn" onclick="showTab(3)">ğŸ§´æ—¥ç”¨å“</button></div><div id="shopBody" class="shop-grid"></div></div></div></div>

<!-- ä»“åº“å¼¹çª— -->
<div class="modal" id="storModal"><div class="modal-box"><div class="modal-head">ğŸ“¦ å°ä»“åº“ <button class="modal-close" onclick="closeModal('storModal')">Ã—</button></div><div class="modal-body" id="storBody"></div></div></div>

<!-- é›¶é£Ÿå¼¹çª— -->
<div class="modal" id="eatModal"><div class="modal-box"><div class="modal-head">ğŸ° æŠ•å–‚æ—¶é—´ <button class="modal-close" onclick="closeModal('eatModal')">Ã—</button></div><div class="modal-body" id="eatBody"></div></div></div>

<!-- ç©è€å¼¹çª— -->
<div class="modal" id="playModal"><div class="modal-box"><div class="modal-head">ğŸª ä¸€èµ·ç©å§ <button class="modal-close" onclick="closeModal('playModal')">Ã—</button></div><div class="modal-body" id="playBody"></div></div></div>

<!-- ç­¾åˆ°å¼¹çª— -->
<div class="modal" id="signModal"><div class="modal-box"><div class="modal-head">ğŸ“† æ¯æ—¥ç­¾åˆ° <button class="modal-close" onclick="closeModal('signModal')">Ã—</button></div><div class="modal-body" id="signBody"></div></div></div>

<!-- éŸ³ä¹ç®¡ç†å¼¹çª— -->
<div class="modal" id="musicModal"><div class="modal-box"><div class="modal-head">ğŸµ éŸ³ä¹åº“ <button class="modal-close" onclick="closeModal('musicModal')">Ã—</button></div><div class="modal-body"><button class="mini-btn" onclick="addMusicFiles()" style="margin-bottom:12px">â• æ·»åŠ éŸ³ä¹</button><div id="musicList"></div></div></div></div>

<!-- å¤´åƒç®¡ç†å¼¹çª— -->
<div class="modal" id="avatarModal"><div class="modal-box"><div class="modal-head">ğŸ“¸ å¤´åƒæ¢è£… <button class="modal-close" onclick="closeModal('avatarModal')">Ã—</button></div><div class="modal-body"><button class="mini-btn" onclick="chooseAvatar()">ğŸ“¤ ä¸Šä¼ æ–°å¤´åƒ</button><div style="margin:12px 0; font-size:16px;">æœ€è¿‘5ä¸ªå¤´åƒ</div><div id="avatarHistoryList" class="media-grid"></div></div></div></div>

<!-- è‰²ç³»è®¾ç½®å¼¹çª— -->
<div class="modal" id="colorModal"><div class="modal-box"><div class="modal-head">ğŸ¨ ç‰ˆé¢è‰²ç³» <button class="modal-close" onclick="closeModal('colorModal')">Ã—</button></div><div class="modal-body"><div style="text-align:center;">
  <div class="color-option" style="background:#ff85c0;" onclick="setColorTheme('#ff85c0','#a975ff', 'æµªæ¼«ç²‰')"></div>
  <div class="color-option" style="background:#6a5acd;" onclick="setColorTheme('#6a5acd','#ffb6c1', 'æ¢¦å¹»ç´«')"></div>
  <div class="color-option" style="background:#20b2aa;" onclick="setColorTheme('#20b2aa','#ffdab9', 'æ¸…æ–°ç»¿')"></div>
  <div class="color-option" style="background:#ffa07a;" onclick="setColorTheme('#ffa07a','#dda0dd', 'æš–é˜³æ©™')"></div>
  <div class="color-option" style="background:#2c3e50;" onclick="setColorTheme('#2c3e50','#34495e', 'æ·±é‚ƒé»‘')"></div>
  <div class="color-option" style="background:#3498db;" onclick="setColorTheme('#3498db','#5dade2', 'æµ·æ´‹è“')"></div>
  <div style="margin-top:8px; font-size:14px;">ç‚¹å‡»è‰²å—åˆ‡æ¢ä¸»è‰²è°ƒ</div>
</div></div></div></div>

<script>
// ====================== å…¨å±€å·¥å…· ======================
const $ = id => document.getElementById(id);
const cap = (v, max, min = 0) => Math.max(min, Math.min(max, v));
const formatTime = ms => { let s = Math.floor(ms/1000); return `${Math.floor(s/3600).toString().padStart(2,'0')}:${Math.floor(s%3600/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; };
const rareText = ['æ™®é€š','ç¨€æœ‰','å²è¯—','ä¼ è¯´'];

// å¼¹çª—æ§åˆ¶
function openModal(id) { $(id).style.display='flex'; document.body.classList.add('modal-open'); }
function closeModal(id) { $(id).style.display='none'; document.body.classList.remove('modal-open'); }
document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', e => { if(e.target===m) closeModal(m.id); }));

// æ˜¾ç¤ºé£˜å±å¯¹è¯
function showLog(s) {
  $('log').innerText = s;
  let bubble = document.createElement('div');
  bubble.className = 'float-chat';
  bubble.innerText = s;
  $('floatChatContainer').appendChild(bubble);
  setTimeout(() => bubble.remove(), 4000);
}

// å…¨å±ç‰¹æ•ˆ
function showFullscreenEffect(rare) {
  let effectDiv = $('fullscreenEffect');
  effectDiv.className = 'fullscreen-effect';
  if (rare === 2) effectDiv.classList.add('epic');
  else if (rare === 3) effectDiv.classList.add('legend');
  effectDiv.style.display = 'flex';
  effectDiv.innerText = rare === 3 ? 'âœ¨âœ¨ä¼  è¯´âœ¨âœ¨' : 'ğŸŒˆå²è¯—ğŸŒˆ';
  setTimeout(() => { effectDiv.style.display = 'none'; }, 1200);
}

// ====================== é™ªä¼´æ—¶é—´ ======================
let startTime = parseInt(localStorage.startTime || Date.now());
function updatePlayTime() { $('playTime').innerText = 'é™ªä¼´æ—¶é—´ ' + formatTime(Date.now() - startTime); }
setInterval(updatePlayTime, 1000);

// ====================== å¤´åƒå†å² ======================
let avatarHistory = JSON.parse(localStorage.avatarHistory || '[]');
function saveAvatarHistory() {
  localStorage.avatarHistory = JSON.stringify(avatarHistory);
  renderAvatarHistory();
}
function addAvatarToHistory(url) {
  avatarHistory = avatarHistory.filter(u => u !== url);
  avatarHistory.unshift(url);
  if (avatarHistory.length > 5) avatarHistory.pop();
  saveAvatarHistory();
}
function renderAvatarHistory() {
  let html = '';
  avatarHistory.forEach((url, i) => {
    html += `<div style="position:relative; display:inline-block; margin:4px;"><img src="${url}" class="bg-thumb" onclick="setAvatarFromHistory('${url}')"><button class="mini-btn" style="position:absolute; top:-8px; right:-8px; padding:2px 6px;" onclick="removeAvatarHistory(${i})">âœ–</button></div>`;
  });
  if ($('avatarHistoryList')) $('avatarHistoryList').innerHTML = html || '<div class="empty-msg">æš‚æ— å†å²å¤´åƒ</div>';
}
function setAvatarFromHistory(url) {
  $('avatarImg').src = url;
  localStorage.avatar = url;
  addAvatarToHistory(url);
  showLog('å¤´åƒæ¢å¥½å•¦ âœ¨');
  closeModal('avatarModal');
}
function removeAvatarHistory(i) {
  avatarHistory.splice(i,1);
  saveAvatarHistory();
}
function openAvatarManager() {
  renderAvatarHistory();
  openModal('avatarModal');
}
function chooseAvatar() {
  $('avatarInput').onchange = async e => {
    let file = e.target.files[0];
    if (!file) return;
    if (file.size > 15*1024*1024) { showLog('å›¾ç‰‡ä¸èƒ½è¶…è¿‡15MB'); return; }
    let reader = new FileReader();
    reader.onload = ev => {
      let dataURL = ev.target.result;
      $('avatarImg').src = dataURL;
      localStorage.avatar = dataURL;
      addAvatarToHistory(dataURL);
      showLog('æ–°å¤´åƒæ¢ä¸Šå•¦ âœ¨');
      closeModal('avatarModal');
    };
    reader.readAsDataURL(file);
  };
  $('avatarInput').click();
}

// ====================== éŸ³ä¹ç³»ç»Ÿ + æ¡çŠ¶æ³¢çº¹ + åŠ¨æ€å¤´åƒå…‰æ™• ======================
let musicList = JSON.parse(localStorage.musicList || '[]');
let currentMusicIndex = parseInt(localStorage.currentMusicIndex || '0');
let bgm = new Audio(); bgm.volume = 0.6; bgm.loop = false;
let audioCtx, analyser, source, canvasCtx;
let rippleDiv = $('avatarRipple');

function initAudioVisualizer() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 128; // ä¿æŒè¶³å¤Ÿæ¡æ•°
    source = audioCtx.createMediaElementSource(bgm);
    source.connect(analyser);
    analyser.connect(audioCtx.destination);
    canvasCtx = $('waveCanvas').getContext('2d');
    drawWaveAndRipple();
  }
}
function drawWaveAndRipple() {
  if (!analyser) return;
  const bufferLength = analyser.frequencyBinCount;
  const dataArray = new Uint8Array(bufferLength);
  const draw = () => {
    if (!bgm.paused && audioCtx && audioCtx.state === 'running') {
      analyser.getByteFrequencyData(dataArray);
    } else {
      dataArray.fill(0);
    }
    const canvas = $('waveCanvas');
    const width = canvas.width;
    const height = canvas.height;
    canvasCtx.clearRect(0, 0, width, height);

    // ç»˜åˆ¶æ¡çŠ¶æ¸å˜ï¼Œä¸Šä¸‹å¹…åº¦æ›´å¤§
    const barWidth = (width / bufferLength) * 2.5;
    let x = 0;
    // åˆ›å»ºæ¸å˜
    const gradient = canvasCtx.createLinearGradient(0, 0, width, 0);
    gradient.addColorStop(0, '#ff99cc');
    gradient.addColorStop(0.5, '#a975ff');
    gradient.addColorStop(1, '#ff99cc');

    for (let i = 0; i < bufferLength; i++) {
      // æ”¾å¤§å¹…åº¦ï¼šæœ€å¤§å€¼å¯è¾¾åˆ°é«˜åº¦90%
      let barHeight = (dataArray[i] / 255) * height * 0.9;
      canvasCtx.fillStyle = gradient;
      canvasCtx.fillRect(x, height - barHeight, barWidth - 1, barHeight);
      x += barWidth;
    }

    // è®¡ç®—å¹³å‡éŸ³é‡ç”¨äºå¤´åƒå…‰æ™•
    let avg = 0;
    for (let i = 0; i < bufferLength; i++) {
      avg += dataArray[i];
    }
    avg = avg / bufferLength;

    if (!bgm.paused && audioCtx && audioCtx.state === 'running') {
      let scale = 1 + avg / 100;
      let opacity = 0.5 + avg / 200;
      rippleDiv.style.transform = `translate(-50%, -50%) scale(${scale})`;
      rippleDiv.style.opacity = opacity;
    } else {
      rippleDiv.style.transform = `translate(-50%, -50%) scale(1)`;
      rippleDiv.style.opacity = 0.6;
    }
    requestAnimationFrame(draw);
  };
  draw();
}

function updateMusicUI() {
  let name = 'ğŸµ æœªæ’­æ”¾';
  if (musicList.length && musicList[currentMusicIndex]) name = 'ğŸµ ' + musicList[currentMusicIndex].name.substring(0,18);
  $('nowPlaying').innerText = name;
  $('musicPlayPause').innerHTML = bgm.paused ? 'â–¶ï¸' : 'â¸ï¸';
  renderMusicList();
}
function playMusic(i) {
  if (!musicList.length) return;
  currentMusicIndex = (i + musicList.length) % musicList.length;
  localStorage.currentMusicIndex = currentMusicIndex;
  bgm.src = musicList[currentMusicIndex].url;
  bgm.load();
  bgm.play().then(() => {
    if (!audioCtx) initAudioVisualizer();
    if (audioCtx.state === 'suspended') audioCtx.resume();
  }).catch(() => showLog('ç‚¹å‡»é¡µé¢æ‰èƒ½æ’­æ”¾éŸ³ä¹'));
  updateMusicUI();
}
function toggleMusic() {
  if (!musicList.length) { showLog('å…ˆå»éŸ³ä¹åº“æ·»åŠ éŸ³ä¹å§'); return; }
  if (bgm.paused) { if (!bgm.src) playMusic(currentMusicIndex); else bgm.play(); }
  else bgm.pause();
  updateMusicUI();
}
function prevMusic() { if (musicList.length) playMusic(currentMusicIndex-1); }
function nextMusic() { if (musicList.length) playMusic(currentMusicIndex+1); }
bgm.onended = nextMusic;
bgm.onplay = updateMusicUI; bgm.onpause = updateMusicUI;

function addMusicFiles() {
  $('musicInput').onchange = e => {
    Array.from(e.target.files).forEach(f => {
      if (f.size > 20*1024*1024) { showLog(f.name+' è¶…è¿‡20MB'); return; }
      let reader = new FileReader();
      reader.onload = ev => {
        musicList.push({ name: f.name, url: ev.target.result });
        localStorage.musicList = JSON.stringify(musicList);
        updateMusicUI();
      };
      reader.readAsDataURL(f);
    });
  };
  $('musicInput').click();
}
function removeMusic(i) {
  if (currentMusicIndex === i) { bgm.pause(); bgm.src = ''; }
  musicList.splice(i,1);
  localStorage.musicList = JSON.stringify(musicList);
  currentMusicIndex = cap(currentMusicIndex, musicList.length-1);
  localStorage.currentMusicIndex = currentMusicIndex;
  updateMusicUI();
}
function moveMusic(i, d) {
  let j = i + d;
  if (j<0 || j>=musicList.length) return;
  [musicList[i], musicList[j]] = [musicList[j], musicList[i]];
  if (currentMusicIndex === i) currentMusicIndex = j;
  else if (currentMusicIndex === j) currentMusicIndex = i;
  localStorage.musicList = JSON.stringify(musicList);
  localStorage.currentMusicIndex = currentMusicIndex;
  updateMusicUI();
}
function renderMusicList() {
  let html = '';
  if (!musicList.length) html = '<div class="empty-msg">æš‚æ— éŸ³ä¹ï¼Œç‚¹å‡»ä¸Šæ–¹æ·»åŠ ï½</div>';
  else {
    musicList.forEach((m, idx) => {
      let playing = (!bgm.paused && currentMusicIndex === idx);
      html += `<div class="item-row"><span><b>${playing?'ğŸ”Š ':''}${m.name}</b></span><div><button class="mini-btn" onclick="moveMusic(${idx},-1)">â¬†ï¸</button><button class="mini-btn" onclick="moveMusic(${idx},1)">â¬‡ï¸</button><button class="mini-btn" onclick="playMusic(${idx})">${playing?'â¸ï¸':'â–¶ï¸'}</button><button class="mini-btn" onclick="removeMusic(${idx})">âŒ</button></div></div>`;
    });
  }
  $('musicList').innerHTML = html;
}
function openMusicManager() { updateMusicUI(); openModal('musicModal'); }

// ====================== æ ¸å¿ƒæ¸¸æˆæ•°æ® ======================
let mood = 50, energy = 50, full = 50, health = 50, love = 50, coin = 20;
let maxMood = 100, maxEnergy = 100, maxFull = 100, maxHealth = 100, maxLove = 100;
let level = 1, exp = 0, storage = [];
let chatCD = 0, restCD = 0, cleanCD = 0;
let lastDecay = Date.now();

function expNeed() { return Math.floor(100 * Math.pow(1.6, level-1)); }
function updateMax() { maxMood = maxEnergy = maxFull = maxHealth = maxLove = 100 + level*10; }

function updateUI() {
  $('mood').innerText = mood; $('energy').innerText = energy; $('full').innerText = full;
  $('health').innerText = health; $('love').innerText = love;
  $('coinAmount').innerText = coin.toFixed(1);
  $('levelDisplay').innerText = level;
  let need = expNeed();
  let percent = (exp / need) * 100;
  $('expBar').style.width = percent + '%';
  $('expText').innerText = `${exp}/${need}`;
  
  ['mood','energy','full','health','love'].forEach(a => {
    let el = $(a+'Progress');
    if (el) el.style.width = (eval(a) / eval('max'+a.charAt(0).toUpperCase()+a.slice(1)) * 100) + '%';
  });
  updateMoodEmoji();
}
function updateMoodEmoji() {
  let emoji = 'ğŸ˜Š';
  if (health < 30) emoji = 'ğŸ˜·';
  else if (mood < 30) emoji = 'ğŸ˜¢';
  else if (energy < 20) emoji = 'ğŸ˜´';
  else if (mood > 80) emoji = 'ğŸ˜†';
  else if (love > 80) emoji = 'ğŸ¥°';
  $('moodEmoji').innerText = emoji;
}

function formatRemainTime(ms) {
  let totalSeconds = Math.floor(ms / 1000);
  if (totalSeconds < 60) return totalSeconds + 's';
  if (totalSeconds < 3600) return Math.floor(totalSeconds / 60) + 'm' + (totalSeconds % 60) + 's';
  let hours = Math.floor(totalSeconds / 3600);
  let minutes = Math.floor((totalSeconds % 3600) / 60);
  return hours + 'h' + (minutes > 0 ? minutes + 'm' : '');
}
let cdIntervals = {};
function startCDTimer(btnId, endTime, originalText) {
  if (cdIntervals[btnId]) clearInterval(cdIntervals[btnId]);
  let btn = $(btnId);
  if (!btn) return;
  btn.disabled = true;
  cdIntervals[btnId] = setInterval(() => {
    let remain = endTime - Date.now();
    if (remain <= 0) {
      clearInterval(cdIntervals[btnId]);
      btn.disabled = false;
      btn.innerText = originalText;
    } else {
      btn.innerText = originalText + ' (' + formatRemainTime(remain) + ')';
    }
  }, 1000);
}

// èŠå¤©å¤šæ ·åŒ–
const chatMessages = [
  'ğŸ’¬ èŠå¾—å¥½å¼€å¿ƒ +10ğŸ˜Š +5ğŸ’–',
  'ğŸ’¬ èµ«èˆè®²äº†ä¸ªç¬‘è¯ï¼Œä½ ç¬‘ç¿»äº† +8ğŸ˜Š +3ğŸ’–',
  'ğŸ’¬ ä½ ä»¬èŠèµ·äº†æ˜Ÿæ˜Ÿï¼Œå¥½æµªæ¼«å‘€ +12ğŸ˜Š +6ğŸ’–',
  'ğŸ’¬ èµ«èˆåˆ†äº«äº†ä»Šå¤©çš„è¶£äº‹ +9ğŸ˜Š +4ğŸ’–',
  'ğŸ’¬ ä½ å®‰æ…°äº†èµ«èˆï¼Œå¥¹å¥½æ„ŸåŠ¨ +15ğŸ˜Š +8ğŸ’–',
  'ğŸ’¬ ä½ ä»¬ä¸€èµ·å”±äº†é¦–æ­Œ +10ğŸ˜Š +5ğŸ’–',
  'ğŸ’¬ èµ«èˆç»™ä½ è®²äº†ä¸ªç§˜å¯†ï¼Œå…³ç³»æ›´äº²å¯†äº† +7ğŸ˜Š +7ğŸ’–'
];
function chatTalk() {
  if (chatCD > Date.now()) return;
  mood = cap(mood+10, maxMood);
  love = cap(love+5, maxLove);
  chatCD = Date.now() + 30000;
  addExp(52);
  const randomMsg = chatMessages[Math.floor(Math.random() * chatMessages.length)];
  showLog(randomMsg);
  updateUI();
  startCDTimer('chatBtn', chatCD, 'ğŸ’¬ èŠå¤©');
}
function doRest() {
  if (restCD > Date.now()) return;
  health = cap(health + Math.floor(maxHealth * 0.3), maxHealth);
  energy = cap(energy + Math.floor(maxEnergy * 0.5), maxEnergy);
  restCD = Date.now() + 12 * 3600000;
  addExp(520);
  showLog('ğŸ˜´ ç¾ç¾ç¡äº†ä¸€è§‰ +â¤ï¸30% +âš¡50%');
  updateUI();
  startCDTimer('restBtn', restCD, 'ğŸ˜´ ä¼‘æ¯');
}
function doClean() {
  if (cleanCD > Date.now()) return;
  health = cap(health + Math.floor(maxHealth * 0.3), maxHealth);
  mood = cap(mood + Math.floor(maxMood * 0.1), maxMood);
  cleanCD = Date.now() + 24 * 3600000;
  addExp(300);
  showLog('ğŸ§¹ æ´—é¦™é¦™ï½å¥åº·+30% å¿ƒæƒ…+10%');
  updateUI();
  startCDTimer('cleanBtn', cleanCD, 'ğŸ§¹ æ¸…æ´');
}

function addExp(n) {
  exp += n;
  while (exp >= expNeed()) {
    exp -= expNeed();
    level++;
    mood = cap(Math.floor(mood * 1.3), maxMood);
    energy = cap(Math.floor(energy * 1.3), maxEnergy);
    full = cap(Math.floor(full * 1.3), maxFull);
    health = cap(Math.floor(health * 1.3), maxHealth);
    love = cap(Math.floor(love * 1.3), maxLove);
    coin += 20;
    updateMax();
    showLog(`âœ¨ å‡çº§åˆ° Lv.${level}ï¼å…¨å±æ€§+30%ï¼Œå¥–åŠ±20ğŸ’°`);
  }
  updateUI();
}

$('avatarBox').addEventListener('click', () => {
  coin = Number((coin + 0.1).toFixed(1));
  showLog('ğŸ’° +0.1 é‡‘å¸');
  $('coinView').classList.add('jump');
  setTimeout(() => $('coinView').classList.remove('jump'), 500);
  addExp(1);
  updateUI();
});

// å±æ€§è¡°å‡
function decay() {
  let now = Date.now();
  if (now - lastDecay >= 60000) {
    mood = cap(mood-1, maxMood,0); energy = cap(energy-1, maxEnergy,0);
    full = cap(full-1, maxFull,0); health = cap(health-1, maxHealth,0);
    love = cap(love-1, maxLove,0); lastDecay = now; updateUI();
  }
}
setInterval(decay, 1000);

// ====================== å•†åº— (å®Œæ•´å•†å“åˆ—è¡¨) ======================
const items = [ /* å•†å“åˆ—è¡¨ä¸ä¹‹å‰ç›¸åŒï¼Œæ­¤å¤„çœç•¥ä½†å®é™…ä»£ç ä¸­ä¿ç•™å®Œæ•´ */ 
  { name:'ğŸ“è‰è“ç‰›å¥¶', price:3, type:0, mood:4, full:2, rare:0, levelUnlock:0 },
  { name:'ğŸŸè–¯ç‰‡', price:5, type:0, mood:5, full:3, health:-2, rare:0, levelUnlock:0 },
  { name:'ğŸ«å·§å…‹åŠ›', price:8, type:0, mood:8, full:2, health:-1, rare:0, levelUnlock:0 },
  { name:'ğŸ¬å½©è™¹ç³–', price:3, type:0, mood:4, full:1, rare:0, levelUnlock:0 },
  { name:'ğŸªå°ç†Šé¥¼å¹²', price:6, type:0, mood:4, full:4, rare:0, levelUnlock:0 },
  { name:'ğŸ­æ³¢æ¿ç³–', price:4, type:0, mood:5, full:1, rare:0, levelUnlock:0 },
  { name:'ğŸ§ç»µç»µå†°', price:7, type:0, mood:7, full:2, health:-1, rare:0, levelUnlock:0 },
  { name:'ğŸ®å¸ƒä¸', price:5, type:0, mood:6, full:1, rare:0, levelUnlock:0 },
  { name:'ğŸ©ç”œç”œåœˆ', price:6, type:0, mood:6, full:3, rare:0, levelUnlock:0 },
  { name:'ğŸ¿çˆ†ç±³èŠ±', price:4, type:0, mood:4, full:2, rare:0, levelUnlock:0 },
  { name:'ğŸ‚è‰è“è›‹ç³•', price:15, type:0, mood:12, full:6, health:-3, rare:1, levelUnlock:3 },
  { name:'ğŸ¦å†°æ·‡æ·‹', price:9, type:0, mood:7, full:3, health:-2, rare:1, levelUnlock:0 },
  { name:'ğŸ­å½©è™¹æ£’æ£’ç³–', price:12, type:0, mood:10, full:2, rare:1, levelUnlock:2 },
  { name:'ğŸ°ææ‹‰ç±³è‹', price:18, type:0, mood:14, full:5, health:-2, rare:1, levelUnlock:4 },
  { name:'ğŸ§çº¸æ¯è›‹ç³•', price:10, type:0, mood:9, full:3, rare:1, levelUnlock:1 },
  { name:'â˜ï¸æ£‰èŠ±ç³–äº‘', price:25, type:0, mood:20, full:3, rare:2, levelUnlock:8 },
  { name:'ğŸŒŒæ˜Ÿç©ºå¥¶èŒ¶', price:35, type:0, mood:25, full:5, health:2, rare:2, levelUnlock:12 },
  { name:'ğŸ¨åœ£ä»£', price:30, type:0, mood:22, full:4, health:-1, rare:2, levelUnlock:10 },
  { name:'ğŸ‘‘å…¬ä¸»è›‹ç³•å¡”', price:88, type:0, mood:50, full:10, health:5, rare:3, levelUnlock:20 },
  { name:'ğŸ¾é¦™æ§Ÿæœå†»', price:68, type:0, mood:45, full:6, health:4, rare:3, levelUnlock:18 },
  // ç©å…· type1
  { name:'ğŸ§¸æ¯›ç»’å°ç†Š', price:39, type:1, mood:15, love:10, rare:1, levelUnlock:3 },
  { name:'ğŸª„é­”æ³•æ£’', price:45, type:1, mood:20, love:15, rare:2, levelUnlock:8 },
  { name:'ğŸ‘—æ´›ä¸½å¡”è£™å­', price:68, type:1, mood:25, love:20, rare:2, levelUnlock:12 },
  { name:'ğŸ»â€â„ï¸å·¨å¤§æ¯›ç»’ç†Š', price:128, type:1, mood:40, love:35, rare:3, levelUnlock:18 },
  { name:'ğŸ°åŸå ¡ç§¯æœ¨', price:198, type:1, mood:60, love:50, rare:3, levelUnlock:25 },
  { name:'ğŸš—å°æ±½è½¦', price:8, type:1, mood:5, love:2, rare:0, levelUnlock:0 },
  { name:'ğŸª€æ‚ æ‚ çƒ', price:6, type:1, mood:6, love:1, rare:0, levelUnlock:0 },
  { name:'ğŸ§©æ‹¼å›¾', price:12, type:1, mood:8, love:5, rare:0, levelUnlock:0 },
  { name:'ğŸˆæ°”çƒ', price:4, type:1, mood:7, love:2, rare:0, levelUnlock:0 },
  { name:'ğŸª†å¥—å¨ƒ', price:15, type:1, mood:10, love:6, rare:0, levelUnlock:0 },
  { name:'ğŸ¤–æœºå™¨äºº', price:20, type:1, mood:12, love:8, rare:0, levelUnlock:0 },
  { name:'ğŸ¨ç”»æ¿', price:18, type:1, mood:14, love:7, rare:0, levelUnlock:0 },
  { name:'ğŸ“šç»˜æœ¬', price:10, type:1, mood:9, love:4, rare:0, levelUnlock:0 },
  { name:'ğŸ¥å°é¼“', price:16, type:1, mood:13, love:5, rare:0, levelUnlock:0 },
  { name:'ğŸªé£ç­', price:14, type:1, mood:11, love:3, rare:0, levelUnlock:0 },
  { name:'ğŸ´æ‘‡æ‘‡é©¬', price:28, type:1, mood:18, love:12, rare:1, levelUnlock:2 },
  { name:'ğŸ­é¢å…·', price:32, type:1, mood:20, love:14, rare:1, levelUnlock:4 },
  { name:'ğŸªå¸ç¯·', price:42, type:1, mood:22, love:18, rare:1, levelUnlock:6 },
  { name:'ğŸ›¼è½®æ»‘é‹', price:36, type:1, mood:19, love:16, rare:1, levelUnlock:5 },
  { name:'ğŸ¬æ”¾æ˜ æœº', price:55, type:1, mood:28, love:24, rare:1, levelUnlock:7 },
  // ä¸»é£Ÿ type2
  { name:'ğŸšç™½ç±³é¥­', price:3, type:2, full:10, rare:0, levelUnlock:0 },
  { name:'ğŸ¥ç‰›è§’åŒ…', price:4, type:2, full:12, rare:0, levelUnlock:0 },
  { name:'ğŸœæ‹‰é¢', price:6, type:2, full:15, rare:0, levelUnlock:0 },
  { name:'ğŸåå¸', price:3, type:2, full:8, rare:0, levelUnlock:0 },
  { name:'ğŸ¥Ÿé¥ºå­', price:5, type:2, full:14, rare:0, levelUnlock:0 },
  { name:'ğŸ™é¥­å›¢', price:4, type:2, full:11, rare:0, levelUnlock:0 },
  { name:'ğŸæ„é¢', price:7, type:2, full:18, rare:0, levelUnlock:0 },
  { name:'ğŸ²ç²¥', price:3, type:2, full:9, rare:0, levelUnlock:0 },
  { name:'ğŸ¥ªä¸‰æ˜æ²»', price:6, type:2, full:16, rare:0, levelUnlock:0 },
  { name:'ğŸ³ç…è›‹', price:3, type:2, full:7, rare:0, levelUnlock:0 },
  { name:'ğŸ£å¯¿å¸æ‹¼ç›˜', price:18, type:2, full:22, mood:8, rare:1, levelUnlock:4 },
  { name:'ğŸ²å°ç«é”…', price:28, type:2, full:30, mood:12, health:-3, rare:2, levelUnlock:9 },
  { name:'ğŸ¥©ç‰›æ’å¥—é¤', price:48, type:2, full:35, mood:20, health:5, rare:2, levelUnlock:15 },
  { name:'ğŸ±æ»¡æ±‰å…¨å¸­', price:168, type:2, full:100, mood:50, health:10, rare:3, levelUnlock:30 },
  // æ—¥ç”¨å“ type3
  { name:'ğŸ§»çº¸å·¾', price:5, type:3, health:2, rare:0, levelUnlock:0 },
  { name:'ğŸ§´æ²æµ´éœ²', price:18, type:3, health:8, rare:0, levelUnlock:0 },
  { name:'ğŸ§¼é¦™çš‚', price:4, type:3, health:3, rare:0, levelUnlock:0 },
  { name:'ğŸª¥ç‰™åˆ·', price:6, type:3, health:4, rare:0, levelUnlock:0 },
  { name:'ğŸ§´æ´—å‘æ°´', price:16, type:3, health:9, rare:0, levelUnlock:0 },
  { name:'ğŸ§´æŠ¤å‘ç´ ', price:15, type:3, health:7, rare:0, levelUnlock:0 },
  { name:'ğŸ§½æµ·ç»µ', price:3, type:3, health:2, rare:0, levelUnlock:0 },
  { name:'ğŸ§¹æ‰«å¸š', price:8, type:3, health:5, rare:0, levelUnlock:0 },
  { name:'ğŸ§´æ¶¦è‚¤éœ²', price:12, type:3, health:6, rare:0, levelUnlock:0 },
  { name:'ğŸª£æ°´æ¡¶', price:10, type:3, health:4, rare:0, levelUnlock:0 },
  { name:'ğŸ§ªæŠ¤è‚¤å“å¥—è£…', price:45, type:3, health:15, love:10, rare:2, levelUnlock:10 },
  { name:'ğŸ›è±ªåæµ´ç¼¸', price:188, type:3, mood:40, health:25, rare:3, levelUnlock:22 },
  { name:'ğŸ§´ç²¾æ²¹', price:38, type:3, health:12, mood:8, rare:1, levelUnlock:5 },
  { name:'ğŸ§¼é¦™è–°', price:30, type:3, health:10, mood:10, rare:1, levelUnlock:4 },
  { name:'ğŸ§´èº«ä½“ä¹³', price:28, type:3, health:11, love:5, rare:1, levelUnlock:3 },
  { name:'ğŸ§´é˜²æ™’éœœ', price:25, type:3, health:9, rare:1, levelUnlock:2 },
  { name:'ğŸ§´é¢è†œ', price:22, type:3, health:8, mood:6, rare:1, levelUnlock:1 },
  { name:'ğŸ§´ç²¾åæ¶²', price:55, type:3, health:18, mood:12, rare:2, levelUnlock:12 },
];

let shopTab = 0;
function showTab(t) { shopTab = t; renderShop(); }
function renderShop() {
  let list = items.filter(i => i.type === shopTab);
  list.sort((a,b) => a.price - b.price);
  let html = '';
  list.forEach((it, idx) => {
    let locked = it.levelUnlock > level;
    let unlockText = locked ? `<div class="unlock-condition">ğŸ”’ ç­‰çº§ ${it.levelUnlock} è§£é”</div>` : '';
    html += `<div class="shop-item rare-${it.rare} ${locked?'locked':''}"><span class="rare-tag">${rareText[it.rare]}</span> <b>${it.name}</b><br><small>${it.mood?'ğŸ˜Š+'+it.mood:''} ${it.full?'ğŸš+'+it.full:''} ${it.health?'â¤ï¸+'+it.health:''} ${it.love?'ğŸ’–+'+it.love:''}</small>${unlockText}<div style="display:flex; justify-content:space-between; margin-top:6px"><span>ğŸ’° ${it.price}</span><button class="mini-btn" onclick="buyItem(${idx})" ${locked?'disabled':''}>è´­ä¹°</button></div></div>`;
  });
  $('shopBody').innerHTML = html;
}
function buyItem(idx) {
  let list = items.filter(i => i.type === shopTab).sort((a,b) => a.price - b.price);
  let it = list[idx];
  if (coin < it.price) { showLog('ğŸ’°ä¸å¤Ÿ'); return; }
  coin = Number((coin - it.price).toFixed(1));
  let exist = storage.find(s => s.name === it.name);
  if (exist) exist.count++;
  else storage.push({ ...it, count: 1 });
  showLog('è´­ä¹°æˆåŠŸ'); updateUI(); renderShop();
}
function openShop() { renderShop(); openModal('shopModal'); }

// ====================== ä»“åº“/ä½¿ç”¨ (å¢åŠ é£å…¥ç‰¹æ•ˆ) ======================
function openStorage() {
  if (!storage.length) { $('storBody').innerHTML = '<div class="empty-msg">ä»“åº“ç©ºç©º</div>'; }
  else {
    let html = '';
    storage.forEach((it,i) => {
      let effects = [];
      if (it.mood) effects.push(`ğŸ˜Š+${it.mood}`);
      if (it.energy) effects.push(`âš¡+${it.energy}`);
      if (it.full) effects.push(`ğŸš+${it.full}`);
      if (it.health) effects.push(`â¤ï¸+${it.health}`);
      if (it.love) effects.push(`ğŸ’–+${it.love}`);
      let effectStr = effects.join(' ');
      // ä¼ é€’äº‹ä»¶å¯¹è±¡ï¼Œä»¥ä¾¿è·å–ç‚¹å‡»ä½ç½®
      html += `<div class="item-row"><div class="item-info"><span><b>${it.name}</b> x${it.count}</span><span class="item-effects">${effectStr}</span></div><button class="mini-btn" onclick="useItem(${i}, event)">ä½¿ç”¨</button></div>`;
    });
    $('storBody').innerHTML = html;
  }
  openModal('storModal');
}
function useItem(i, event) {
  let it = storage[i];
  if (!it) return;

  // è·å–ç‰©å“è¡¨æƒ…ï¼ˆå–ç¬¬ä¸€ä¸ªå­—ç¬¦ä½œä¸ºå›¾æ ‡ï¼‰
  let icon = it.name.charAt(0); // ä¾‹å¦‚ ğŸ“
  // è·å–ç‚¹å‡»ä½ç½®
  let x = event.clientX;
  let y = event.clientY;

  // åˆ›å»ºé£å…¥å…ƒç´ 
  let fly = document.createElement('div');
  fly.className = 'fly-item';
  fly.innerText = icon;
  fly.style.left = x + 'px';
  fly.style.top = y + 'px';
  document.body.appendChild(fly);

  // è·å–å¤´åƒä½ç½®
  let avatarRect = $('avatarBox').getBoundingClientRect();
  let avatarX = avatarRect.left + avatarRect.width / 2;
  let avatarY = avatarRect.top + avatarRect.height / 2;

  // è®¡ç®—ç›¸å¯¹ä½ç§»
  let dx = avatarX - x;
  let dy = avatarY - y;
  fly.style.setProperty('--fly-x', dx + 'px');
  fly.style.setProperty('--fly-y', dy + 'px');

  // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
  setTimeout(() => { fly.remove(); }, 600);

  // åº”ç”¨ç‰©å“æ•ˆæœ
  let changes = [];
  if (it.mood) { mood = cap(mood + it.mood, maxMood); changes.push(`ğŸ˜Š+${it.mood}`); }
  if (it.energy) { energy = cap(energy + it.energy, maxEnergy); changes.push(`âš¡+${it.energy}`); }
  if (it.full) { full = cap(full + it.full, maxFull); changes.push(`ğŸš+${it.full}`); }
  if (it.health) { health = cap(health + it.health, maxHealth); changes.push(`â¤ï¸+${it.health}`); }
  if (it.love) { love = cap(love + it.love, maxLove); changes.push(`ğŸ’–+${it.love}`); }
  it.count--;
  if (it.count <= 0) storage.splice(i,1);
  showLog(`ä½¿ç”¨ ${it.name}: ${changes.join(' ')}`);
  if (it.rare >= 2) showFullscreenEffect(it.rare);
  updateUI();
  closeModal('storModal');
}
function openEat() {
  let list = storage.filter(i => i.type===0 || i.type===2);
  if (!list.length) { $('eatBody').innerHTML = '<div class="empty-msg">æ²¡æœ‰å¯æŠ•å–‚çš„é£Ÿç‰©</div>'; }
  else {
    let html = '';
    list.forEach((it, idx) => {
      let effects = [];
      if (it.mood) effects.push(`ğŸ˜Š+${it.mood}`);
      if (it.full) effects.push(`ğŸš+${it.full}`);
      if (it.health) effects.push(`â¤ï¸+${it.health}`);
      let effectStr = effects.join(' ');
      html += `<div class="item-row"><div class="item-info"><span><b>${it.name}</b> x${it.count}</span><span class="item-effects">${effectStr}</span></div><button class="mini-btn" onclick="useEat(${idx}, event)">æŠ•å–‚</button></div>`;
    });
    $('eatBody').innerHTML = html;
  }
  openModal('eatModal');
}
function useEat(idx, event) {
  let list = storage.filter(i => i.type===0 || i.type===2);
  let realIdx = storage.findIndex(x => x.name === list[idx].name);
  if (realIdx !== -1) { useItem(realIdx, event); closeModal('eatModal'); }
}
function openPlay() {
  let list = storage.filter(i => i.type===1);
  if (!list.length) { $('playBody').innerHTML = '<div class="empty-msg">æ²¡æœ‰ç©å…·</div>'; }
  else {
    let html = '';
    list.forEach((it, idx) => {
      let effects = [];
      if (it.mood) effects.push(`ğŸ˜Š+${it.mood}`);
      if (it.love) effects.push(`ğŸ’–+${it.love}`);
      let effectStr = effects.join(' ');
      html += `<div class="item-row"><div class="item-info"><span><b>${it.name}</b> x${it.count}</span><span class="item-effects">${effectStr}</span></div><button class="mini-btn" onclick="usePlay(${idx}, event)">ç©è€</button></div>`;
    });
    $('playBody').innerHTML = html;
  }
  openModal('playModal');
}
function usePlay(idx, event) {
  let list = storage.filter(i => i.type===1);
  let realIdx = storage.findIndex(x => x.name === list[idx].name);
  if (realIdx !== -1) { useItem(realIdx, event); closeModal('playModal'); }
}

// ====================== ç­¾åˆ°ç³»ç»Ÿ ======================
let signData = JSON.parse(localStorage.signData || '{"year":0,"month":0,"signed":[],"lucky":-1}');
function refreshSignData() {
  let now = new Date(), y = now.getFullYear(), m = now.getMonth();
  if (signData.year !== y || signData.month !== m) {
    let days = new Date(y, m+1, 0).getDate();
    signData = { year: y, month: m, signed: [], lucky: Math.floor(Math.random() * days) + 1 };
    localStorage.signData = JSON.stringify(signData);
  }
}
function canSignToday() { return !signData.signed.includes(new Date().getDate()); }
function doSign() {
  if (!canSignToday()) { showLog('ä»Šå¤©å·²ç»ç­¾è¿‡å•¦'); openSignModal(); return; }
  let today = new Date().getDate();
  signData.signed.push(today);
  let goldReward = 5;
  let expReward = 20;
  if (today === signData.lucky) { goldReward *= 2; expReward *= 2; }
  coin += goldReward;
  addExp(expReward);
  let commonItems = items.filter(i => i.rare === 0 && i.price < 10);
  if (commonItems.length) {
    let rand = commonItems[Math.floor(Math.random() * commonItems.length)];
    let exist = storage.find(s => s.name === rand.name);
    if (exist) exist.count++;
    else storage.push({ ...rand, count: 1 });
    showLog(`ç­¾åˆ° +${goldReward}ğŸ’°, +${expReward}ç»éªŒ, è·å¾—${rand.name}`);
  } else {
    showLog(`ç­¾åˆ° +${goldReward}ğŸ’°, +${expReward}ç»éªŒ`);
  }
  let daysInMonth = new Date(signData.year, signData.month+1, 0).getDate();
  if (signData.signed.length === daysInMonth) {
    coin += 50;
    let epicItem = items.filter(i => i.rare === 2)[0];
    if (epicItem) {
      let exist = storage.find(s => s.name === epicItem.name);
      if (exist) exist.count++; else storage.push({ ...epicItem, count: 1 });
      showLog('ğŸ‰ æ»¡ç­¾å¥–åŠ± +50ğŸ’° + å²è¯—ç‰©å“ï¼');
    }
  }
  localStorage.signData = JSON.stringify(signData);
  updateUI();
  openSignModal();
}
function openSignModal() {
  refreshSignData();
  let now = new Date(), year = signData.year, month = signData.month+1;
  let days = new Date(signData.year, signData.month+1, 0).getDate();
  let firstDay = new Date(signData.year, signData.month, 1).getDay(); 
  let html = `<div style="text-align:center; font-size:18px; margin-bottom:6px;">${year}å¹´${month}æœˆ</div>
  <div style="text-align:center; margin:8px 0; background:#ffe9f4; border-radius:40px; padding:8px; font-size:14px;">
    <div>âœ¨ä»Šæ—¥ç­¾åˆ°å¥–åŠ±âœ¨</div>
    <div>é‡‘å¸5, ç»éªŒ20, éšæœºæ™®é€šå•†å“</div>
    ${signData.lucky===now.getDate()?'<div>ğŸ¯ä»Šæ—¥å¹¸è¿æ—¥åŒå€ï¼</div>':''}
  </div>
  <div class="calendar">` + 'æ—¥ä¸€äºŒä¸‰å››äº”å…­'.split('').map(d=>`<div style="font-weight:bold; font-size:14px;">${d}</div>`).join('');
  for (let i=0; i<firstDay; i++) html += '<div></div>';
  for (let d=1; d<=days; d++) {
    let cls = 'calendar-day';
    if (signData.signed.includes(d)) cls += ' signed';
    if (d === signData.lucky) cls += ' lucky';
    if (d === now.getDate()) cls += ' today';
    html += `<div class="${cls}" onclick="if(${!signData.signed.includes(d)} && ${d}===${now.getDate()}) doSign()">${d}</div>`;
  }
  html += '</div><div style="margin-top:12px; text-align:center"><button class="mini-btn" onclick="doSign()">âœï¸ ä»Šæ—¥ç­¾åˆ°</button></div>';
  $('signBody').innerHTML = html;
  openModal('signModal');
}

// ====================== è‰²ç³»è®¾ç½® ======================
function setColorTheme(main, second, themeName) {
  document.documentElement.style.setProperty('--main-color', main);
  document.documentElement.style.setProperty('--second-color', second);
  document.documentElement.style.setProperty('--main-light', main + 'dd');
  document.documentElement.style.setProperty('--main-dark', main);
  let bodyBg, cardBg;
  if (themeName === 'æµªæ¼«ç²‰') {
    bodyBg = 'linear-gradient(165deg, #ffe9f4, #f0e6ff)';
    cardBg = 'rgba(255, 250, 250, 0.95)';
  } else if (themeName === 'æ¢¦å¹»ç´«') {
    bodyBg = 'linear-gradient(165deg, #e6d5ff, #d9b0ff)';
    cardBg = 'rgba(245, 230, 255, 0.95)';
  } else if (themeName === 'æ¸…æ–°ç»¿') {
    bodyBg = 'linear-gradient(165deg, #e0ffe0, #c0e8d5)';
    cardBg = 'rgba(240, 255, 240, 0.95)';
  } else if (themeName === 'æš–é˜³æ©™') {
    bodyBg = 'linear-gradient(165deg, #ffe0b5, #ffd2a0)';
    cardBg = 'rgba(255, 245, 235, 0.95)';
  } else if (themeName === 'æ·±é‚ƒé»‘') {
    bodyBg = 'linear-gradient(165deg, #2c3e50, #34495e)';
    cardBg = 'rgba(30, 30, 40, 0.95)';
  } else if (themeName === 'æµ·æ´‹è“') {
    bodyBg = 'linear-gradient(165deg, #3498db, #5dade2)';
    cardBg = 'rgba(235, 245, 255, 0.95)';
  } else {
    bodyBg = 'linear-gradient(165deg, #ffe9f4, #f0e6ff)';
    cardBg = 'rgba(255, 250, 250, 0.95)';
  }
  document.body.style.background = bodyBg;
  document.querySelector('.game-box').style.background = cardBg;
  localStorage.colorMain = main;
  localStorage.colorSecond = second;
  localStorage.colorTheme = themeName;
  closeModal('colorModal');
}
function openColorModal() { openModal('colorModal'); }

// ====================== ä¸»é¢˜åˆ‡æ¢ ======================
function toggleTheme() {
  document.body.classList.toggle('night');
  localStorage.theme = document.body.classList.contains('night') ? 'night' : 'day';
}

// ====================== å­˜æ¡£/è¯»æ¡£ ======================
function save() {
  localStorage.data = JSON.stringify({ mood, energy, full, health, love, coin, level, exp, storage, chatCD, restCD, cleanCD, lastDecay });
  localStorage.startTime = startTime;
}
function load() {
  let d = JSON.parse(localStorage.data || '{}');
  mood = d.mood ?? 50; energy = d.energy ?? 50; full = d.full ?? 50; health = d.health ?? 50; love = d.love ?? 50;
  coin = d.coin ?? 20; level = d.level ?? 1; exp = d.exp ?? 0; storage = d.storage ?? [];
  chatCD = d.chatCD ?? 0; restCD = d.restCD ?? 0; cleanCD = d.cleanCD ?? 0; lastDecay = d.lastDecay ?? Date.now();
  if (localStorage.avatar) $('avatarImg').src = localStorage.avatar;
  if (localStorage.theme === 'night') document.body.classList.add('night');
  if (localStorage.colorMain) {
    document.documentElement.style.setProperty('--main-color', localStorage.colorMain);
    document.documentElement.style.setProperty('--second-color', localStorage.colorSecond || '#a975ff');
    document.documentElement.style.setProperty('--main-light', localStorage.colorMain + 'dd');
    if (localStorage.colorTheme) {
      let theme = localStorage.colorTheme;
      if (theme === 'æµªæ¼«ç²‰') document.body.style.background = 'linear-gradient(165deg, #ffe9f4, #f0e6ff)';
      else if (theme === 'æ¢¦å¹»ç´«') document.body.style.background = 'linear-gradient(165deg, #e6d5ff, #d9b0ff)';
      else if (theme === 'æ¸…æ–°ç»¿') document.body.style.background = 'linear-gradient(165deg, #e0ffe0, #c0e8d5)';
      else if (theme === 'æš–é˜³æ©™') document.body.style.background = 'linear-gradient(165deg, #ffe0b5, #ffd2a0)';
      else if (theme === 'æ·±é‚ƒé»‘') document.body.style.background = 'linear-gradient(165deg, #2c3e50, #34495e)';
      else if (theme === 'æµ·æ´‹è“') document.body.style.background = 'linear-gradient(165deg, #3498db, #5dade2)';
      document.querySelector('.game-box').style.background = 'rgba(255, 250, 250, 0.95)';
    }
  }
  avatarHistory = JSON.parse(localStorage.avatarHistory || '[]');
  updateMax();
  updateUI();
  $('chatBtn').innerText = 'ğŸ’¬ èŠå¤©';
  $('restBtn').innerText = 'ğŸ˜´ ä¼‘æ¯';
  $('cleanBtn').innerText = 'ğŸ§¹ æ¸…æ´';
  if (chatCD > Date.now()) startCDTimer('chatBtn', chatCD, 'ğŸ’¬ èŠå¤©');
  if (restCD > Date.now()) startCDTimer('restBtn', restCD, 'ğŸ˜´ ä¼‘æ¯');
  if (cleanCD > Date.now()) startCDTimer('cleanBtn', cleanCD, 'ğŸ§¹ æ¸…æ´');
  showLog('âœ¨ èµ«èˆé†’æ¥å•¦ âœ¨');
}

window.onload = () => {
  load();
  setInterval(updatePlayTime, 1000);
  updateMusicUI();
};
</script>
</body>
</html>