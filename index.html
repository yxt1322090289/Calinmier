<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>âœ¨èµ«èˆå…»æˆÂ·å¹¸è¿æ‹‰ç›˜âœ¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <!-- è¶…èŒå­—ä½“ç»„åˆ + Emoji æ”¯æŒ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Patrick+Hand&family=Gaegu:wght@300;400;700&family=M+PLUS+Rounded+1c:wght@400;700;800&family=Comfortaa:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-100-M/fonts/zkkl2016.css">
  <link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-100-M/font-awesome/4.7.0/css/font-awesome.min.css">
  <style>
    /* ================= å…¨å±€èŒåŒ–å˜é‡ & åŠ¨æ€ç‰¹æ•ˆ ================= */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "ç«™é…·å¿«ä¹ä½“2016", "M PLUS Rounded 1c", "Fredoka One", "Patrick Hand", "Gaegu", "Comfortaa", "å¹¼åœ†", "Comic Sans MS", "Apple Color Emoji", "Segoe UI Emoji", cursive;
      letter-spacing: 0.5px;
    }
    html, body {
      height: 100%;
      overflow: hidden;
    }
    :root {
      --main-color: #ff85c0;
      --main-light: #ffb3d9;
      --main-dark: #e85ba0;
      --second-color: #a975ff;
      --bg-light: linear-gradient(165deg, #ffe9f4 0%, #f0e6ff 100%);
      --bg-night: linear-gradient(165deg, #2d1b2c 0%, #1a1435 100%);
      --card-bg: rgba(255, 250, 250, 0.96);
      --card-bg-night: rgba(45, 30, 45, 0.96);
      --text-main: #442233;
      --text-secondary: #775566;
      --text-night: #ffe6f0;
      --text-night-secondary: #ccb3c2;
      --rare-normal: #9a8c98;
      --rare-rare: #4d9fff;
      --rare-epic: #c77dff;
      --rare-legend: #ff9f4b;
      --radius-md: 20px;
      --radius-lg: 28px;
      --radius-xl: 40px;
      --radius-full: 999px;
      --shadow-soft: 0 15px 30px rgba(255, 120, 180, 0.2), 0 5px 15px rgba(0,0,0,0.05);
      --shadow-glow: 0 0 20px #ffb3d9, 0 8px 25px rgba(255, 120, 200, 0.4);
      --transition: all 0.25s cubic-bezier(0.2, 0.9, 0.3, 1.2);
    }
    body {
      background: var(--bg-light);
      background-size: cover;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 8px;
      transition: var(--transition);
      position: relative;
    }
    /* é¢æ¿ç‰¹æ•ˆå®¹å™¨ */
    .game-box {
      position: relative;
      z-index: 1;
      overflow: hidden;
    }
    .game-box::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      transition: opacity 0.3s;
      opacity: 0;
      border-radius: inherit;
    }
    /* äº‘æœµç‰¹æ•ˆ */
    body.effect-cloud .game-box::after {
      opacity: 0.7;
      background: radial-gradient(circle at 20% 30%, rgba(255,255,255,0.5) 8px, transparent 8px),
                  radial-gradient(circle at 40% 60%, rgba(255,255,255,0.5) 12px, transparent 12px),
                  radial-gradient(circle at 60% 20%, rgba(255,255,255,0.5) 10px, transparent 10px),
                  radial-gradient(circle at 80% 70%, rgba(255,255,255,0.5) 14px, transparent 14px);
      background-size: 200px 200px;
      animation: cloudMove 12s infinite linear;
    }
    @keyframes cloudMove { 0% { background-position: 0 0; } 100% { background-position: 200px 200px; } }
    /* æ˜Ÿæ˜Ÿç‰¹æ•ˆ */
    body.effect-stars .game-box::after {
      opacity: 0.9;
      background: radial-gradient(2px 2px at 10% 10%, white 2px, transparent 2px),
                  radial-gradient(3px 3px at 30% 40%, white 3px, transparent 3px),
                  radial-gradient(2px 2px at 50% 70%, white 2px, transparent 2px),
                  radial-gradient(4px 4px at 80% 20%, white 4px, transparent 4px),
                  radial-gradient(2px 2px at 90% 60%, white 2px, transparent 2px);
      background-size: 200px 200px;
      animation: twinkle 2s infinite alternate;
    }
    @keyframes twinkle { 0% { opacity: 0.5; } 100% { opacity: 1; } }
    /* æ–œçº¿ç‰¹æ•ˆ */
    body.effect-slash .game-box::after {
      opacity: 0.6;
      background: repeating-linear-gradient(45deg, rgba(255,255,255,0.4) 0px, rgba(255,255,255,0.4) 2px, transparent 2px, transparent 10px);
      background-size: 30px 30px;
      animation: slashMove 3s linear infinite;
    }
    @keyframes slashMove { 0% { background-position: 0 0; } 100% { background-position: 30px 30px; } }
    /* æµæ²™ç‰¹æ•ˆ */
    body.effect-quicksand .game-box::after {
      opacity: 0.7;
      background: radial-gradient(4px 4px at 10% 10%, rgba(255,215,0,0.6) 2px, transparent 2px),
                  radial-gradient(3px 3px at 30% 30%, rgba(255,140,0,0.6) 2px, transparent 2px),
                  radial-gradient(5px 5px at 50% 50%, rgba(255,215,0,0.6) 3px, transparent 3px),
                  radial-gradient(3px 3px at 70% 70%, rgba(255,140,0,0.6) 2px, transparent 2px),
                  radial-gradient(4px 4px at 90% 90%, rgba(255,215,0,0.6) 2px, transparent 2px);
      background-size: 150px 150px;
      animation: quicksandFall 2s linear infinite;
    }
    @keyframes quicksandFall { 0% { background-position: 0 -150px; } 100% { background-position: 0 150px; } }
    /* æµæ˜Ÿé›¨ç‰¹æ•ˆ */
    body.effect-meteor .game-box::after {
      opacity: 0.8;
      background: 
        linear-gradient(45deg, transparent 90%, rgba(255,255,255,0.9) 90% 95%, transparent 95%),
        linear-gradient(135deg, transparent 92%, rgba(255,255,180,0.8) 92% 96%, transparent 96%),
        radial-gradient(3px 3px at 15% 20%, white 3px, transparent 3px),
        radial-gradient(4px 4px at 35% 50%, rgba(255,255,200,0.9) 4px, transparent 4px),
        radial-gradient(2px 2px at 55% 80%, white 2px, transparent 2px),
        radial-gradient(5px 5px at 75% 10%, rgba(255,255,200,0.9) 5px, transparent 5px),
        radial-gradient(3px 3px at 90% 60%, white 3px, transparent 3px);
      background-size: 300% 300%, 250% 250%, 200% 200%, 200% 200%, 200% 200%, 200% 200%, 200% 200%;
      background-position: 0 0;
      animation: meteorShower 2.5s linear infinite;
    }
    @keyframes meteorShower { 0% { background-position: 0 0, 0 0, 0 0, 0 0, 0 0, 0 0, 0 0; } 100% { background-position: 300% 300%, 250% 250%, 200% 200%, 200% 200%, 200% 200%, 200% 200%, 200% 200%; } }

    /* å¤œé—´æ¨¡å¼é€‚é… */
    body.night.effect-cloud .game-box::after { background: radial-gradient(circle at 20% 30%, rgba(200,200,255,0.4) 8px, transparent 8px), radial-gradient(circle at 40% 60%, rgba(200,200,255,0.4) 12px, transparent 12px), radial-gradient(circle at 60% 20%, rgba(200,200,255,0.4) 10px, transparent 10px), radial-gradient(circle at 80% 70%, rgba(200,200,255,0.4) 14px, transparent 14px); }
    body.night.effect-stars .game-box::after { background: radial-gradient(2px 2px at 10% 10%, #aaccff 2px, transparent 2px), radial-gradient(3px 3px at 30% 40%, #aaccff 3px, transparent 3px), radial-gradient(2px 2px at 50% 70%, #aaccff 2px, transparent 2px), radial-gradient(4px 4px at 80% 20%, #aaccff 4px, transparent 4px), radial-gradient(2px 2px at 90% 60%, #aaccff 2px, transparent 2px); }
    body.night.effect-slash .game-box::after { background: repeating-linear-gradient(45deg, rgba(180,180,255,0.3) 0px, rgba(180,180,255,0.3) 2px, transparent 2px, transparent 10px); }
    body.night.effect-quicksand .game-box::after { background: radial-gradient(4px 4px at 10% 10%, rgba(220,180,100,0.5) 2px, transparent 2px), radial-gradient(3px 3px at 30% 30%, rgba(160,120,60,0.5) 2px, transparent 2px), radial-gradient(5px 5px at 50% 50%, rgba(220,180,100,0.5) 3px, transparent 3px), radial-gradient(3px 3px at 70% 70%, rgba(160,120,60,0.5) 2px, transparent 2px), radial-gradient(4px 4px at 90% 90%, rgba(220,180,100,0.5) 2px, transparent 2px); }
    body.night.effect-meteor .game-box::after { background: linear-gradient(45deg, transparent 90%, rgba(200,200,255,0.7) 90% 95%, transparent 95%), linear-gradient(135deg, transparent 92%, rgba(180,180,255,0.6) 92% 96%, transparent 96%), radial-gradient(3px 3px at 15% 20%, #aaccff 3px, transparent 3px), radial-gradient(4px 4px at 35% 50%, #bbddff 4px, transparent 4px), radial-gradient(2px 2px at 55% 80%, #aaccff 2px, transparent 2px), radial-gradient(5px 5px at 75% 10%, #bbddff 5px, transparent 5px), radial-gradient(3px 3px at 90% 60%, #aaccff 3px, transparent 3px); }

    body.night { background: #180e20 !important; color: #f0c0e0; }
    body.night .game-box { background: rgba(35, 20, 35, 0.97); border-color: #8a5a88; box-shadow: 0 15px 35px rgba(0,0,0,0.7), inset 0 0 0 3px #8a5a88; }
    body.night .top-bar { background: rgba(70, 35, 65, 0.9); }
    body.night .main-btn { background: #5a2a55; border-color: #b27aae; color: #ffd0f5; box-shadow: 0 6px 0 #7a3a75; }
    body.night .mini-btn { background: #4a3248; border-color: #9a6a98; color: #ffc0e8; box-shadow: 0 5px 0 #6a3a65; }
    body.night .attr-item { background: #4a2a45; border-color: #aa7aa8; box-shadow: 0 6px 0 #7a3a70; }
    body.night .attr-num { color: #ffb0e0; }
    body.night .fixed-chat, body.night .play-time, body.night .now-playing { color: #ffc0e8; background: rgba(90, 40, 75, 0.8); }
    body.night .coin { background: #6a2e55; color: #ffe680; }
    body.night .modal-box { background: #351d32; border-color: #aa7aa8; }
    body.night .modal-head { background: #7a3a70; }
    body.night .calendar-day { background: #5a3a55; color: #ffc0f0; }
    body.night .shop-item, body.night .item-row { background: #4f2a4a; border-color: #aa7aa8; color: #ffe0f5; }
    body.night .empty-msg { color: #b890b0; }
    body.night .piggy-bank { background: #5a2e4a; border-color: #b27a9e; }
    body.night .saving-item { background: #4f2a4a; border-color: #aa7aa8; }

    /* å…¨å±ç‰¹æ•ˆå±‚ - ä¼˜åŒ–æµç•…åº¦ï¼Œå¢åŠ ç²’å­æ„Ÿ */
    .fullscreen-effect {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
      font-size: 60px;
      color: rgba(255,255,255,0.95);
      text-shadow: 0 0 30px gold, 0 0 60px orange, 0 0 90px hotpink;
      animation: effectFlash 1.2s ease-out forwards;
      backdrop-filter: blur(8px);
      line-height: 1;
      white-space: nowrap;
      will-change: transform, opacity;
    }
    .fullscreen-effect.epic {
      background: radial-gradient(circle, rgba(200,0,255,0.6) 0%, rgba(255,0,150,0.4) 40%, transparent 80%);
    }
    .fullscreen-effect.legend {
      background: radial-gradient(circle, rgba(255,215,0,0.8) 0%, rgba(255,0,200,0.6) 40%, rgba(0,200,255,0.4) 80%, transparent 100%);
      animation: effectSpin 1.2s ease-out;
    }
    @keyframes effectFlash {
      0% { opacity: 0; transform: scale(0.3) rotate(-10deg); filter: blur(10px); }
      50% { opacity: 1; transform: scale(1.2) rotate(3deg); filter: blur(0); }
      100% { opacity: 0; transform: scale(1.8) rotate(0deg); filter: blur(10px); }
    }
    @keyframes effectSpin {
      0% { opacity: 0; transform: rotate(0deg) scale(0.3); filter: blur(10px); }
      50% { opacity: 1; transform: rotate(180deg) scale(1.2); filter: blur(0); }
      100% { opacity: 0; transform: rotate(360deg) scale(1.8); filter: blur(10px); }
    }
    /* å‡çº§ä¸“ç”¨ç‰¹æ•ˆ - å¢å¼ºç‰ˆ */
    .level-up-banner {
      position: fixed;
      bottom: -200px;
      left: 5%;
      right: 5%;
      width: 90%;
      transform: translateX(0);
      background: linear-gradient(145deg, #ffd966, #ffb347);
      color: white;
      font-size: clamp(24px, 8vw, 48px);
      font-weight: bold;
      padding: 15px 20px;
      border-radius: 60px 60px 20px 20px;
      box-shadow: 0 0 40px gold;
      border: 5px solid white;
      z-index: 10001;
      transition: bottom 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      text-shadow: 0 5px 0 #b34180;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
    }
    .level-up-banner.show {
      bottom: 30px;
    }
    .confetti-rain {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10000;
      background: 
        repeating-linear-gradient(0deg, transparent, transparent 30px, rgba(255,215,0,0.4) 30px, rgba(255,215,0,0.4) 31px, transparent 31px, transparent 60px),
        repeating-linear-gradient(45deg, transparent, transparent 20px, rgba(255,255,255,0.3) 20px, rgba(255,255,255,0.3) 21px, transparent 21px, transparent 40px);
      background-size: 100% 60px, 200% 80px;
      animation: enhancedRain 1.8s linear forwards;
      opacity: 0;
    }
    @keyframes enhancedRain {
      0% { opacity: 0.9; background-position: 0 0, 0 0; }
      100% { opacity: 0; background-position: 0 200px, 200px 200px; }
    }

    /* åŠ¨ç”»åŒº */
    @keyframes glowPulse { 0% { box-shadow: 0 0 10px #ffb3d9, 0 0 20px #ffb3d9; } 50% { box-shadow: 0 0 22px #ff7bb5, 0 0 40px #ff7bb5; } 100% { box-shadow: 0 0 10px #ffb3d9, 0 0 20px #ffb3d9; } }
    @keyframes floatUp {
      0% { bottom: 20px; opacity: 1; transform: translateX(-50%) scale(1); }
      100% { bottom: 140%; opacity: 0; transform: translateX(-50%) scale(0.6); }
    }
    @keyframes coinSpin { 0% { transform: rotateY(0); } 50% { transform: rotateY(180deg); } 100% { transform: rotateY(0); } }
    @keyframes wobble { 0%,100% { transform: rotate(0deg); } 25% { transform: rotate(1.5deg); } 75% { transform: rotate(-1.5deg); } }
    /* å¼ºåŒ–ç‰ˆé£å…¥ç‰¹æ•ˆ - ä½¿ç”¨transform3dæå‡æ€§èƒ½ */
    @keyframes flyToAvatar {
      0% { transform: translate3d(0, 0, 0) scale(4) rotate(0deg); opacity: 1; filter: drop-shadow(0 0 30px gold) brightness(1.5); }
      30% { transform: translate3d(calc(var(--fly-x) * 0.3), calc(var(--fly-y) * 0.3), 0) scale(3) rotate(180deg); opacity: 1; filter: drop-shadow(0 0 40px orange) brightness(2); }
      70% { transform: translate3d(calc(var(--fly-x) * 0.7), calc(var(--fly-y) * 0.7), 0) scale(2) rotate(300deg); opacity: 0.9; filter: drop-shadow(0 0 30px yellow) brightness(1.8); }
      100% { transform: translate3d(var(--fly-x), var(--fly-y), 0) scale(0.3) rotate(360deg); opacity: 0; filter: drop-shadow(0 0 10px gold); }
    }
    .fly-item {
      position: fixed; z-index: 10000; font-size: 60px; filter: drop-shadow(0 0 15px gold);
      pointer-events: none; animation: flyToAvatar 0.8s ease-out forwards;
      text-shadow: 0 0 20px white;
      will-change: transform, opacity;
    }
    /* ç ¸ä¸­ç‰¹æ•ˆçˆ†ç‚¸ */
    .impact-boom {
      position: fixed; z-index: 9998; width: 150px; height: 150px; border-radius: 50%;
      background: radial-gradient(circle, rgba(255,255,255,0.9) 0%, rgba(255,200,0,0.8) 30%, transparent 70%);
      transform: translate(-50%, -50%) scale(1);
      animation: boomAnim 0.4s ease-out forwards;
      pointer-events: none;
    }
    @keyframes boomAnim {
      0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; filter: blur(2px); }
      100% { transform: translate(-50%, -50%) scale(3); opacity: 0; filter: blur(10px); }
    }

    /* ä¸»é¢æ¿ */
    .game-box {
      width: 100%;
      max-width: 520px;
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border-radius: var(--radius-xl);
      padding: 12px 16px;
      box-shadow: var(--shadow-soft), inset 0 0 0 3px rgba(255,255,255,0.9);
      border: 3px solid white;
      transition: var(--transition);
      height: 98vh;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--main-light) #ffe9f4;
    }
    .game-box::-webkit-scrollbar { width: 6px; }
    .game-box::-webkit-scrollbar-thumb { background: var(--main-light); border-radius: 30px; border: 2px solid white; }

    /* é¡¶éƒ¨æ  - çŒªçŒªå­˜é’±ç½ */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: -12px -16px 8px -16px;
      padding: 8px 16px;
      background: rgba(255, 220, 240, 0.85);
      backdrop-filter: blur(16px);
      border-radius: 0 0 var(--radius-lg) var(--radius-lg);
      box-shadow: 0 5px 15px rgba(255,150,200,0.25);
    }
    .play-time { background: linear-gradient(145deg, #ffb6d9, #ff8ec7); color: white; padding: 4px 12px; border-radius: var(--radius-full); font-size: 12px; font-weight: bold; box-shadow: 0 3px 0 #d46a9e; }
    .coin { background: #fff2dd; color: #b45f2b; padding: 4px 12px; border-radius: var(--radius-full); font-size: 14px; font-weight: bold; display: flex; align-items: center; gap: 4px; box-shadow: inset 0 -2px 0 #ffc285, 0 3px 6px rgba(0,0,0,0.05); }
    .coin.jump { animation: coinSpin 0.5s ease; }
    .piggy-bank {
      background: #ffe6f0;
      border-radius: var(--radius-full);
      padding: 4px 12px;
      font-size: 14px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 4px;
      box-shadow: 0 3px 0 #d46a9e;
      cursor: pointer;
      transition: var(--transition);
      border: 2px solid white;
    }
    .piggy-bank:hover { transform: translateY(-2px); box-shadow: 0 5px 0 #d46a9e; }
    .piggy-bank:active { transform: translateY(2px); box-shadow: 0 1px 0 #d46a9e; }

    /* å•†åº—ä»“åº“è¡Œ */
    .shop-row { display: flex; justify-content: flex-end; gap: 8px; margin-bottom: 6px; }
    .shop-row .mini-btn { padding: 4px 12px; font-size: 13px; }

    /* è§’è‰²å */
    .character-name { text-align: center; font-size: 28px; font-weight: 800; color: #b34180; text-shadow: 0 3px 6px #ffb3d9, 0 0 10px white; margin-bottom: 2px; letter-spacing: 1px; transform: rotate(-0.3deg); line-height: 1.2; animation: wobble 4s infinite ease-in-out; }
    .character-name small { font-size: 18px; color: #a64d79; text-shadow: 0 2px 4px #ff99cc; }

    /* å¤´åƒåŒº (æ— è¾¹æ¡†) */
    .avatar-wrap {
      display: flex;
      justify-content: center;
      margin: 0px 0 2px;
      position: relative;
      min-height: 150px;
    }
    .avatar-container {
      position: relative;
      width: 140px;
      height: 140px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .avatar {
      width: 130px;
      height: 130px;
      border-radius: 50%;
      overflow: hidden;
      cursor: pointer;
      position: relative;
      box-shadow: var(--shadow-glow);
      transition: 0.2s;
      z-index: 3;
      animation: bounce 4s infinite ease-in-out;
    }
    @keyframes bounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    .avatar:hover { transform: scale(1.03); animation: none; }
    .avatar img { width: 100%; height: 100%; object-fit: cover; }
    .avatar-ripple { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(1); width: 130px; height: 130px; border-radius: 50%; pointer-events: none; z-index: 2; background: radial-gradient(circle, rgba(255,200,235,0.9) 0%, rgba(255,140,200,0) 75%); filter: blur(8px); opacity: 0.6; transition: opacity 0.2s; animation: glowPulse 3s infinite ease-in-out; }
    .mood-emoji { position: absolute; top: -5px; right: -5px; font-size: 42px; filter: drop-shadow(0 4px 6px #ff99cc); z-index: 4; pointer-events: none; transition: 0.2s; }
    .wave-bar { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; height: 80px; z-index: 1; pointer-events: none; }
    .wave-bar canvas { width: 100%; height: 100%; border-radius: 50px; background: transparent; }

    .fixed-chat { text-align: center; min-height: 26px; font-size: 14px; color: var(--main-dark); font-weight: bold; margin: 2px auto 6px; text-shadow: 0 2px 4px white; background: rgba(255,255,255,0.5); border-radius: 50px; padding: 4px 14px; display: inline-block; width: fit-content; backdrop-filter: blur(4px); z-index: 5; position: relative; }
    .float-chat-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
    .float-chat {
      position: absolute;
      left: 50%;
      bottom: 25px;
      transform: translateX(-50%);
      background: #fff0f7;
      color: #a64d79;
      padding: 6px 16px;
      border-radius: 40px 40px 40px 8px;
      box-shadow: 0 5px 16px #ffb3d9;
      border: 2px solid white;
      font-size: 14px;
      animation: floatUp 4s forwards;
      white-space: nowrap;
      font-weight: bold;
    }

    /* å±æ€§é¢æ¿ - æ›´åœ†æ¶¦ */
    .attr-row { display: grid; grid-template-columns: repeat(5,1fr); gap: 4px; margin: 8px 0; }
    .attr-item { background: rgba(255,220,240,0.7); border-radius: var(--radius-md); padding: 6px 2px; text-align: center; border: 2px solid white; box-shadow: 0 4px 0 var(--main-light); transform: translateY(-2px); transition: var(--transition); backdrop-filter: blur(4px); position: relative; overflow: hidden; }
    .attr-item::after { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent); transition: left 0.5s; }
    .attr-item:hover::after { left: 100%; }
    .attr-item:hover { transform: translateY(-3px); box-shadow: 0 6px 0 var(--main-light); }
    .attr-item:active { transform: translateY(1px); box-shadow: 0 2px 0 var(--main-light); }
    .attr-icon { font-size: 18px; color: var(--main-color); margin-bottom: 2px; }
    .attr-num { font-size: 18px; font-weight: 800; color: #b34180; line-height: 1.1; }
    .attr-progress-wrap { height: 6px; background: #ffe2f0; border-radius: 20px; margin: 4px 4px 2px; overflow: hidden; border: 1px solid white; }
    .attr-progress { height: 100%; background: linear-gradient(90deg, var(--main-color), var(--second-color)); border-radius: 20px; transition: width 0.3s ease; }

    /* ç»éªŒæ¡ + ç­‰çº§ */
    .exp-section { display: flex; align-items: center; gap: 6px; margin: 6px 0 10px; background: rgba(255,255,255,0.5); border-radius: 50px; padding: 4px 10px; backdrop-filter: blur(4px); }
    .exp-label { font-size: 16px; font-weight: 800; color: #a64d79; white-space: nowrap; text-shadow: 0 2px 4px white; }
    .exp-bar-wrap { flex: 1; height: 16px; background: #ffe2f0; border-radius: 40px; border: 2px solid white; overflow: hidden; position: relative; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
    .exp-bar-fill { height: 100%; background: linear-gradient(90deg, #ffb3d9, #c480ff, #ffb3d9); background-size: 200% 100%; border-radius: 40px; transition: width 0.25s; box-shadow: 0 0 10px #ff99cc; animation: shimmer 2.2s infinite linear; }
    @keyframes shimmer { 0% { background-position: 0% 0; } 100% { background-position: 200% 0; } }
    .exp-text { font-size: 12px; color: #832b5c; margin-left: 4px; font-weight: bold; }

    /* ä¸»æŒ‰é’®åŒº */
    .main-btns { display: flex; flex-direction: column; gap: 6px; margin: 6px 0 8px; }
    .btn-row { display: flex; justify-content: center; gap: 8px; }
    .main-btn { background: linear-gradient(145deg, white, #fff5fa); border: 3px solid var(--main-light); border-radius: 60px; padding: 8px 0; font-size: 16px; font-weight: 800; color: #b34180; box-shadow: 0 5px 0 var(--main-light), 0 3px 8px rgba(255,120,180,0.3); cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 4px; flex: 0 1 auto; min-width: 90px; }
    .main-btn:hover { transform: translateY(-2px); box-shadow: 0 7px 0 var(--main-light), 0 5px 12px rgba(255,120,180,0.4); }
    .main-btn:active { transform: translateY(3px); box-shadow: 0 2px 0 var(--main-light); }
    .main-btn:disabled { opacity: 0.5; transform: translateY(2px); box-shadow: 0 3px 0 #b090a0; pointer-events: none; }

    /* åŠŸèƒ½å°æŒ‰é’® - æ–°å¢å¹¸è¿è½®ç›˜ */
    .func-row { display: flex; justify-content: center; gap: 6px; margin: 4px 0; flex-wrap: wrap; }
    .mini-btn { background: linear-gradient(145deg, #ffd9ec, #ffe4f0); border: 2px solid white; border-radius: 50px; padding: 4px 10px; font-size: 12px; color: #a64d79; font-weight: bold; box-shadow: 0 3px 0 #ff9ec7, 0 3px 6px rgba(255,150,200,0.2); cursor: pointer; transition: var(--transition); display: inline-flex; align-items: center; gap: 4px; }
    .mini-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 0 #ff9ec7, 0 4px 8px rgba(255,150,200,0.3); }
    .mini-btn:active { transform: translateY(2px); box-shadow: 0 1px 0 #ff9ec7; }

    /* åº•éƒ¨æ’­æ”¾å™¨ */
    .bottom-player { display: flex; align-items: center; justify-content: space-between; background: rgba(255,220,240,0.85); backdrop-filter: blur(16px); margin: 8px -16px -12px -16px; padding: 8px 16px; border-radius: var(--radius-lg) var(--radius-lg) 0 0; border-top: 3px solid white; }
    .now-playing { flex: 2; font-size: 12px; background: rgba(255,255,255,0.6); padding: 4px 10px; border-radius: 50px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #832b5c; font-weight: bold; border: 2px solid white; }
    .ctrl-group { display: flex; gap: 4px; align-items: center; }
    .ctrl-btn { background: white; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 18px; color: var(--main-color); box-shadow: 0 3px 0 var(--main-light), 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center; }
    .ctrl-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 0 var(--main-light); }
    .ctrl-btn:active { transform: translateY(2px); box-shadow: 0 1px 0 var(--main-light); }

    /* éšè—ä¸Šä¼ æ§ä»¶ */
    .upload-hide { display: none; }

    /* å¼¹çª— - ä¼˜åŒ–åŠ¨ç”» */
    .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.3); backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-box { background: #fff5fb; border-radius: 60px 60px 40px 40px; max-width: 480px; width: 94%; max-height: 82vh; overflow: hidden; box-shadow: 0 30px 50px #ff80b5, 0 10px 25px rgba(0,0,0,0.2); border: 5px solid white; animation: pop 0.35s cubic-bezier(0.34, 1.56, 0.64, 1); }
    @keyframes pop { 0%{transform:scale(0.6) rotate(-3deg); opacity:0;} 80%{transform:scale(1.02) rotate(1deg);} 100%{transform:scale(1) rotate(0); opacity:1;} }
    .modal-head { background: linear-gradient(145deg, var(--main-light), var(--main-color)); padding: 14px; font-size: 20px; font-weight: 800; color: white; text-align: center; position: relative; text-shadow: 0 2px 4px #b34180; }
    .modal-close { position: absolute; right: 14px; top: 10px; background: none; border: none; font-size: 32px; color: white; cursor: pointer; transition: 0.2s; }
    .modal-close:hover { transform: scale(1.15) rotate(5deg); }
    .modal-body { padding: 14px; overflow-y: auto; max-height: 62vh; }

    /* ç­¾åˆ°æ—¥å† */
    .calendar { display: grid; grid-template-columns: repeat(7,1fr); gap: 4px; text-align: center; margin: 14px 0; }
    .calendar-day { background: #ffe7f2; border-radius: 30px; padding: 6px 0; font-weight: bold; color: #b34180; border: 2px solid white; position: relative; transition: 0.15s; font-size: 13px; }
    .calendar-day:hover { transform: scale(1.04); background: #ffd9ec; box-shadow: 0 3px 0 #ff9ec7; }
    .calendar-day.signed { background: #b5e6b5; color: #1f6d1f; }
    .calendar-day.signed::after { content: "âœ”ï¸"; position: absolute; bottom: -4px; right: -4px; font-size: 14px; }
    .calendar-day.lucky { border: 4px solid #ffd966; box-shadow: 0 0 0 2px #ffb347; }
    .calendar-day.today { font-weight: 900; background: #ffd0e8; border: 3px solid #ff3388; }

    /* å•†åº—ç½‘æ ¼ - ç¨€æœ‰åº¦é¢œè‰²åŠ å¼º */
    .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .shop-item { background: white; border-radius: 30px; padding: 10px; border: 3px solid var(--main-light); box-shadow: 0 4px 0 var(--main-light); color: #2d1b2c; font-weight: 600; font-size: 12px; transition: var(--transition); }
    .shop-item.rare-0 { border-color: #9a8c98; } /* æ™®é€š */
    .shop-item.rare-1 { border-color: #4d9fff; } /* ç¨€æœ‰ */
    .shop-item.rare-2 { border-color: #c77dff; } /* å²è¯— */
    .shop-item.rare-3 { border-color: #ff9f4b; } /* ä¼ è¯´ */
    .shop-item:hover { transform: translateY(-2px); box-shadow: 0 6px 0 var(--main-light); }
    .shop-item.locked { opacity: 0.6; filter: grayscale(0.5); pointer-events: none; }
    .rare-tag { font-size: 10px; background: #aaa; color: white; padding: 2px 6px; border-radius: 30px; display: inline-block; margin-right: 4px; }
    .rare-0 .rare-tag { background: #9a8c98; }
    .rare-1 .rare-tag { background: #4d9fff; }
    .rare-2 .rare-tag { background: #c77dff; }
    .rare-3 .rare-tag { background: #ff9f4b; }

    /* ä»“åº“/åˆ—è¡¨æ ·å¼ */
    .item-row { display: flex; justify-content: space-between; align-items: center; background: white; border-radius: 50px; padding: 8px 12px; margin: 6px 0; border: 2px solid var(--main-light); color: #2d1b2c; font-size: 13px; transition: var(--transition); flex-wrap: wrap; }
    .item-row:hover { transform: translateY(-2px); box-shadow: 0 4px 0 var(--main-light); }
    .item-info { display: flex; flex-direction: column; gap: 2px; flex: 1; }
    .item-effects { font-size: 11px; color: #555; }
    .item-actions { display: flex; gap: 4px; }
    .empty-msg { text-align: center; padding: 20px; color: #a77a95; font-size: 16px; }

    /* ç‰¹æ•ˆé€‰æ‹©å™¨ - 5ä¸ª */
    .effect-option { display: inline-block; width: 70px; height: 70px; border-radius: 35px; margin: 8px; background: white; border: 3px solid white; box-shadow: 0 4px 8px rgba(0,0,0,0.1); cursor: pointer; transition: 0.15s; text-align: center; line-height: 70px; font-size: 30px; }
    .effect-option:hover { transform: scale(1.1) rotate(3deg); background: #ffe9f4; }

    /* å­˜é’±ç½å¼¹çª—æ ·å¼ - èµ·å­˜æ ‡è¯†å³ä¸Šè§’ */
    .saving-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .saving-min-note {
      background: #ffd9ec;
      border-radius: 30px;
      padding: 4px 12px;
      font-size: 12px;
      color: #b34180;
      font-weight: bold;
      border: 2px solid white;
    }
    .saving-option {
      background: white;
      border-radius: 40px;
      padding: 12px;
      margin: 8px 0;
      border: 3px solid var(--main-light);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .saving-period { font-weight: bold; color: #b34180; font-size: 16px; }
    .saving-rate { color: #28a745; font-weight: bold; }
    .saving-preview { font-size: 14px; background: #ffe9f4; border-radius: 30px; padding: 4px 8px; display: inline-block; margin-top: 4px; }
    .saving-actions { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .saving-actions input { width: 80px; border-radius: 30px; border: 2px solid var(--main-light); padding: 6px; text-align: center; }
    .saving-item {
      background: white;
      border-radius: 50px;
      padding: 8px 12px;
      margin: 6px 0;
      border: 2px solid var(--main-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .saving-progress { font-size: 12px; color: #555; }
    .saving-history {
      margin-top: 16px;
      border-top: 2px dashed var(--main-light);
      padding-top: 12px;
    }
    .saving-history h4 { margin-bottom: 8px; color: #b34180; }
    .history-item {
      background: #f9e6f0;
      border-radius: 30px;
      padding: 6px 12px;
      margin: 4px 0;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
    }

    /* å¹¸è¿è½®ç›˜æ ·å¼ - è±ªåå¯çˆ±ç‰ˆ */
    .wheel-info {
      background: #ffe9f4;
      border-radius: 40px;
      padding: 10px;
      margin-bottom: 12px;
      text-align: center;
      font-size: 14px;
      border: 2px solid white;
      box-shadow: 0 5px 0 #ff9ec7;
    }
    .wheel-container {
      position: relative;
      display: flex;
      justify-content: center;
      margin: 20px 0;
      cursor: grab;
      user-select: none;
    }
    .wheel-container:active {
      cursor: grabbing;
    }
    #wheelCanvas {
      width: 300px;
      height: 300px;
      border-radius: 50%;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2), 0 0 0 8px white, 0 0 0 12px #ffb3d9, 0 0 30px #ff85c0;
      border: 5px solid white;
      transition: box-shadow 0.2s;
    }
    #wheelCanvas:hover {
      box-shadow: 0 15px 35px rgba(255,120,180,0.4), 0 0 0 8px white, 0 0 0 12px #ff85c0, 0 0 40px #ff3388;
    }
    /* å†…ç½®æŒ‡é’ˆ - æ›´å¯çˆ± */
    .wheel-pointer {
      position: absolute;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 25px solid transparent;
      border-right: 25px solid transparent;
      border-top: 45px solid #ff3388;
      filter: drop-shadow(0 8px 0 #b34180) drop-shadow(0 0 8px gold);
      z-index: 10;
      pointer-events: none;
    }
    .wheel-pointer::after {
      content: 'âœ¨';
      position: absolute;
      top: -50px;
      left: -10px;
      font-size: 20px;
      color: gold;
      text-shadow: 0 0 5px white;
    }
    .spin-btn {
      display: block;
      margin: 10px auto;
      width: 150px;
      text-align: center;
      background: #ffb3d9;
      color: white;
      font-size: 16px;
      padding: 10px;
      border-radius: 60px;
      border: 3px solid white;
      box-shadow: 0 5px 0 #d46a9e;
      cursor: pointer;
      transition: 0.15s;
    }
    .spin-btn:active {
      transform: translateY(3px);
      box-shadow: 0 2px 0 #d46a9e;
    }
    .spin-btn.disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    .wheel-result {
      text-align: center;
      font-size: 16px;
      min-height: 30px;
      margin-top: 10px;
      background: #fff0f7;
      border-radius: 50px;
      padding: 8px;
      border: 2px solid white;
    }

    /* å…¶ä»–å°æ ·å¼ */
    .color-option { width: 45px; height: 45px; border-radius: 50%; display: inline-block; margin: 6px; border: 3px solid white; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: 0.15s; }
    .color-option:hover { transform: scale(1.12) rotate(6deg); }
    .bg-thumb {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 20px;
      border: 3px solid white;
      cursor: pointer;
      transition: 0.15s;
      background: #ffd9ec;
    }
    .bg-thumb:hover { transform: scale(1.08) rotate(2deg); border-color: #ff3388; }
    .bg-thumb img { width: 100%; height: 100%; object-fit: cover; border-radius: 20px; }
    .save-item { background: white; border-radius: 40px; padding: 8px 12px; margin: 6px 0; border: 2px solid var(--main-light); display: flex; justify-content: space-between; align-items: center; }
    .reset-btn { background: #ffb3b3; color: #a64d79; }
    .cost-highlight { color: #ff6f00; font-weight: 800; margin-left: 4px; }
  </style>
</head>
<body>
  <!-- å…¨å±ç‰¹æ•ˆå±‚ (ç”¨äºå²è¯—/ä¼ è¯´) -->
  <div id="fullscreenEffect" class="fullscreen-effect"></div>
  <!-- å‡çº§ä¸“ç”¨ç‰¹æ•ˆ -->
  <div id="levelUpBanner" class="level-up-banner">ğŸ“£âœ¨ å‡ çº§ å•¦ âœ¨ğŸ“£</div>
  <div id="confettiRain" class="confetti-rain"></div>

<div class="game-box">
  <!-- é¡¶éƒ¨æ  - çŒªçŒªå­˜é’±ç½ -->
  <div class="top-bar">
    <div class="play-time" id="playTime">é™ªä¼´æ—¶é—´ 00:00:00</div>
    <div style="display: flex; gap: 8px;">
      <div class="piggy-bank" onclick="playClickSound(); openSavingModal()">ğŸ· <span id="savingCount">0</span></div>
      <div class="coin" id="coinView"><span>ğŸ’°</span> <span id="coinAmount">0.0</span></div>
    </div>
  </div>

  <!-- å•†åº—ä»“åº“è¡Œ -->
  <div class="shop-row">
    <button class="mini-btn" onclick="playClickSound(); openShop()"><span>ğŸ›’</span> å•†åº—</button>
    <button class="mini-btn" onclick="playClickSound(); openStorage()"><span>ğŸ“¦</span> ä»“åº“</button>
  </div>

  <!-- è§’è‰²å -->
  <div class="character-name">èµ«èˆ <small>Hera</small></div>

  <!-- å¤´åƒåŒº (æ— è¾¹æ¡†) -->
  <div class="avatar-wrap">
    <div class="avatar-container" id="avatarContainer">
      <div class="wave-bar"><canvas id="waveCanvas" width="500" height="80"></canvas></div>
      <div class="avatar" id="avatarBox" title="ç‚¹æˆ‘èµšğŸ’°0.1" onclick="playClickSound()">
        <img id="avatarImg" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZmZjY2U1Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMjAiIGZpbGw9IiNiYjU1OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7H6Qp9PC90ZXh0Pjwvc3ZnPg==" alt="èµ«èˆ">
        <div id="floatChatContainer" class="float-chat-container"></div>
      </div>
      <div id="avatarRipple" class="avatar-ripple"></div>
      <div id="moodEmoji" class="mood-emoji">ğŸ˜Š</div>
    </div>
  </div>

  <!-- å›ºå®šå¯¹è¯ -->
  <div class="fixed-chat" id="log">âœ¨ æˆ³æˆ³å¤´åƒæœ‰æƒŠå–œ âœ¨</div>

  <!-- å±æ€§é¢æ¿ -->
  <div class="attr-row">
    <div class="attr-item"><div class="attr-icon">ğŸ˜Š</div><div class="attr-num" id="mood">0</div><div class="attr-progress-wrap"><div class="attr-progress" id="moodProgress" style="width:0%"></div></div></div>
    <div class="attr-item"><div class="attr-icon">âš¡</div><div class="attr-num" id="energy">0</div><div class="attr-progress-wrap"><div class="attr-progress" id="energyProgress" style="width:0%"></div></div></div>
    <div class="attr-item"><div class="attr-icon">ğŸ°</div><div class="attr-num" id="full">0</div><div class="attr-progress-wrap"><div class="attr-progress" id="fullProgress" style="width:0%"></div></div></div>
    <div class="attr-item"><div class="attr-icon">â¤ï¸</div><div class="attr-num" id="health">0</div><div class="attr-progress-wrap"><div class="attr-progress" id="healthProgress" style="width:0%"></div></div></div>
    <div class="attr-item"><div class="attr-icon">ğŸ’–</div><div class="attr-num" id="love">0</div><div class="attr-progress-wrap"><div class="attr-progress" id="loveProgress" style="width:0%"></div></div></div>
  </div>

  <!-- ç»éªŒæ¡ + ç­‰çº§ -->
  <div class="exp-section">
    <span class="exp-label">Lv.<span id="levelDisplay">1</span></span>
    <div class="exp-bar-wrap"><div class="exp-bar-fill" id="expBar" style="width:0%"></div></div>
    <span class="exp-text" id="expText">0/100</span>
  </div>

  <!-- ä¸»æŒ‰é’®åŒº -->
  <div class="main-btns">
    <div class="btn-row">
      <button class="main-btn" id="chatBtn" onclick="playClickSound(); chatTalk()"><span>ğŸ’¬</span> èŠå¤©</button>
      <button class="main-btn" onclick="playClickSound(); openEat()"><span>ğŸª</span> é›¶é£Ÿ</button>
      <button class="main-btn" onclick="playClickSound(); openPlay()"><span>ğŸ®</span> ç©è€</button>
    </div>
    <div class="btn-row">
      <button class="main-btn" id="restBtn" onclick="playClickSound(); doRest()"><span>ğŸ˜´</span> ä¼‘æ¯</button>
      <button class="main-btn" id="cleanBtn" onclick="playClickSound(); doClean()"><span>ğŸ§¹</span> æ¸…æ´</button>
    </div>
  </div>

  <!-- åŠŸèƒ½å°æŒ‰é’® - æ–°å¢å¹¸è¿è½®ç›˜ -->
  <div class="func-row">
    <button class="mini-btn" onclick="playClickSound(); openAvatarManager()"><span>ğŸ“¸</span> å¤´åƒ</button>
    <button class="mini-btn" onclick="playClickSound(); openSignModal()"><span>ğŸ“…</span> ç­¾åˆ°</button>
    <button class="mini-btn" onclick="playClickSound(); openMusicManager()"><span>ğŸµ</span> éŸ³ä¹åº“</button>
  </div>
  <div class="func-row">
    <button class="mini-btn" onclick="playClickSound(); openColorModal()"><span>ğŸ¨</span> è‰²ç³»</button>
    <button class="mini-btn" onclick="playClickSound(); toggleTheme()"><span>ğŸŒ™</span> å¤œé—´</button>
    <button class="mini-btn" onclick="playClickSound(); openEffectModal()"><span>âœ¨</span> ç‰¹æ•ˆ</button>
  </div>
  <div class="func-row">
    <button class="mini-btn" onclick="playClickSound(); openWheelModal()"><span>ğŸ°</span> å¹¸è¿æ‹‰ç›˜</button>
    <button class="mini-btn" onclick="playClickSound(); openSaveModal()"><span>ğŸ’¾</span> ä¿å­˜/å†å²</button>
  </div>

  <!-- åº•éƒ¨æ’­æ”¾å™¨ -->
  <div class="bottom-player">
    <div class="now-playing" id="nowPlaying">ğŸµ æœªæ’­æ”¾</div>
    <div class="ctrl-group">
      <button class="ctrl-btn" onclick="playClickSound(); prevMusic()"><span>â®ï¸</span></button>
      <button class="ctrl-btn" id="musicPlayPause" onclick="playClickSound(); toggleMusic()"><span>â–¶ï¸</span></button>
      <button class="ctrl-btn" onclick="playClickSound(); nextMusic()"><span>â­ï¸</span></button>
    </div>
  </div>

  <!-- éšè—ä¸Šä¼ æ§ä»¶ -->
  <input type="file" id="avatarInput" accept="image/*" class="upload-hide">
  <input type="file" id="musicInput" accept="audio/*" multiple class="upload-hide">
</div>

<!-- ========== å¼¹çª—åŒº ========== -->
<!-- å•†åº—å¼¹çª— -->
<div class="modal" id="shopModal"><div class="modal-box"><div class="modal-head">ğŸ­ èŒç‰©å•†åº— <button class="modal-close" onclick="closeModal('shopModal')">Ã—</button></div><div class="modal-body"><div class="shop-tabs" style="display:flex;gap:4px;margin-bottom:12px"><button class="mini-btn" onclick="showTab(0)">ğŸ¬é›¶é£Ÿ</button><button class="mini-btn" onclick="showTab(1)">ğŸ§¸ç©å…·</button><button class="mini-btn" onclick="showTab(2)">ğŸšä¸»é£Ÿ</button><button class="mini-btn" onclick="showTab(3)">ğŸ§´æ—¥ç”¨å“</button></div><div id="shopBody" class="shop-grid"></div></div></div></div>

<!-- ä»“åº“å¼¹çª— -->
<div class="modal" id="storModal"><div class="modal-box"><div class="modal-head">ğŸ“¦ å°ä»“åº“ <button class="modal-close" onclick="closeModal('storModal')">Ã—</button></div><div class="modal-body" id="storBody"></div></div></div>

<!-- é›¶é£Ÿå¼¹çª— -->
<div class="modal" id="eatModal"><div class="modal-box"><div class="modal-head">ğŸ° æŠ•å–‚æ—¶é—´ <button class="modal-close" onclick="closeModal('eatModal')">Ã—</button></div><div class="modal-body" id="eatBody"></div></div></div>

<!-- ç©è€å¼¹çª— -->
<div class="modal" id="playModal"><div class="modal-box"><div class="modal-head">ğŸª ä¸€èµ·ç©å§ <button class="modal-close" onclick="closeModal('playModal')">Ã—</button></div><div class="modal-body" id="playBody"></div></div></div>

<!-- ç­¾åˆ°å¼¹çª— -->
<div class="modal" id="signModal"><div class="modal-box"><div class="modal-head">ğŸ“† æ¯æ—¥ç­¾åˆ° <button class="modal-close" onclick="closeModal('signModal')">Ã—</button></div><div class="modal-body" id="signBody"></div></div></div>

<!-- éŸ³ä¹ç®¡ç†å¼¹çª— -->
<div class="modal" id="musicModal"><div class="modal-box"><div class="modal-head">ğŸµ éŸ³ä¹åº“ <button class="modal-close" onclick="closeModal('musicModal')">Ã—</button></div><div class="modal-body"><button class="mini-btn" onclick="addMusicFiles()" style="margin-bottom:12px">â• æ·»åŠ éŸ³ä¹</button><div id="musicList"></div></div></div></div>

<!-- å¤´åƒç®¡ç†å¼¹çª— (ä½¿ç”¨çœŸå®å›¾ç‰‡å¤´åƒ) -->
<div class="modal" id="avatarModal"><div class="modal-box"><div class="modal-head">ğŸ“¸ å¤´åƒæ¢è£… <button class="modal-close" onclick="closeModal('avatarModal')">Ã—</button></div><div class="modal-body">
  <button class="mini-btn" onclick="chooseAvatar()" style="margin-bottom:12px">ğŸ“¤ ä¸Šä¼ æ–°å¤´åƒ</button>
  <div style="margin:12px 0; font-size:16px;">âœ¨ å·²æœ‰å¤´åƒ âœ¨</div>
  <div class="media-grid" style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
    <div class="bg-thumb" onclick="setAvatarFromPreset('å‘è´¢åŠ¨æ€')"><img src="https://api.dicebear.com/7.x/adventurer/svg?seed=å‘è´¢åŠ¨æ€" alt="å‘è´¢åŠ¨æ€"></div>
    <div class="bg-thumb" onclick="setAvatarFromPreset('èˆèˆçˆªçˆª')"><img src="https://api.dicebear.com/7.x/adventurer/svg?seed=èˆèˆçˆªçˆª" alt="èˆèˆçˆªçˆª"></div>
    <div class="bg-thumb" onclick="setAvatarFromPreset('æ§çˆ±å¿ƒ')"><img src="https://api.dicebear.com/7.x/adventurer/svg?seed=æ§çˆ±å¿ƒ" alt="æ§çˆ±å¿ƒ"></div>
    <div class="bg-thumb" onclick="setAvatarFromPreset('çŒ«çˆªåŠ¨æ€')"><img src="https://api.dicebear.com/7.x/adventurer/svg?seed=çŒ«çˆªåŠ¨æ€" alt="çŒ«çˆªåŠ¨æ€"></div>
    <div class="bg-thumb" onclick="setAvatarFromPreset('æ­ªå¤´åå¥³ä»†ç‰ˆ')"><img src="https://api.dicebear.com/7.x/adventurer/svg?seed=æ­ªå¤´åå¥³ä»†ç‰ˆ" alt="æ­ªå¤´åå¥³ä»†ç‰ˆ"></div>
  </div>
  <div style="margin-top:12px; font-size:12px; color:#b34180;">ç‚¹å‡»å›¾ç‰‡å³å¯æ¢ä¸Šå¯¹åº”é£æ ¼å¤´åƒ</div>
  <div style="margin-top:16px; font-size:16px;">ğŸ“œ å†å²å¤´åƒ</div>
  <div id="avatarHistoryList" class="media-grid" style="margin-top:8px;"></div>
</div></div></div>

<!-- è‰²ç³»è®¾ç½®å¼¹çª— -->
<div class="modal" id="colorModal"><div class="modal-box"><div class="modal-head">ğŸ¨ ç‰ˆé¢è‰²ç³» <button class="modal-close" onclick="closeModal('colorModal')">Ã—</button></div><div class="modal-body"><div style="text-align:center;">
  <div class="color-option" style="background:#ff85c0;" onclick="setColorTheme('#ff85c0','#a975ff', 'æµªæ¼«ç²‰')"></div>
  <div class="color-option" style="background:#6a5acd;" onclick="setColorTheme('#6a5acd','#ffb6c1', 'æ¢¦å¹»ç´«')"></div>
  <div class="color-option" style="background:#20b2aa;" onclick="setColorTheme('#20b2aa','#ffdab9', 'æ¸…æ–°ç»¿')"></div>
  <div class="color-option" style="background:#ffa07a;" onclick="setColorTheme('#ffa07a','#dda0dd', 'æš–é˜³æ©™')"></div>
  <div class="color-option" style="background:#2c3e50;" onclick="setColorTheme('#2c3e50','#34495e', 'æ·±é‚ƒé»‘')"></div>
  <div class="color-option" style="background:#3498db;" onclick="setColorTheme('#3498db','#5dade2', 'æµ·æ´‹è“')"></div>
  <div style="margin-top:8px; font-size:14px;">ç‚¹å‡»è‰²å—åˆ‡æ¢ä¸»è‰²è°ƒ</div>
</div></div></div></div>

<!-- ç‰¹æ•ˆå¼¹çª— - 5ä¸ªç‰¹æ•ˆ (å…¨éƒ¨åŠ¨æ€) -->
<div class="modal" id="effectModal"><div class="modal-box"><div class="modal-head">âœ¨ é¢æ¿ç‰¹æ•ˆ <button class="modal-close" onclick="closeModal('effectModal')">Ã—</button></div><div class="modal-body" style="text-align:center;">
  <p style="margin-bottom:12px; font-size:14px;">5ç§åŠ¨æ€ç‰¹æ•ˆï¼Œç‚¹å‡»ä½¿ç”¨</p>
  <div>
    <div class="effect-option" onclick="selectEffect('cloud')">â˜ï¸</div>
    <div class="effect-option" onclick="selectEffect('stars')">âœ¨</div>
    <div class="effect-option" onclick="selectEffect('slash')">âš¡</div>
    <div class="effect-option" onclick="selectEffect('quicksand')">âŒ›</div>
    <div class="effect-option" onclick="selectEffect('meteor')">ğŸŒ </div>
  </div>
  <div style="margin-top:16px"><button class="mini-btn" onclick="clearEffect()">å…³é—­ç‰¹æ•ˆ</button></div>
</div></div></div>

<!-- å­˜é’±ç½å¼¹çª— (å«å†å²è®°å½•) åˆ©ç‡1%èµ· -->
<div class="modal" id="savingModal"><div class="modal-box"><div class="modal-head">ğŸ· çŒªçŒªå­˜é’±ç½ <button class="modal-close" onclick="closeModal('savingModal')">Ã—</button></div><div class="modal-body">
  <div class="saving-header">
    <span></span>
    <span class="saving-min-note">ğŸ’° 1000èµ·å­˜</span>
  </div>
  <div style="margin-bottom:16px; text-align:center;">
    <span class="mini-btn" onclick="showSavingTab('short')">çŸ­æœŸ</span>
    <span class="mini-btn" onclick="showSavingTab('mid')">ä¸­æœŸ</span>
    <span class="mini-btn" onclick="showSavingTab('long')">é•¿æœŸ</span>
  </div>
  <div id="savingOptions" style="margin-bottom:16px;"></div>
  <div id="activeSavings"></div>
  <div id="savingHistoryContainer" class="saving-history"></div>
</div></div></div>

<!-- å¹¸è¿è½®ç›˜å¼¹çª— (ä¸‹æ‹‰æ—‹è½¬) -->
<div class="modal" id="wheelModal"><div class="modal-box"><div class="modal-head">ğŸ° å¹¸è¿æ‹‰ç›˜ <button class="modal-close" onclick="closeModal('wheelModal')">Ã—</button></div><div class="modal-body">
  <div id="wheelInfo" class="wheel-info">åŠ è½½ä»Šæ—¥è¿åŠ¿...</div>
  <div class="wheel-container" id="wheelContainer">
    <canvas id="wheelCanvas" width="400" height="400"></canvas>
    <div class="wheel-pointer"></div>
  </div>
  <div id="wheelPullHint" style="text-align:center; font-size:12px; color:#b34180; margin-top:5px;">ğŸ‘‡ å‘ä¸‹æ‹‰åŠ¨è½®ç›˜å¼€å§‹æ—‹è½¬ï¼Œæ‹‰å¾—è¶Šå¿«è½¬å¾—è¶Šä¹…</div>
  <button class="spin-btn" id="spinWheelBtn" onclick="spinWheel()" style="display:none;">å¼€å§‹æ—‹è½¬</button>
  <div id="wheelResult" class="wheel-result"></div>
</div></div></div>

<!-- ç›²ç›’æ‰“å¼€å¼¹çª—ï¼ˆå¸¦æ›´æ¢é‡‘é¢ï¼‰ -->
<div class="modal" id="boxOpenModal"><div class="modal-box"><div class="modal-head">ğŸ æ­å–œå‡çº§ï¼ <button class="modal-close" onclick="closeBoxModal()">Ã—</button></div><div class="modal-body">
  <div style="text-align:center; font-size:18px; margin-bottom:10px;" id="boxLevelText">Lv.X</div>
  <div id="boxContent" class="box-content">â“</div>
  <div style="text-align:center; margin:8px;" id="boxItemName"></div>
  <div class="box-buttons" style="display:flex; justify-content:center; gap:16px; margin:16px 0;">
    <button class="mini-btn" id="boxConfirmBtn" onclick="boxConfirm()">âœ… ç¡®è®¤</button>
    <button class="mini-btn" id="boxReplaceBtn" onclick="boxReplace()">ğŸ”„ æ›´æ¢ <span id="replaceCostSpan" class="cost-highlight"></span></button>
  </div>
  <div style="text-align:center; font-size:12px; color:#b34180;">ğŸ’¡ æ›´æ¢è´¹ç”¨é€’å¢: 10Â·2â¿</div>
</div></div></div>

<!-- ç®€å•æç¤ºå¼¹çª— -->
<div class="modal" id="messageModal"><div class="modal-box"><div class="modal-head">ğŸ“¢ æç¤º <button class="modal-close" onclick="closeModal('messageModal')">Ã—</button></div><div class="modal-body" id="messageText" style="text-align:center; font-size:18px; padding:20px;"></div></div></div>

<!-- å†å²ä¿å­˜å¼¹çª— -->
<div class="modal" id="saveModal"><div class="modal-box"><div class="modal-head">ğŸ’¾ å†å²å­˜æ¡£ <button class="modal-close" onclick="closeModal('saveModal')">Ã—</button></div><div class="modal-body" style="text-align:center;"><button class="mini-btn" onclick="manualSave()" style="margin-bottom:12px">ğŸ“¥ ä¿å­˜å½“å‰è¿›åº¦</button><button class="mini-btn reset-btn" onclick="resetGame()" style="margin-bottom:12px">ğŸ”„ é‡ç½®æ¸¸æˆ</button><div id="saveList"></div></div></div></div>

<script>
// ====================== å®Œæ•´æ¸¸æˆé€»è¾‘ï¼ˆå«å¹¸è¿æ‹‰ç›˜ã€å­˜é’±åˆ©ç‡1%èµ·ã€çœŸå®å¤´åƒã€ç­¾åˆ°å¼¹çª—ã€æŒ‰é’®éŸ³æ•ˆï¼‰======================
const $ = id => document.getElementById(id);
const cap = (v, max, min = 0) => Math.max(min, Math.min(max, v));
const formatTime = ms => { let s = Math.floor(ms/1000); return `${Math.floor(s/3600).toString().padStart(2,'0')}:${Math.floor(s%3600/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; };
const rareText = ['æ™®é€š','ç¨€æœ‰','å²è¯—','ä¼ è¯´'];

// éŸ³æ•ˆç³»ç»Ÿ
let audioCtx = null;
function playClickSound() {
  try {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume().then(() => createSoftWarmClick());
    else createSoftWarmClick();
  } catch(e){}
}
function createSoftWarmClick() {
  const now = audioCtx.currentTime;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'sine';
  osc.frequency.value = 400;
  gain.gain.value = 0.08;
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start(now);
  gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
  osc.stop(now + 0.1);
}
function playImpactSound() {
  try {
    if (!audioCtx) audioCtx = new AudioContext();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const now = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'triangle';
    osc.frequency.value = 200;
    gain.gain.value = 0.15;
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(now);
    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
    osc.stop(now + 0.2);
  } catch(e){}
}
function playCuteLevelUpSound() {
  try {
    if (!audioCtx) audioCtx = new AudioContext();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const now = audioCtx.currentTime;
    const freqs = [523.25, 587.33, 659.25];
    freqs.forEach((f, i) => {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.value = f;
      gain.gain.value = 0.1;
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start(now + i * 0.1);
      gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.1 + 0.2);
      osc.stop(now + i * 0.1 + 0.2);
    });
  } catch(e){}
}

// ç‰¹æ•ˆ (5ç§)
let currentEffect = localStorage.getItem('currentEffect') || '';
function applyEffect(effect) {
  document.body.classList.remove('effect-cloud','effect-stars','effect-slash','effect-quicksand','effect-meteor');
  if (effect) { document.body.classList.add(`effect-${effect}`); currentEffect = effect; }
  else currentEffect = '';
  localStorage.setItem('currentEffect', currentEffect);
}
function clearEffect() { applyEffect(''); closeModal('effectModal'); }
function selectEffect(effect) { applyEffect(effect); closeModal('effectModal'); }
function openEffectModal() { openModal('effectModal'); }

// ========== å­˜é’±ç½ç³»ç»Ÿ (åˆ©ç‡1%èµ·) ==========
let savings = JSON.parse(localStorage.getItem('savings') || '[]');
let savingHistory = JSON.parse(localStorage.getItem('savingHistory') || '[]');

const rates = {
  '1d': 0.01,   // 1%
  '3d': 0.015,
  '7d': 0.02,
  '15d': 0.025,
  '1m': 0.03,
  '3m': 0.035,
  '6m': 0.04,
  '9m': 0.045,
  '12m': 0.05
};

function getTermText(term) {
  const map = {
    '1d':'1å¤©', '3d':'3å¤©', '7d':'7å¤©',
    '15d':'15å¤©', '1m':'1ä¸ªæœˆ', '3m':'3ä¸ªæœˆ',
    '6m':'6ä¸ªæœˆ', '9m':'9ä¸ªæœˆ', '12m':'1å¹´'
  };
  return map[term] || term;
}

function calculateInterest(amount, rate, days) {
  return amount * rate * (days / 365);
}

function getDays(term) {
  if (term === '1d') return 1;
  else if (term === '3d') return 3;
  else if (term === '7d') return 7;
  else if (term === '15d') return 15;
  else if (term === '1m') return 30;
  else if (term === '3m') return 90;
  else if (term === '6m') return 180;
  else if (term === '9m') return 270;
  else if (term === '12m') return 365;
  return 0;
}

function createSaving(amount, term) {
  let days = getDays(term);
  let rate = rates[term];
  let now = Date.now();
  let endTime = now + days * 24 * 60 * 60 * 1000;
  let saving = {
    amount: amount,
    startTime: now,
    endTime: endTime,
    rate: rate,
    term: term,
    termText: getTermText(term)
  };
  savings.push(saving);
  localStorage.setItem('savings', JSON.stringify(savings));
  return saving;
}

function checkMaturedSavings() {
  let now = Date.now();
  let matured = savings.filter(s => s.endTime <= now);
  if (matured.length > 0) {
    matured.forEach(s => {
      let days = (s.endTime - s.startTime) / (24*60*60*1000);
      let interest = calculateInterest(s.amount, s.rate, days);
      coin += s.amount + interest;
      savingHistory.push({
        time: new Date(s.endTime).toLocaleString(),
        amount: s.amount,
        interest: interest,
        term: s.termText
      });
      if (savingHistory.length > 20) savingHistory.shift();
      showLog(`ğŸ· å­˜é’±ç½åˆ°æœŸï¼šè·å¾—æœ¬é‡‘ ${s.amount.toFixed(1)}ğŸ’° + åˆ©æ¯ ${interest.toFixed(1)}ğŸ’° (${s.termText})`);
    });
    savings = savings.filter(s => s.endTime > now);
    localStorage.setItem('savings', JSON.stringify(savings));
    localStorage.setItem('savingHistory', JSON.stringify(savingHistory));
    updateSavingCount();
    updateUI();
    save();
  }
}
setInterval(checkMaturedSavings, 60000);

function updateSavingCount() {
  $('savingCount').innerText = savings.length;
}

function openSavingModal() {
  renderSavingOptions('short');
  renderActiveSavings();
  renderSavingHistory();
  openModal('savingModal');
}

function showSavingTab(type) {
  renderSavingOptions(type);
}

function renderSavingOptions(type) {
  let options = [];
  if (type === 'short') options = ['1d', '3d', '7d'];
  else if (type === 'mid') options = ['15d', '1m', '3m'];
  else if (type === 'long') options = ['6m', '9m', '12m'];
  let html = '';
  options.forEach(term => {
    let rate = (rates[term] * 100).toFixed(2);
    let days = getDays(term);
    html += `<div class="saving-option">
      <div><span class="saving-period">${getTermText(term)}</span> <span class="saving-rate">å¹´åŒ– ${rate}%</span></div>
      <div class="saving-actions">
        <input type="number" id="amount-${term}" min="1" value="1000" step="100" style="width:90px;"> ğŸ’°
        <button class="mini-btn" onclick="previewSaving('${term}')">é¢„è§ˆ</button>
        <button class="mini-btn" onclick="startSaving('${term}')">å­˜å…¥</button>
      </div>
      <div id="preview-${term}" class="saving-preview"></div>
    </div>`;
  });
  $('savingOptions').innerHTML = html;
}

function previewSaving(term) {
  playClickSound(); // æ·»åŠ éŸ³æ•ˆ
  let input = $(`amount-${term}`);
  let amount = parseFloat(input.value);
  if (isNaN(amount) || amount <= 0) { showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘å¸æ•°é‡'); return; }
  let days = getDays(term);
  let rate = rates[term];
  let interest = calculateInterest(amount, rate, days);
  let total = amount + interest;
  $(`preview-${term}`).innerHTML = `é¢„è®¡åˆ°æœŸæ€»é¢: ${total.toFixed(2)} ğŸ’° (åˆ©æ¯ ${interest.toFixed(2)})`;
}

function startSaving(term) {
  playClickSound(); // æ·»åŠ éŸ³æ•ˆ
  let input = $(`amount-${term}`);
  let amount = parseFloat(input.value);
  if (isNaN(amount) || amount <= 0) { showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘å¸æ•°é‡'); return; }
  if (amount > coin) { showMessage('é‡‘å¸ä¸è¶³'); return; }
  coin -= amount;
  createSaving(amount, term);
  updateUI(); save(); updateSavingCount();
  renderActiveSavings();
  $(`preview-${term}`).innerHTML = '';
  showMessage(`å­˜å…¥ ${amount}ğŸ’° åˆ° ${getTermText(term)} å­˜é’±ç½`);
}

function renderActiveSavings() {
  if (savings.length === 0) {
    $('activeSavings').innerHTML = '<div class="empty-msg">æš‚æ— è¿›è¡Œä¸­çš„å­˜é’±ç½</div>';
    return;
  }
  let html = '<h4 style="margin:10px 0;">è¿›è¡Œä¸­çš„å­˜é’±ç½</h4>';
  savings.forEach((s, idx) => {
    let now = Date.now();
    let remaining = Math.max(0, s.endTime - now);
    let daysLeft = Math.ceil(remaining / (24*60*60*1000));
    let hoursLeft = Math.ceil(remaining / (60*60*1000));
    let timeStr = daysLeft > 0 ? `${daysLeft}å¤©` : `${hoursLeft}å°æ—¶`;
    html += `<div class="saving-item">
      <span>ğŸ· ${s.amount}ğŸ’° (${s.termText})</span>
      <span class="saving-progress">å‰©ä½™ ${timeStr}</span>
    </div>`;
  });
  $('activeSavings').innerHTML = html;
}

function renderSavingHistory() {
  let historyEl = $('savingHistoryContainer');
  if (!savingHistory.length) {
    historyEl.innerHTML = '<h4>ğŸ“œ å†å²è®°å½•</h4><div class="empty-msg">æš‚æ— åˆ°æœŸè®°å½•</div>';
    return;
  }
  let html = '<h4>ğŸ“œ æœ€è¿‘åˆ°æœŸè®°å½•</h4>';
  savingHistory.slice().reverse().forEach(item => {
    html += `<div class="history-item"><span>${item.term} ${item.amount}ğŸ’°</span><span>+${item.interest.toFixed(1)}ğŸ’°</span><span>${item.time}</span></div>`;
  });
  historyEl.innerHTML = html;
}

// ========== å¹¸è¿è½®ç›˜ç³»ç»Ÿ (ä¸‹æ‹‰æ—‹è½¬) ==========
let wheelData = {
  lastSpinDate: '',
  spinsLeft: 1,
  luckyNumber: 7,
  luckyColor: '#ff85c0',
  luckyStar: 5,
  quote: ''
};
const quotes = [
  'å¿ƒæ€€å¸Œæœ›ï¼Œå¹¸è¿è‡ªæ¥ã€‚', 'æ¯ä¸€å¤©éƒ½æ˜¯æ–°çš„ç¤¼ç‰©ã€‚', 'ä½ çš„ç¬‘å®¹æ˜¯æœ€ç¾çš„é˜³å…‰ã€‚',
  'å°å°çš„å¹¸è¿ï¼Œå¤§å¤§çš„å¹¸ç¦ã€‚', 'åŠªåŠ›çš„äººæœ€å¹¸è¿ã€‚', 'ä¿æŒçƒ­çˆ±ï¼Œå¥”èµ´å±±æµ·ã€‚',
  'æ˜Ÿå…‰ä¸è´Ÿèµ¶è·¯äººã€‚', 'ä¸€åˆ‡éƒ½æ˜¯æœ€å¥½çš„å®‰æ’ã€‚', 'ä»Šå¤©ä¹Ÿæ˜¯å…ƒæ°”æ»¡æ»¡çš„ä¸€å¤©ï¼'
];
const wheelSegments = [
  { label: 'é‡‘å¸', color: '#FFD700', weight: 30, type: 'coin' },
  { label: 'ç»éªŒ', color: '#4d9fff', weight: 25, type: 'exp' },
  { label: 'é›¶é£Ÿ', color: '#ffb3d9', weight: 15, type: 'snack' },
  { label: 'ç©å…·', color: '#ffa07a', weight: 10, type: 'toy' },
  { label: 'æ—¥ç”¨å“', color: '#20b2aa', weight: 8, type: 'daily' },
  { label: 'ä¸»é£Ÿ', color: '#b87333', weight: 6, type: 'food' },
  { label: 'å²è¯—ç‰©å“', color: '#c77dff', weight: 4, type: 'epic' },
  { label: 'ä¼ è¯´ç‰©å“', color: '#ff9f4b', weight: 2, type: 'legend' }
];
let wheelCtx, wheelCanvas;
let isDragging = false;
let startY = 0;
let pullDistance = 0;
let rotationAngle = 0;
let spinVelocity = 0;
let spinAnimation = null;
let spinning = false;
let pullHint = '';

function initWheel() {
  wheelCanvas = $('wheelCanvas');
  if (!wheelCanvas) return;
  wheelCtx = wheelCanvas.getContext('2d');
  drawWheel(rotationAngle);
}

function drawWheel(rotateAngle = 0) {
  if (!wheelCtx) return;
  const ctx = wheelCtx;
  const canvas = wheelCanvas;
  const width = canvas.width, height = canvas.height;
  const centerX = width/2, centerY = height/2;
  const radius = Math.min(width, height) * 0.4;
  ctx.clearRect(0, 0, width, height);
  
  let totalWeight = wheelSegments.reduce((acc, seg) => acc + seg.weight, 0);
  let startAngle = rotateAngle;
  wheelSegments.forEach(seg => {
    let angle = (seg.weight / totalWeight) * 2 * Math.PI;
    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.arc(centerX, centerY, radius, startAngle, startAngle + angle);
    ctx.closePath();
    ctx.fillStyle = seg.color;
    ctx.fill();
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 2;
    ctx.stroke();
    // ç»˜åˆ¶æ–‡å­—
    ctx.save();
    ctx.translate(centerX, centerY);
    ctx.rotate(startAngle + angle/2);
    ctx.textAlign = 'center';
    ctx.font = 'bold 14px "M PLUS Rounded 1c", sans-serif';
    ctx.fillStyle = 'white';
    ctx.shadowColor = 'black';
    ctx.shadowBlur = 4;
    ctx.fillText(seg.label, radius * 0.7, 0);
    ctx.restore();
    startAngle += angle;
  });
}

function refreshWheelDaily() {
  let today = new Date().toDateString();
  if (wheelData.lastSpinDate !== today) {
    wheelData.lastSpinDate = today;
    wheelData.spinsLeft = 1;
    wheelData.luckyNumber = Math.floor(Math.random() * 10) + 1;
    wheelData.luckyColor = ['#ff85c0','#6a5acd','#20b2aa','#ffa07a','#2c3e50','#3498db'][Math.floor(Math.random()*6)];
    wheelData.luckyStar = Math.floor(Math.random() * 5) + 1;
    wheelData.quote = quotes[Math.floor(Math.random() * quotes.length)];
    localStorage.setItem('wheelData', JSON.stringify(wheelData));
  }
  updateWheelInfo();
}

function updateWheelInfo() {
  let starStr = 'â˜…'.repeat(wheelData.luckyStar) + 'â˜†'.repeat(5 - wheelData.luckyStar);
  $('wheelInfo').innerHTML = `ä»Šæ—¥å¹¸è¿æ•°å­—: ${wheelData.luckyNumber} | å¹¸è¿è‰²: <span style="color:${wheelData.luckyColor}">â—</span> | å¹¸è¿æ˜Ÿçº§: ${starStr}<br>âœ¨ ${wheelData.quote}`;
}

function openWheelModal() {
  refreshWheelDaily();
  initWheel();
  openModal('wheelModal');
  // ç»‘å®šä¸‹æ‹‰äº‹ä»¶
  let container = $('wheelContainer');
  container.addEventListener('mousedown', startDrag);
  container.addEventListener('mousemove', duringDrag);
  container.addEventListener('mouseup', endDrag);
  container.addEventListener('mouseleave', endDrag);
  // è§¦æ‘¸äº‹ä»¶
  container.addEventListener('touchstart', startDrag);
  container.addEventListener('touchmove', duringDrag);
  container.addEventListener('touchend', endDrag);
}

function startDrag(e) {
  if (spinning || wheelData.spinsLeft <= 0) return;
  e.preventDefault();
  isDragging = true;
  let clientY = e.clientY || (e.touches && e.touches[0].clientY);
  startY = clientY;
  pullDistance = 0;
  $('wheelPullHint').innerText = 'ğŸ‘‡ å‘ä¸‹æ‹‰...';
}

function duringDrag(e) {
  if (!isDragging) return;
  e.preventDefault();
  let clientY = e.clientY || (e.touches && e.touches[0].clientY);
  let deltaY = clientY - startY;
  if (deltaY < 0) deltaY = 0; // åªå…è®¸ä¸‹æ‹‰
  pullDistance = Math.min(deltaY, 300); // æœ€å¤§ä¸‹æ‹‰è·ç¦»300px
  $('wheelPullHint').innerText = `ä¸‹æ‹‰åŠ›: ${Math.floor(pullDistance/3)}%`;
}

function endDrag(e) {
  if (!isDragging || spinning) return;
  isDragging = false;
  if (pullDistance > 20) {
    // æ ¹æ®ä¸‹æ‹‰è·ç¦»è®¡ç®—åˆé€Ÿåº¦
    spinVelocity = pullDistance / 50; // é€Ÿåº¦å› å­
    spinning = true;
    wheelData.spinsLeft--;
    localStorage.setItem('wheelData', JSON.stringify(wheelData));
    updateWheelInfo();
    spinAnimation = requestAnimationFrame(spin);
  } else {
    $('wheelPullHint').innerText = 'ğŸ‘‡ å‘ä¸‹æ‹‰åŠ¨è½®ç›˜å¼€å§‹æ—‹è½¬';
  }
  pullDistance = 0;
}

function spin() {
  if (!spinning) return;
  rotationAngle += spinVelocity;
  spinVelocity *= 0.98; // å‡é€Ÿ
  drawWheel(rotationAngle);
  if (spinVelocity < 0.01) {
    // åœæ­¢ï¼Œè®¡ç®—é€‰ä¸­åŒºåŸŸ
    spinning = false;
    cancelAnimationFrame(spinAnimation);
    let totalWeight = wheelSegments.reduce((acc, seg) => acc + seg.weight, 0);
    let angle = rotationAngle % (2 * Math.PI);
    if (angle < 0) angle += 2 * Math.PI;
    let cumulative = 0;
    let selected = null;
    for (let seg of wheelSegments) {
      let segAngle = (seg.weight / totalWeight) * 2 * Math.PI;
      if (angle >= cumulative && angle < cumulative + segAngle) {
        selected = seg;
        break;
      }
      cumulative += segAngle;
    }
    if (!selected) selected = wheelSegments[0];
    giveWheelReward(selected);
    $('wheelPullHint').innerText = 'ğŸ‘‡ å‘ä¸‹æ‹‰åŠ¨è½®ç›˜å¼€å§‹æ—‹è½¬';
  } else {
    spinAnimation = requestAnimationFrame(spin);
  }
}

function giveWheelReward(segment) {
  let rewardText = '';
  let rareLevel = 0;
  if (segment.type === 'coin') {
    let amount = Math.floor(Math.random() * 50) + 30;
    coin += amount;
    rewardText = `è·å¾— ${amount}ğŸ’° é‡‘å¸`;
  } else if (segment.type === 'exp') {
    let amount = Math.floor(Math.random() * 100) + 50;
    addExp(amount);
    rewardText = `è·å¾— ${amount} ç»éªŒ`;
  } else if (segment.type === 'snack') {
    let possible = items.filter(i => i.type === 0 && i.rare === 0);
    let item = possible[Math.floor(Math.random() * possible.length)];
    addItemToStorage(item);
    rewardText = `è·å¾— ${item.name}`;
  } else if (segment.type === 'toy') {
    let possible = items.filter(i => i.type === 1 && i.rare === 0);
    let item = possible[Math.floor(Math.random() * possible.length)];
    addItemToStorage(item);
    rewardText = `è·å¾— ${item.name}`;
  } else if (segment.type === 'daily') {
    let possible = items.filter(i => i.type === 3 && i.rare === 0);
    let item = possible[Math.floor(Math.random() * possible.length)];
    addItemToStorage(item);
    rewardText = `è·å¾— ${item.name}`;
  } else if (segment.type === 'food') {
    let possible = items.filter(i => i.type === 2 && i.rare === 0);
    let item = possible[Math.floor(Math.random() * possible.length)];
    addItemToStorage(item);
    rewardText = `è·å¾— ${item.name}`;
  } else if (segment.type === 'epic') {
    let possible = items.filter(i => i.rare === 2);
    let item = possible[Math.floor(Math.random() * possible.length)];
    addItemToStorage(item);
    rewardText = `è·å¾—å²è¯—ç‰©å“ ${item.name}`;
    rareLevel = 2;
  } else if (segment.type === 'legend') {
    let possible = items.filter(i => i.rare === 3);
    let item = possible[Math.floor(Math.random() * possible.length)];
    addItemToStorage(item);
    rewardText = `è·å¾—ä¼ è¯´ç‰©å“ ${item.name}`;
    rareLevel = 3;
  }
  $('wheelResult').innerText = rewardText;
  // æ”¹ä¸ºå¼¹çª—æ˜¾ç¤ºï¼Œé¿å…è¿‡å¿«æ¶ˆå¤±
  showMessage(rewardText);
  if (rareLevel >= 2) {
    showFullscreenEffect(rareLevel);
  } else {
    let effectDiv = $('fullscreenEffect');
    effectDiv.className = 'fullscreen-effect';
    effectDiv.style.display = 'flex';
    effectDiv.innerText = 'ğŸ‰ æ­å–œ ğŸ‰';
    setTimeout(() => { effectDiv.style.display = 'none'; }, 800);
  }
  updateUI(); save();
}

function addItemToStorage(item) {
  let exist = storage.find(s => s.name === item.name);
  if (exist) exist.count++;
  else storage.push({ ...item, count: 1 });
}

// å†å²ä¿å­˜
let saveHistory = JSON.parse(localStorage.getItem('saveHistory') || '[]');
function renderSaveList() {
  let html = '';
  if (saveHistory.length === 0) html = '<div class="empty-msg">æš‚æ— å­˜æ¡£</div>';
  else saveHistory.forEach((item,index)=>{
    const date=new Date(item.timestamp);
    const timeStr=`${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2,'0')}`;
    html+=`<div class="save-item"><span class="save-time">${timeStr}</span><button class="mini-btn" onclick="confirmLoad(${index})">åŠ è½½</button></div>`;
  });
  if($('saveList')) $('saveList').innerHTML=html;
}
function manualSave() {
  const data={mood, energy, full, health, love, coin, level, exp, storage, boxReplaceCount, chatCD, restCD, cleanCD, lastDecay, savings, savingHistory, wheelData};
  saveHistory.unshift({timestamp:Date.now(), data});
  if(saveHistory.length>10) saveHistory.pop();
  localStorage.setItem('saveHistory', JSON.stringify(saveHistory));
  renderSaveList(); showMessage('è¿›åº¦å·²ä¿å­˜');
}
function confirmLoad(index) {
  if(confirm('ç¡®å®šè¦åŠ è½½è¿™ä¸ªå­˜æ¡£å—ï¼Ÿå½“å‰æœªä¿å­˜çš„è¿›åº¦ä¼šä¸¢å¤±ã€‚')){
    const item=saveHistory[index]; loadFromData(item.data); closeModal('saveModal'); showMessage('å­˜æ¡£åŠ è½½æˆåŠŸ');
  }
}
function loadFromData(data) {
  mood=data.mood??50; energy=data.energy??50; full=data.full??50; health=data.health??50; love=data.love??50;
  coin=data.coin??20; level=data.level??1; exp=data.exp??0; storage=data.storage??[];
  boxReplaceCount=data.boxReplaceCount??0; chatCD=data.chatCD??0; restCD=data.restCD??0; cleanCD=data.cleanCD??0; lastDecay=data.lastDecay??Date.now();
  savings=data.savings??[]; savingHistory=data.savingHistory??[]; wheelData=data.wheelData??{lastSpinDate:'',spinsLeft:1,luckyNumber:7,luckyColor:'#ff85c0',luckyStar:5,quote:''};
  updateMax(); updateUI(); save(); 
  $('chatBtn').innerText='ğŸ’¬ èŠå¤©'; $('restBtn').innerText='ğŸ˜´ ä¼‘æ¯'; $('cleanBtn').innerText='ğŸ§¹ æ¸…æ´';
  if(chatCD>Date.now()) startCDTimer('chatBtn',chatCD,'ğŸ’¬ èŠå¤©');
  if(restCD>Date.now()) startCDTimer('restBtn',restCD,'ğŸ˜´ ä¼‘æ¯');
  if(cleanCD>Date.now()) startCDTimer('cleanBtn',cleanCD,'ğŸ§¹ æ¸…æ´');
  updateSavingCount();
}
function openSaveModal() { renderSaveList(); openModal('saveModal'); }
function resetGame() {
  if(confirm('ç¡®å®šè¦é‡ç½®æ¸¸æˆå—ï¼Ÿæ‰€æœ‰æ•°æ®å°†æ¸…ç©ºï¼Œå›åˆ°åˆå§‹çŠ¶æ€ã€‚')) {
    localStorage.clear();
    location.reload();
  }
}
function showMessage(msg) { $('messageText').innerText = msg; openModal('messageModal'); }

// ç›²ç›’æ›´æ¢è®¡æ•°å™¨
let boxReplaceCount = parseInt(localStorage.getItem('boxReplaceCount') || '0');
let upgradeQueue = [];
let currentBoxItem = null;
let currentBoxIndex = -1;
let isCelebrating = false;

function closeBoxModal() { closeModal('boxOpenModal'); if (upgradeQueue.length) processNextUpgrade(); }

function processNextUpgrade() {
  if (!upgradeQueue.length) return;
  const next = upgradeQueue.shift(); currentBoxIndex = next.level;
  let possible = items.filter(item => item.rare <= 2 && item.price >= 5 && item.price <= 60);
  if (!possible.length) possible = items.filter(item => item.rare <= 2);
  currentBoxItem = { ...possible[Math.floor(Math.random() * possible.length)], isBox: true };
  $('boxLevelText').innerText = `Lv.${next.level}`;
  $('boxContent').innerText = currentBoxItem.name.charAt(0);
  $('boxItemName').innerHTML = currentBoxItem.name;
  let cost = 10 * Math.pow(2, boxReplaceCount);
  $('replaceCostSpan').innerText = cost + 'ğŸ’°';
  openModal('boxOpenModal');
}

function boxConfirm() {
  playClickSound(); // æ·»åŠ éŸ³æ•ˆ
  if (!currentBoxItem) return;
  let exist = storage.find(s => s.name === currentBoxItem.name && s.isBox);
  if (exist) exist.count++; else storage.push({ ...currentBoxItem, count: 1, isBox: true });
  if (currentBoxItem.rare >= 2) {
    showFullscreenEffect(currentBoxItem.rare);
  }
  showMessage(`è·å¾— ${currentBoxItem.name}`);
  currentBoxItem = null; closeBoxModal();
}

function boxReplace() {
  playClickSound(); // æ·»åŠ éŸ³æ•ˆ
  if (!currentBoxItem) return;
  let cost = 10 * Math.pow(2, boxReplaceCount);
  if (coin < cost) { showMessage(`ğŸ’° é‡‘å¸ä¸è¶³ï¼Œéœ€è¦${cost}é‡‘å¸`); return; }
  coin -= cost; boxReplaceCount++; localStorage.setItem('boxReplaceCount', boxReplaceCount);
  let possible = items.filter(item => item.rare <= 2 && item.price >= 5 && item.price <= 60);
  if (!possible.length) possible = items.filter(item => item.rare <= 2);
  currentBoxItem = { ...possible[Math.floor(Math.random() * possible.length)], isBox: true };
  $('boxContent').innerText = currentBoxItem.name.charAt(0);
  $('boxItemName').innerHTML = currentBoxItem.name;
  let newCost = 10 * Math.pow(2, boxReplaceCount);
  $('replaceCostSpan').innerText = newCost + 'ğŸ’°';
  showMessage(`èŠ±è´¹${cost}é‡‘å¸ï¼Œæ›´æ¢ä¸º ${currentBoxItem.name}`);
}

// å¼¹çª—æ§åˆ¶
function openModal(id) { $(id).style.display='flex'; document.body.classList.add('modal-open'); }
function closeModal(id) { $(id).style.display='none'; document.body.classList.remove('modal-open'); }
document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', e => { if(e.target===m) closeModal(m.id); }));

function showLog(s) { $('log').innerText = s; let bubble = document.createElement('div'); bubble.className = 'float-chat'; bubble.innerText = s; $('floatChatContainer').appendChild(bubble); setTimeout(() => bubble.remove(), 4000); }

function showFullscreenEffect(rare) {
  let effectDiv = $('fullscreenEffect');
  effectDiv.className = 'fullscreen-effect';
  if (rare === 2) effectDiv.classList.add('epic');
  else if (rare === 3) effectDiv.classList.add('legend');
  effectDiv.style.display = 'flex';
  effectDiv.innerText = rare === 3 ? 'âœ¨âœ¨ ä¼  è¯´ âœ¨âœ¨' : 'ğŸŒˆ å² è¯— ğŸŒˆ';
  effectDiv.offsetHeight;
  setTimeout(() => { effectDiv.style.display = 'none'; }, 1200);
}

function showLevelUpCelebration() {
  if (isCelebrating) return;
  isCelebrating = true;
  playCuteLevelUpSound();
  const banner = $('levelUpBanner');
  banner.classList.add('show');
  const rain = $('confettiRain');
  rain.style.opacity = '0.8';
  setTimeout(() => {
    banner.classList.remove('show');
    rain.style.opacity = '0';
    isCelebrating = false;
    if (upgradeQueue.length > 0) {
      processNextUpgrade();
    }
  }, 1500);
}

// é™ªä¼´æ—¶é—´
let startTime = parseInt(localStorage.startTime || Date.now());
function updatePlayTime() { $('playTime').innerText = 'é™ªä¼´æ—¶é—´ ' + formatTime(Date.now() - startTime); }
setInterval(updatePlayTime, 1000);

// å¤´åƒå†å²ä¸é¢„è®¾å¤´åƒ (ä½¿ç”¨çœŸå®å›¾ç‰‡)
let avatarHistory = JSON.parse(localStorage.avatarHistory || '[]');
function saveAvatarHistory() { localStorage.avatarHistory = JSON.stringify(avatarHistory); renderAvatarHistory(); }
function addAvatarToHistory(url) { avatarHistory = avatarHistory.filter(u => u !== url); avatarHistory.unshift(url); if (avatarHistory.length>5) avatarHistory.pop(); saveAvatarHistory(); }
function renderAvatarHistory() { let html=''; avatarHistory.forEach((url,i)=>{ html+=`<div style="position:relative; display:inline-block; margin:4px;"><img src="${url}" class="bg-thumb" onclick="setAvatarFromHistory('${url}')"><button class="mini-btn" style="position:absolute; top:-8px; right:-8px; padding:2px 6px;" onclick="removeAvatarHistory(${i})">âœ–</button></div>`; }); if($('avatarHistoryList')) $('avatarHistoryList').innerHTML = html || '<div class="empty-msg">æš‚æ— å†å²å¤´åƒ</div>'; }
function setAvatarFromHistory(url) { $('avatarImg').src = url; localStorage.avatar = url; addAvatarToHistory(url); showLog('å¤´åƒæ¢å¥½å•¦ âœ¨'); closeModal('avatarModal'); }
function removeAvatarHistory(i) { avatarHistory.splice(i,1); saveAvatarHistory(); }
function openAvatarManager() { renderAvatarHistory(); openModal('avatarModal'); }
function chooseAvatar() { $('avatarInput').onchange = e => { let file = e.target.files[0]; if (!file) return; if (file.size>15*1024*1024) { showLog('å›¾ç‰‡ä¸èƒ½è¶…è¿‡15MB'); return; } let reader = new FileReader(); reader.onload = ev => { let dataURL = ev.target.result; $('avatarImg').src = dataURL; localStorage.avatar = dataURL; addAvatarToHistory(dataURL); showLog('æ–°å¤´åƒæ¢ä¸Šå•¦ âœ¨'); closeModal('avatarModal'); }; reader.readAsDataURL(file); }; $('avatarInput').click(); }
function setAvatarFromPreset(style) {
  let url = `https://api.dicebear.com/7.x/adventurer/svg?seed=${encodeURIComponent(style)}`;
  $('avatarImg').src = url;
  localStorage.avatar = url;
  addAvatarToHistory(url);
  showLog(`æ¢ä¸Š ${style} å¤´åƒ âœ¨`);
  closeModal('avatarModal');
}

// éŸ³ä¹ç³»ç»Ÿ (ä¼˜åŒ–æ€§èƒ½)
let musicList = JSON.parse(localStorage.musicList || '[]');
let currentMusicIndex = parseInt(localStorage.currentMusicIndex || '0');
let bgm = new Audio(); bgm.volume = 0.6; bgm.loop = false;
let audioCtxMusic, analyser, source, canvasCtx;
let rippleDiv = $('avatarRipple');
let animationFrame = null;
function initAudioVisualizer() { if (!audioCtxMusic) { audioCtxMusic = new AudioContext(); analyser = audioCtxMusic.createAnalyser(); analyser.fftSize = 128; source = audioCtxMusic.createMediaElementSource(bgm); source.connect(analyser); analyser.connect(audioCtxMusic.destination); canvasCtx = $('waveCanvas').getContext('2d'); drawWaveAndRipple(); } }
function drawWaveAndRipple() {
  if (!analyser) return;
  const bufferLength = analyser.frequencyBinCount;
  const dataArray = new Uint8Array(bufferLength);
  const draw = () => {
    if (!bgm.paused && audioCtxMusic && audioCtxMusic.state === 'running') analyser.getByteFrequencyData(dataArray);
    else dataArray.fill(0);
    const canvas = $('waveCanvas');
    const width = canvas.width;
    const height = canvas.height;
    canvasCtx.clearRect(0, 0, width, height);
    const barWidth = (width / bufferLength) * 2.5;
    let x = 0;
    const gradient = canvasCtx.createLinearGradient(0,0,width,0);
    gradient.addColorStop(0,'#ff99cc');
    gradient.addColorStop(0.5,'#a975ff');
    gradient.addColorStop(1,'#ff99cc');
    for (let i=0; i<bufferLength; i++) {
      let barHeight = (dataArray[i]/255)*height*0.9;
      canvasCtx.fillStyle = gradient;
      canvasCtx.fillRect(x, height-barHeight, barWidth-1, barHeight);
      x += barWidth;
    }
    let avg=0;
    for (let i=0; i<bufferLength; i++) avg+=dataArray[i];
    avg/=bufferLength;
    if (!bgm.paused && audioCtxMusic && audioCtxMusic.state==='running') {
      let scale=1+avg/100;
      let opacity=0.5+avg/200;
      rippleDiv.style.transform = `translate(-50%, -50%) scale(${scale})`;
      rippleDiv.style.opacity = opacity;
    } else {
      rippleDiv.style.transform = `translate(-50%, -50%) scale(1)`;
      rippleDiv.style.opacity = 0.6;
    }
    animationFrame = requestAnimationFrame(draw);
  };
  if (animationFrame) cancelAnimationFrame(animationFrame);
  animationFrame = requestAnimationFrame(draw);
}
function updateMusicUI() { let name='ğŸµ æœªæ’­æ”¾'; if (musicList.length && musicList[currentMusicIndex]) name='ğŸµ '+musicList[currentMusicIndex].name.substring(0,18); $('nowPlaying').innerText = name; $('musicPlayPause').innerHTML = bgm.paused ? 'â–¶ï¸' : 'â¸ï¸'; renderMusicList(); }
function playMusic(i) { if (!musicList.length) return; currentMusicIndex = (i+musicList.length)%musicList.length; localStorage.currentMusicIndex = currentMusicIndex; bgm.src = musicList[currentMusicIndex].url; bgm.load(); bgm.play().then(()=>{ if (!audioCtxMusic) initAudioVisualizer(); if (audioCtxMusic.state==='suspended') audioCtxMusic.resume(); }).catch(()=>showLog('ç‚¹å‡»é¡µé¢æ‰èƒ½æ’­æ”¾éŸ³ä¹')); updateMusicUI(); }
function toggleMusic() { if (!musicList.length) { showLog('å…ˆå»éŸ³ä¹åº“æ·»åŠ éŸ³ä¹å§'); return; } if (bgm.paused) { if (!bgm.src) playMusic(currentMusicIndex); else bgm.play(); } else bgm.pause(); updateMusicUI(); }
function prevMusic() { if (musicList.length) playMusic(currentMusicIndex-1); }
function nextMusic() { if (musicList.length) playMusic(currentMusicIndex+1); }
bgm.onended = nextMusic; bgm.onplay = updateMusicUI; bgm.onpause = updateMusicUI;
function addMusicFiles() { $('musicInput').onchange = e => { Array.from(e.target.files).forEach(f => { if (f.size > 20*1024*1024) { showLog(f.name+' è¶…è¿‡20MB'); return; } let reader = new FileReader(); reader.onload = ev => { musicList.push({ name: f.name, url: ev.target.result }); localStorage.musicList = JSON.stringify(musicList); updateMusicUI(); }; reader.readAsDataURL(f); }); }; $('musicInput').click(); }
function removeMusic(i) { if (currentMusicIndex===i) { bgm.pause(); bgm.src=''; } musicList.splice(i,1); localStorage.musicList = JSON.stringify(musicList); currentMusicIndex = cap(currentMusicIndex, musicList.length-1); localStorage.currentMusicIndex = currentMusicIndex; updateMusicUI(); }
function moveMusic(i,d) { let j=i+d; if(j<0||j>=musicList.length) return; [musicList[i], musicList[j]]=[musicList[j], musicList[i]]; if (currentMusicIndex===i) currentMusicIndex=j; else if (currentMusicIndex===j) currentMusicIndex=i; localStorage.musicList=JSON.stringify(musicList); localStorage.currentMusicIndex=currentMusicIndex; updateMusicUI(); }
function renderMusicList() { let html=''; if (!musicList.length) html='<div class="empty-msg">æš‚æ— éŸ³ä¹ï¼Œç‚¹å‡»ä¸Šæ–¹æ·»åŠ ï½</div>'; else { musicList.forEach((m,idx)=>{ let playing=(!bgm.paused && currentMusicIndex===idx); html+=`<div class="item-row"><span><b>${playing?'ğŸ”Š ':''}${m.name}</b></span><div><button class="mini-btn" onclick="moveMusic(${idx},-1)">â¬†ï¸</button><button class="mini-btn" onclick="moveMusic(${idx},1)">â¬‡ï¸</button><button class="mini-btn" onclick="playMusic(${idx})">${playing?'â¸ï¸':'â–¶ï¸'}</button><button class="mini-btn" onclick="removeMusic(${idx})">âŒ</button></div></div>`; }); } $('musicList').innerHTML=html; }
function openMusicManager() { updateMusicUI(); openModal('musicModal'); }

// æ ¸å¿ƒæ¸¸æˆæ•°æ®
let mood=50, energy=50, full=50, health=50, love=50, coin=20;
let maxMood=100, maxEnergy=100, maxFull=100, maxHealth=100, maxLove=100;
let level=1, exp=0, storage=[];
let chatCD=0, restCD=0, cleanCD=0;
let lastDecay=Date.now();
function expNeed() { return Math.floor(100 * Math.pow(1.6, level-1)); }
function updateMax() { maxMood = maxEnergy = maxFull = maxHealth = maxLove = 100 + level*10; }
function updateUI() { $('mood').innerText=mood; $('energy').innerText=energy; $('full').innerText=full; $('health').innerText=health; $('love').innerText=love; $('coinAmount').innerText=coin.toFixed(1); $('levelDisplay').innerText=level; let need=expNeed(); $('expBar').style.width=(exp/need*100)+'%'; $('expText').innerText=`${exp}/${need}`; ['mood','energy','full','health','love'].forEach(a=>{ let el=$(a+'Progress'); if (el) el.style.width=(eval(a)/eval('max'+a.charAt(0).toUpperCase()+a.slice(1))*100)+'%'; }); updateMoodEmoji(); }
function updateMoodEmoji() { let emoji='ğŸ˜Š'; if (health<30) emoji='ğŸ˜·'; else if (mood<30) emoji='ğŸ˜¢'; else if (energy<20) emoji='ğŸ˜´'; else if (mood>80) emoji='ğŸ˜†'; else if (love>80) emoji='ğŸ¥°'; $('moodEmoji').innerText=emoji; }
function formatRemainTime(ms) { let s=Math.floor(ms/1000); if (s<60) return s+'s'; if (s<3600) return Math.floor(s/60)+'m'+(s%60)+'s'; return Math.floor(s/3600)+'h'+Math.floor((s%3600)/60)+'m'; }
let cdIntervals={};
function startCDTimer(btnId, endTime, originalText) { if (cdIntervals[btnId]) clearInterval(cdIntervals[btnId]); let btn=$(btnId); if (!btn) return; btn.disabled=true; cdIntervals[btnId]=setInterval(()=>{ let remain=endTime-Date.now(); if (remain<=0) { clearInterval(cdIntervals[btnId]); btn.disabled=false; btn.innerText=originalText; } else btn.innerText=originalText+' ('+formatRemainTime(remain)+')'; },1000); }
const chatMessages = ['ğŸ’¬ èŠå¾—å¥½å¼€å¿ƒ +10ğŸ˜Š +5ğŸ’–','ğŸ’¬ èµ«èˆè®²äº†ä¸ªç¬‘è¯ +8ğŸ˜Š +3ğŸ’–','ğŸ’¬ èŠèµ·æ˜Ÿæ˜Ÿ +12ğŸ˜Š +6ğŸ’–','ğŸ’¬ èµ«èˆåˆ†äº«è¶£äº‹ +9ğŸ˜Š +4ğŸ’–','ğŸ’¬ ä½ å®‰æ…°äº†èµ«èˆ +15ğŸ˜Š +8ğŸ’–','ğŸ’¬ ä¸€èµ·å”±æ­Œ +10ğŸ˜Š +5ğŸ’–','ğŸ’¬ ç§˜å¯† +7ğŸ˜Š +7ğŸ’–'];
function chatTalk() { if (chatCD > Date.now()) return; mood=cap(mood+10,maxMood); love=cap(love+5,maxLove); chatCD=Date.now()+30000; addExp(52); const randomMsg=chatMessages[Math.floor(Math.random()*chatMessages.length)]; showLog(randomMsg); updateUI(); save(); startCDTimer('chatBtn', chatCD, 'ğŸ’¬ èŠå¤©'); }
function doRest() { if (restCD>Date.now()) return; health=cap(health+Math.floor(maxHealth*0.3),maxHealth); energy=cap(energy+Math.floor(maxEnergy*0.5),maxEnergy); restCD=Date.now()+12*3600000; addExp(520); showLog('ğŸ˜´ ç¾ç¾ç¡äº†ä¸€è§‰ +â¤ï¸30% +âš¡50%'); updateUI(); save(); startCDTimer('restBtn', restCD, 'ğŸ˜´ ä¼‘æ¯'); }
function doClean() { if (cleanCD>Date.now()) return; health=cap(health+Math.floor(maxHealth*0.3),maxHealth); mood=cap(mood+Math.floor(maxMood*0.1),maxMood); cleanCD=Date.now()+24*3600000; addExp(300); showLog('ğŸ§¹ æ´—é¦™é¦™ï½å¥åº·+30% å¿ƒæƒ…+10%'); updateUI(); save(); startCDTimer('cleanBtn', cleanCD, 'ğŸ§¹ æ¸…æ´'); }
function addExp(n) {
  exp+=n;
  let leveledLevels=[];
  while (exp>=expNeed()) {
    exp-=expNeed();
    level++;
    leveledLevels.push(level);
    mood=cap(Math.floor(mood*1.3),maxMood);
    energy=cap(Math.floor(energy*1.3),maxEnergy);
    full=cap(Math.floor(full*1.3),maxFull);
    health=cap(Math.floor(health*1.3),maxHealth);
    love=cap(Math.floor(love*1.3),maxLove);
    coin+=20;
    updateMax();
  }
  if (leveledLevels.length > 0) {
    leveledLevels.forEach(lvl=>upgradeQueue.push({level:lvl}));
    if (!isCelebrating && $('boxOpenModal').style.display !== 'flex') {
      showLevelUpCelebration();
    }
  }
  updateUI();
  save();
}
$('avatarBox').addEventListener('click', ()=>{ playClickSound(); coin=Number((coin+0.1).toFixed(1)); showLog('ğŸ’° +0.1 é‡‘å¸'); $('coinView').classList.add('jump'); setTimeout(()=>$('coinView').classList.remove('jump'),500); addExp(1); updateUI(); save(); });
function decay() { let now=Date.now(); if (now-lastDecay>=60000) { mood=cap(mood-1,maxMood,0); energy=cap(energy-1,maxEnergy,0); full=cap(full-1,maxFull,0); health=cap(health-1,maxHealth,0); love=cap(love-1,maxLove,0); lastDecay=now; updateUI(); save(); } }
setInterval(decay,1000);

// ========== å®Œæ•´å•†å“åˆ—è¡¨ (å®Œæ•´ä¿ç•™) ==========
const items = [
  // é›¶é£Ÿ type0
  { name:'ğŸ“è‰è“ç‰›å¥¶', price:3, type:0, mood:4, full:2, rare:0, levelUnlock:0 },
  { name:'ğŸŸè–¯ç‰‡', price:5, type:0, mood:5, full:3, health:-2, rare:0, levelUnlock:0 },
  { name:'ğŸ«å·§å…‹åŠ›', price:8, type:0, mood:8, full:2, health:-1, rare:0, levelUnlock:0 },
  { name:'ğŸ¬å½©è™¹ç³–', price:3, type:0, mood:4, full:1, rare:0, levelUnlock:0 },
  { name:'ğŸªå°ç†Šé¥¼å¹²', price:6, type:0, mood:4, full:4, rare:0, levelUnlock:0 },
  { name:'ğŸ­æ³¢æ¿ç³–', price:4, type:0, mood:5, full:1, rare:0, levelUnlock:0 },
  { name:'ğŸ§ç»µç»µå†°', price:7, type:0, mood:7, full:2, health:-1, rare:0, levelUnlock:0 },
  { name:'ğŸ®å¸ƒä¸', price:5, type:0, mood:6, full:1, rare:0, levelUnlock:0 },
  { name:'ğŸ©ç”œç”œåœˆ', price:6, type:0, mood:6, full:3, rare:0, levelUnlock:0 },
  { name:'ğŸ¿çˆ†ç±³èŠ±', price:4, type:0, mood:4, full:2, rare:0, levelUnlock:0 },
  { name:'ğŸ‚è‰è“è›‹ç³•', price:15, type:0, mood:12, full:6, health:-3, rare:1, levelUnlock:3 },
  { name:'ğŸ¦å†°æ·‡æ·‹', price:9, type:0, mood:7, full:3, health:-2, rare:1, levelUnlock:0 },
  { name:'ğŸ­å½©è™¹æ£’æ£’ç³–', price:12, type:0, mood:10, full:2, rare:1, levelUnlock:2 },
  { name:'ğŸ°ææ‹‰ç±³è‹', price:18, type:0, mood:14, full:5, health:-2, rare:1, levelUnlock:4 },
  { name:'ğŸ§çº¸æ¯è›‹ç³•', price:10, type:0, mood:9, full:3, rare:1, levelUnlock:1 },
  { name:'â˜ï¸æ£‰èŠ±ç³–äº‘', price:25, type:0, mood:20, full:3, rare:2, levelUnlock:8 },
  { name:'ğŸŒŒæ˜Ÿç©ºå¥¶èŒ¶', price:35, type:0, mood:25, full:5, health:2, rare:2, levelUnlock:12 },
  { name:'ğŸ¨åœ£ä»£', price:30, type:0, mood:22, full:4, health:-1, rare:2, levelUnlock:10 },
  { name:'ğŸ‘‘å…¬ä¸»è›‹ç³•å¡”', price:88, type:0, mood:50, full:10, health:5, rare:3, levelUnlock:20 },
  { name:'ğŸ¾é¦™æ§Ÿæœå†»', price:68, type:0, mood:45, full:6, health:4, rare:3, levelUnlock:18 },
  // ç©å…· type1
  { name:'ğŸ§¸æ¯›ç»’å°ç†Š', price:39, type:1, mood:15, love:10, rare:1, levelUnlock:3 },
  { name:'ğŸª„é­”æ³•æ£’', price:45, type:1, mood:20, love:15, rare:2, levelUnlock:8 },
  { name:'ğŸ‘—æ´›ä¸½å¡”è£™å­', price:68, type:1, mood:25, love:20, rare:2, levelUnlock:12 },
  { name:'ğŸ»â€â„ï¸å·¨å¤§æ¯›ç»’ç†Š', price:128, type:1, mood:40, love:35, rare:3, levelUnlock:18 },
  { name:'ğŸ°åŸå ¡ç§¯æœ¨', price:198, type:1, mood:60, love:50, rare:3, levelUnlock:25 },
  { name:'ğŸš—å°æ±½è½¦', price:8, type:1, mood:5, love:2, rare:0, levelUnlock:0 },
  { name:'ğŸª€æ‚ æ‚ çƒ', price:6, type:1, mood:6, love:1, rare:0, levelUnlock:0 },
  { name:'ğŸ§©æ‹¼å›¾', price:12, type:1, mood:8, love:5, rare:0, levelUnlock:0 },
  { name:'ğŸˆæ°”çƒ', price:4, type:1, mood:7, love:2, rare:0, levelUnlock:0 },
  { name:'ğŸª†å¥—å¨ƒ', price:15, type:1, mood:10, love:6, rare:0, levelUnlock:0 },
  { name:'ğŸ¤–æœºå™¨äºº', price:20, type:1, mood:12, love:8, rare:0, levelUnlock:0 },
  { name:'ğŸ¨ç”»æ¿', price:18, type:1, mood:14, love:7, rare:0, levelUnlock:0 },
  { name:'ğŸ“šç»˜æœ¬', price:10, type:1, mood:9, love:4, rare:0, levelUnlock:0 },
  { name:'ğŸ¥å°é¼“', price:16, type:1, mood:13, love:5, rare:0, levelUnlock:0 },
  { name:'ğŸªé£ç­', price:14, type:1, mood:11, love:3, rare:0, levelUnlock:0 },
  { name:'ğŸ´æ‘‡æ‘‡é©¬', price:28, type:1, mood:18, love:12, rare:1, levelUnlock:2 },
  { name:'ğŸ­é¢å…·', price:32, type:1, mood:20, love:14, rare:1, levelUnlock:4 },
  { name:'ğŸªå¸ç¯·', price:42, type:1, mood:22, love:18, rare:1, levelUnlock:6 },
  { name:'ğŸ›¼è½®æ»‘é‹', price:36, type:1, mood:19, love:16, rare:1, levelUnlock:5 },
  { name:'ğŸ¬æ”¾æ˜ æœº', price:55, type:1, mood:28, love:24, rare:1, levelUnlock:7 },
  // ä¸»é£Ÿ type2
  { name:'ğŸšç™½ç±³é¥­', price:3, type:2, full:10, rare:0, levelUnlock:0 },
  { name:'ğŸ¥ç‰›è§’åŒ…', price:4, type:2, full:12, rare:0, levelUnlock:0 },
  { name:'ğŸœæ‹‰é¢', price:6, type:2, full:15, rare:0, levelUnlock:0 },
  { name:'ğŸåå¸', price:3, type:2, full:8, rare:0, levelUnlock:0 },
  { name:'ğŸ¥Ÿé¥ºå­', price:5, type:2, full:14, rare:0, levelUnlock:0 },
  { name:'ğŸ™é¥­å›¢', price:4, type:2, full:11, rare:0, levelUnlock:0 },
  { name:'ğŸæ„é¢', price:7, type:2, full:18, rare:0, levelUnlock:0 },
  { name:'ğŸ²ç²¥', price:3, type:2, full:9, rare:0, levelUnlock:0 },
  { name:'ğŸ¥ªä¸‰æ˜æ²»', price:6, type:2, full:16, rare:0, levelUnlock:0 },
  { name:'ğŸ³ç…è›‹', price:3, type:2, full:7, rare:0, levelUnlock:0 },
  { name:'ğŸ£å¯¿å¸æ‹¼ç›˜', price:18, type:2, full:22, mood:8, rare:1, levelUnlock:4 },
  { name:'ğŸ²å°ç«é”…', price:28, type:2, full:30, mood:12, health:-3, rare:2, levelUnlock:9 },
  { name:'ğŸ¥©ç‰›æ’å¥—é¤', price:48, type:2, full:35, mood:20, health:5, rare:2, levelUnlock:15 },
  { name:'ğŸ±æ»¡æ±‰å…¨å¸­', price:168, type:2, full:100, mood:50, health:10, rare:3, levelUnlock:30 },
  // æ—¥ç”¨å“ type3
  { name:'ğŸ§»çº¸å·¾', price:5, type:3, health:2, rare:0, levelUnlock:0 },
  { name:'ğŸ§´æ²æµ´éœ²', price:18, type:3, health:8, rare:0, levelUnlock:0 },
  { name:'ğŸ§¼é¦™çš‚', price:4, type:3, health:3, rare:0, levelUnlock:0 },
  { name:'ğŸª¥ç‰™åˆ·', price:6, type:3, health:4, rare:0, levelUnlock:0 },
  { name:'ğŸ§´æ´—å‘æ°´', price:16, type:3, health:9, rare:0, levelUnlock:0 },
  { name:'ğŸ§´æŠ¤å‘ç´ ', price:15, type:3, health:7, rare:0, levelUnlock:0 },
  { name:'ğŸ§½æµ·ç»µ', price:3, type:3, health:2, rare:0, levelUnlock:0 },
  { name:'ğŸ§¹æ‰«å¸š', price:8, type:3, health:5, rare:0, levelUnlock:0 },
  { name:'ğŸ§´æ¶¦è‚¤éœ²', price:12, type:3, health:6, rare:0, levelUnlock:0 },
  { name:'ğŸª£æ°´æ¡¶', price:10, type:3, health:4, rare:0, levelUnlock:0 },
  { name:'ğŸ§ªæŠ¤è‚¤å“å¥—è£…', price:45, type:3, health:15, love:10, rare:2, levelUnlock:10 },
  { name:'ğŸ›è±ªåæµ´ç¼¸', price:188, type:3, mood:40, health:25, rare:3, levelUnlock:22 },
  { name:'ğŸ§´ç²¾æ²¹', price:38, type:3, health:12, mood:8, rare:1, levelUnlock:5 },
  { name:'ğŸ§¼é¦™è–°', price:30, type:3, health:10, mood:10, rare:1, levelUnlock:4 },
  { name:'ğŸ§´èº«ä½“ä¹³', price:28, type:3, health:11, love:5, rare:1, levelUnlock:3 },
  { name:'ğŸ§´é˜²æ™’éœœ', price:25, type:3, health:9, rare:1, levelUnlock:2 },
  { name:'ğŸ§´é¢è†œ', price:22, type:3, health:8, mood:6, rare:1, levelUnlock:1 },
  { name:'ğŸ§´ç²¾åæ¶²', price:55, type:3, health:18, mood:12, rare:2, levelUnlock:12 }
];

let shopTab = 0;
function showTab(t) { shopTab = t; renderShop(); }
function renderShop() {
  let list = items.filter(i => i.type === shopTab).sort((a,b) => a.price - b.price);
  let html = '';
  list.forEach((it, idx) => {
    let locked = it.levelUnlock > level;
    let unlockText = locked ? `<div class="unlock-condition">ğŸ”’ ç­‰çº§ ${it.levelUnlock} è§£é”</div>` : '';
    html += `<div class="shop-item rare-${it.rare} ${locked?'locked':''}"><span class="rare-tag">${rareText[it.rare]}</span> <b>${it.name}</b><br><small>${it.mood?'ğŸ˜Š+'+it.mood:''} ${it.full?'ğŸš+'+it.full:''} ${it.health?'â¤ï¸+'+it.health:''} ${it.love?'ğŸ’–+'+it.love:''}</small>${unlockText}<div style="display:flex; justify-content:space-between; margin-top:6px"><span>ğŸ’° ${it.price}</span><button class="mini-btn" onclick="buyItem(${idx})" ${locked?'disabled':''}>è´­ä¹°</button></div></div>`;
  });
  $('shopBody').innerHTML = html;
}
function buyItem(idx) {
  let list = items.filter(i => i.type === shopTab).sort((a,b) => a.price - b.price);
  let it = list[idx];
  if (coin < it.price) { showLog('ğŸ’°ä¸å¤Ÿ'); return; }
  coin = Number((coin - it.price).toFixed(1));
  let exist = storage.find(s => s.name === it.name);
  if (exist) exist.count++;
  else storage.push({ ...it, count: 1 });
  showMessage(`è´­ä¹°æˆåŠŸï¼è·å¾— ${it.name}`);
  updateUI(); save(); renderShop();
}
function openShop() { renderShop(); openModal('shopModal'); }

// ä»“åº“ (å¼ºåŒ–é£å…¥æ•ˆæœ)
function openStorage() {
  if (!storage.length) $('storBody').innerHTML='<div class="empty-msg">ä»“åº“ç©ºç©º</div>';
  else {
    let html='';
    storage.forEach((it,i)=>{
      let effects=[]; if (it.mood) effects.push(`ğŸ˜Š+${it.mood}`); if (it.energy) effects.push(`âš¡+${it.energy}`); if (it.full) effects.push(`ğŸš+${it.full}`); if (it.health) effects.push(`â¤ï¸+${it.health}`); if (it.love) effects.push(`ğŸ’–+${it.love}`);
      let effectStr=effects.join(' ');
      let cost=10*Math.pow(2,boxReplaceCount);
      let replaceBtn = it.isBox ? `<button class="mini-btn" onclick="replaceBox(${i}, event)">ğŸ”„ æ›´æ¢ ${cost}ğŸ’°</button>` : '';
      html+=`<div class="item-row"><div class="item-info"><span><b>${it.name}</b> x${it.count}</span><span class="item-effects">${effectStr}</span></div><div class="item-actions">${replaceBtn}<button class="mini-btn" onclick="useItem(${i}, event)">ä½¿ç”¨</button></div></div>`;
    });
    $('storBody').innerHTML=html;
  }
  openModal('storModal');
}
function replaceBox(index, event) {
  let it = storage[index];
  if (!it || !it.isBox) return;
  let cost = 10 * Math.pow(2, boxReplaceCount);
  if (coin < cost) { showMessage(`ğŸ’° é‡‘å¸ä¸è¶³ï¼Œéœ€è¦${cost}é‡‘å¸`); return; }
  coin -= cost; boxReplaceCount++; localStorage.setItem('boxReplaceCount', boxReplaceCount);
  let possible = items.filter(item => item.rare <= 2 && item.price >= 5 && item.price <= 60);
  if (!possible.length) possible = items.filter(item => item.rare <= 2);
  let newItem = possible[Math.floor(Math.random() * possible.length)];
  it.count--;
  if (it.count <= 0) storage.splice(index, 1);
  let exist = storage.find(s => s.name === newItem.name && s.isBox);
  if (exist) exist.count++; else storage.push({ ...newItem, count: 1, isBox: true });
  showMessage(`ğŸ”„ æ›´æ¢ç›²ç›’èŠ±è´¹${cost}é‡‘å¸ï¼Œè·å¾—${newItem.name}`);
  updateUI(); save(); closeModal('storModal'); openStorage();
}
function useItem(i, event) {
  let it = storage[i]; if (!it) return;
  let icon = [...it.name][0];
  let x = event.clientX; let y = event.clientY;
  let fly = document.createElement('div'); fly.className = 'fly-item'; fly.innerText = icon; fly.style.left = x + 'px'; fly.style.top = y + 'px'; document.body.appendChild(fly);
  let avatarRect = $('avatarContainer').getBoundingClientRect();
  let avatarX = avatarRect.left + avatarRect.width/2; let avatarY = avatarRect.top + avatarRect.height/2;
  let dx = avatarX - x; let dy = avatarY - y;
  fly.style.setProperty('--fly-x', dx + 'px'); fly.style.setProperty('--fly-y', dy + 'px');
  setTimeout(() => {
    let boom = document.createElement('div');
    boom.className = 'impact-boom';
    boom.style.left = avatarX + 'px';
    boom.style.top = avatarY + 'px';
    document.body.appendChild(boom);
    setTimeout(() => boom.remove(), 400);
    playImpactSound();
  }, 700);
  setTimeout(() => { fly.remove(); }, 800);
  let changes = [];
  if (it.mood) { mood = cap(mood + it.mood, maxMood); changes.push(`ğŸ˜Š+${it.mood}`); }
  if (it.energy) { energy = cap(energy + it.energy, maxEnergy); changes.push(`âš¡+${it.energy}`); }
  if (it.full) { full = cap(full + it.full, maxFull); changes.push(`ğŸš+${it.full}`); }
  if (it.health) { health = cap(health + it.health, maxHealth); changes.push(`â¤ï¸+${it.health}`); }
  if (it.love) { love = cap(love + it.love, maxLove); changes.push(`ğŸ’–+${it.love}`); }
  it.count--; if (it.count <= 0) storage.splice(i,1);
  showLog(`ä½¿ç”¨ ${it.name}: ${changes.join(' ')}`);
  if (it.rare >= 2) showFullscreenEffect(it.rare);
  updateUI(); save(); closeModal('storModal');
}
function openEat() {
  let list = storage.filter(i => i.type===0 || i.type===2);
  if (!list.length) $('eatBody').innerHTML='<div class="empty-msg">æ²¡æœ‰å¯æŠ•å–‚çš„é£Ÿç‰©</div>';
  else {
    let html='';
    list.forEach((it, idx)=>{
      let effects=[]; if (it.mood) effects.push(`ğŸ˜Š+${it.mood}`); if (it.full) effects.push(`ğŸš+${it.full}`); if (it.health) effects.push(`â¤ï¸+${it.health}`);
      html+=`<div class="item-row"><div class="item-info"><span><b>${it.name}</b> x${it.count}</span><span class="item-effects">${effects.join(' ')}</span></div><button class="mini-btn" onclick="useEat(${idx}, event)">æŠ•å–‚</button></div>`;
    });
    $('eatBody').innerHTML=html;
  }
  openModal('eatModal');
}
function useEat(idx, event) {
  let list = storage.filter(i => i.type===0 || i.type===2);
  let realIdx = storage.findIndex(x => x.name === list[idx].name);
  if (realIdx !== -1) { useItem(realIdx, event); closeModal('eatModal'); }
}
function openPlay() {
  let list = storage.filter(i => i.type===1);
  if (!list.length) $('playBody').innerHTML='<div class="empty-msg">æ²¡æœ‰ç©å…·</div>';
  else {
    let html='';
    list.forEach((it, idx)=>{
      let effects=[]; if (it.mood) effects.push(`ğŸ˜Š+${it.mood}`); if (it.love) effects.push(`ğŸ’–+${it.love}`);
      html+=`<div class="item-row"><div class="item-info"><span><b>${it.name}</b> x${it.count}</span><span class="item-effects">${effects.join(' ')}</span></div><button class="mini-btn" onclick="usePlay(${idx}, event)">ç©è€</button></div>`;
    });
    $('playBody').innerHTML=html;
  }
  openModal('playModal');
}
function usePlay(idx, event) {
  let list = storage.filter(i => i.type===1);
  let realIdx = storage.findIndex(x => x.name === list[idx].name);
  if (realIdx !== -1) { useItem(realIdx, event); closeModal('playModal'); }
}

// ç­¾åˆ°ç³»ç»Ÿ (æ·»åŠ å¼¹çª—)
let signData = JSON.parse(localStorage.signData || '{"year":0,"month":0,"signed":[],"lucky":-1}');
function refreshSignData() {
  let now = new Date(), y=now.getFullYear(), m=now.getMonth();
  if (signData.year!==y || signData.month!==m) {
    let days = new Date(y, m+1, 0).getDate();
    signData = { year:y, month:m, signed:[], lucky:Math.floor(Math.random()*days)+1 };
    localStorage.signData = JSON.stringify(signData);
  }
}
function canSignToday() { return !signData.signed.includes(new Date().getDate()); }
function doSign() {
  if (!canSignToday()) { showLog('ä»Šå¤©å·²ç»ç­¾è¿‡å•¦'); openSignModal(); return; }
  let today = new Date().getDate();
  signData.signed.push(today);
  let goldReward = 5, expReward = 20;
  if (today === signData.lucky) { goldReward*=2; expReward*=2; }
  coin += goldReward; addExp(expReward);
  let commonItems = items.filter(i => i.rare===0 && i.price<10);
  if (commonItems.length) {
    let rand = commonItems[Math.floor(Math.random()*commonItems.length)];
    let exist = storage.find(s => s.name === rand.name);
    if (exist) exist.count++; else storage.push({ ...rand, count:1 });
    showMessage(`ç­¾åˆ°æˆåŠŸï¼è·å¾— ${goldReward}ğŸ’°, ${expReward}ç»éªŒ, ä»¥åŠ ${rand.name}`);
  } else showMessage(`ç­¾åˆ°æˆåŠŸï¼è·å¾— ${goldReward}ğŸ’°, ${expReward}ç»éªŒ`);
  let daysInMonth = new Date(signData.year, signData.month+1, 0).getDate();
  if (signData.signed.length === daysInMonth) {
    coin += 50; let epicItem = items.filter(i => i.rare===2)[0];
    if (epicItem) { let exist = storage.find(s => s.name === epicItem.name); if (exist) exist.count++; else storage.push({ ...epicItem, count:1 }); showMessage('ğŸ‰ æ»¡ç­¾å¥–åŠ± +50ğŸ’° + å²è¯—ç‰©å“ï¼'); }
  }
  localStorage.signData = JSON.stringify(signData);
  updateUI(); save(); openSignModal();
}
function openSignModal() {
  refreshSignData();
  let now = new Date(), year=signData.year, month=signData.month+1;
  let days = new Date(signData.year, signData.month+1, 0).getDate();
  let firstDay = new Date(signData.year, signData.month, 1).getDay();
  let html = `<div style="text-align:center; font-size:18px; margin-bottom:6px;">${year}å¹´${month}æœˆ</div><div style="text-align:center; margin:8px 0; background:#ffe9f4; border-radius:40px; padding:8px; font-size:14px;"><div>âœ¨ä»Šæ—¥ç­¾åˆ°å¥–åŠ±âœ¨</div><div>é‡‘å¸5, ç»éªŒ20, éšæœºæ™®é€šå•†å“</div>${signData.lucky===now.getDate()?'<div>ğŸ¯ä»Šæ—¥å¹¸è¿æ—¥åŒå€ï¼</div>':''}</div><div class="calendar">`+'æ—¥ä¸€äºŒä¸‰å››äº”å…­'.split('').map(d=>`<div style="font-weight:bold; font-size:14px;">${d}</div>`).join('');
  for (let i=0; i<firstDay; i++) html+='<div></div>';
  for (let d=1; d<=days; d++) {
    let cls = 'calendar-day';
    if (signData.signed.includes(d)) cls+=' signed';
    if (d===signData.lucky) cls+=' lucky';
    if (d===now.getDate()) cls+=' today';
    html+=`<div class="${cls}" onclick="if(${!signData.signed.includes(d)} && ${d}===${now.getDate()}) doSign()">${d}</div>`;
  }
  html+='</div><div style="margin-top:12px; text-align:center"><button class="mini-btn" onclick="doSign()">âœï¸ ä»Šæ—¥ç­¾åˆ°</button></div>';
  $('signBody').innerHTML = html;
  openModal('signModal');
}

// è‰²ç³»è®¾ç½®
function setColorTheme(main, second, themeName) {
  document.documentElement.style.setProperty('--main-color', main);
  document.documentElement.style.setProperty('--second-color', second);
  document.documentElement.style.setProperty('--main-light', main+'dd');
  document.documentElement.style.setProperty('--main-dark', main);
  let bodyBg, cardBg;
  if (themeName === 'æµªæ¼«ç²‰') { bodyBg='linear-gradient(165deg, #ffe9f4, #f0e6ff)'; cardBg='rgba(255, 250, 250, 0.95)'; }
  else if (themeName === 'æ¢¦å¹»ç´«') { bodyBg='linear-gradient(165deg, #e6d5ff, #d9b0ff)'; cardBg='rgba(245, 230, 255, 0.95)'; }
  else if (themeName === 'æ¸…æ–°ç»¿') { bodyBg='linear-gradient(165deg, #e0ffe0, #c0e8d5)'; cardBg='rgba(240, 255, 240, 0.95)'; }
  else if (themeName === 'æš–é˜³æ©™') { bodyBg='linear-gradient(165deg, #ffe0b5, #ffd2a0)'; cardBg='rgba(255, 245, 235, 0.95)'; }
  else if (themeName === 'æ·±é‚ƒé»‘') { bodyBg='linear-gradient(165deg, #2c3e50, #34495e)'; cardBg='rgba(30, 30, 40, 0.95)'; }
  else if (themeName === 'æµ·æ´‹è“') { bodyBg='linear-gradient(165deg, #3498db, #5dade2)'; cardBg='rgba(235, 245, 255, 0.95)'; }
  else { bodyBg='linear-gradient(165deg, #ffe9f4, #f0e6ff)'; cardBg='rgba(255, 250, 250, 0.95)'; }
  document.body.style.background = bodyBg;
  document.querySelector('.game-box').style.background = cardBg;
  localStorage.colorMain = main; localStorage.colorSecond = second; localStorage.colorTheme = themeName;
  closeModal('colorModal');
}
function openColorModal() { openModal('colorModal'); }

// ä¸»é¢˜åˆ‡æ¢
function toggleTheme() { document.body.classList.toggle('night'); localStorage.theme = document.body.classList.contains('night')?'night':'day'; }

// å­˜æ¡£/è¯»æ¡£
function save() { localStorage.data = JSON.stringify({ mood, energy, full, health, love, coin, level, exp, storage, boxReplaceCount, chatCD, restCD, cleanCD, lastDecay, savings, savingHistory, wheelData }); localStorage.startTime = startTime; }
function load() {
  let d = JSON.parse(localStorage.data || '{}');
  mood = d.mood ?? 50; energy = d.energy ?? 50; full = d.full ?? 50; health = d.health ?? 50; love = d.love ?? 50;
  coin = d.coin ?? 20; level = d.level ?? 1; exp = d.exp ?? 0; storage = d.storage ?? [];
  boxReplaceCount = d.boxReplaceCount ?? 0; chatCD = d.chatCD ?? 0; restCD = d.restCD ?? 0; cleanCD = d.cleanCD ?? 0; lastDecay = d.lastDecay ?? Date.now();
  savings = d.savings ?? []; savingHistory = d.savingHistory ?? []; wheelData = d.wheelData ?? {lastSpinDate:'',spinsLeft:1,luckyNumber:7,luckyColor:'#ff85c0',luckyStar:5,quote:''};
  if (localStorage.avatar) $('avatarImg').src = localStorage.avatar;
  if (localStorage.theme === 'night') document.body.classList.add('night');
  if (localStorage.colorMain) {
    document.documentElement.style.setProperty('--main-color', localStorage.colorMain);
    document.documentElement.style.setProperty('--second-color', localStorage.colorSecond || '#a975ff');
    document.documentElement.style.setProperty('--main-light', localStorage.colorMain + 'dd');
  }
  currentEffect = localStorage.getItem('currentEffect') || '';
  if (currentEffect) document.body.classList.add(`effect-${currentEffect}`);
  avatarHistory = JSON.parse(localStorage.avatarHistory || '[]');
  saveHistory = JSON.parse(localStorage.getItem('saveHistory') || '[]');
  updateMax(); updateUI(); updateSavingCount();
  if (chatCD > Date.now()) startCDTimer('chatBtn', chatCD, 'ğŸ’¬ èŠå¤©');
  if (restCD > Date.now()) startCDTimer('restBtn', restCD, 'ğŸ˜´ ä¼‘æ¯');
  if (cleanCD > Date.now()) startCDTimer('cleanBtn', cleanCD, 'ğŸ§¹ æ¸…æ´');
  showLog('âœ¨ èµ«èˆé†’æ¥å•¦ âœ¨');
}
window.onload = () => { load(); setInterval(updatePlayTime,1000); updateMusicUI(); };
</script>
</body>
</html>